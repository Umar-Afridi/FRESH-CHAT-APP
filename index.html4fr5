
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content">
    
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">

    <title>YARAAN</title> 
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700;800&family=Roboto:wght:400;500;700&display=swap');
        
        :root {
            --app-bg: #ffffff; 
            --active-text: #000000; 
            --inactive-text: #9ca3af; 
            --seat-size: 68px;
            --bottom-bar-height: 45px; 
        }

        html, body { margin: 0; padding: 0; height: 100%; width: 100%; background-color: var(--app-bg) !important; -webkit-tap-highlight-color: transparent; overscroll-behavior: none; }
        body { font-family: 'Montserrat', sans-serif; color: #1f2937; overflow: hidden; display: flex; flex-direction: column; padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); }
        #app-container { flex: 1; display: flex; flex-direction: column; position: relative; background-color: var(--app-bg); height: 100%; overflow: hidden; }
        
        /* HEADER */
        #app-header { background-color: var(--app-bg) !important; border: none !important; padding-top: 15px; padding-bottom: 5px; display: none; flex-direction: row; align-items: center; justify-content: space-between; padding-left: 15px; padding-right: 15px; z-index: 50; white-space: nowrap; height: 50px; flex-shrink: 0; }
        .tabs-wrapper { display: flex; align-items: baseline; gap: 15px; }
        .home-tab { font-family: 'Montserrat', sans-serif; background: none; border: none; cursor: pointer; padding: 0; margin: 0; transition: all 0.2s ease; font-size: 14px; font-weight: 500; color: var(--inactive-text); }
        .home-tab.active { font-size: 19px; font-weight: 800; color: var(--active-text); border-bottom: 2px solid #000; padding-bottom: 2px; } 
        .header-icons { display: flex; align-items: center; gap: 12px; flex-shrink: 0; }
        .icon-btn { font-size: 20px; display: flex; align-items: center; justify-content: center; }

        /* CAROUSEL CSS */
        .modern-carousel { position: relative; width: 100%; height: 150px; overflow: hidden; border-radius: 12px; background: #f0f0f0; margin-top: 5px; touch-action: pan-y; }
        .carousel-track { display: flex; height: 100%; transition: transform 0.5s ease-in-out; width: 100%; }
        .carousel-slide { min-width: 100%; height: 100%; position: relative; }
        .carousel-img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .carousel-dots { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 6px; z-index: 10; }
        .dot { width: 6px; height: 6px; background-color: rgba(255, 255, 255, 0.5); border-radius: 50%; transition: all 0.3s ease; }
        .dot.active { width: 16px; border-radius: 10px; background-color: #ffffff; }

        /* 3 ICON MENU CSS */
        .mid-menu-container { display: flex; justify-content: space-between; padding: 5px 15px 15px 15px; gap: 10px; }
        .mid-menu-item { flex: 1; height: 70px; border-radius: 10px; overflow: hidden; background: #fafafa; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; transition: transform 0.1s; }
        .mid-menu-item:active { transform: scale(0.95); }
        .mid-menu-img { width: 100%; height: 100%; object-fit: fill; }

        /* GRID ROOM LAYOUT CSS */
        #home-room-list { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; row-gap: 25px; padding: 0 15px 80px 15px; }
        .room-card-wrapper { display: flex; flex-direction: column; gap: 6px; }
        .room-card-new { position: relative; aspect-ratio: 1 / 1.1; border-radius: 12px; overflow: hidden; background-color: #f3f4f6; box-shadow: 0 2px 8px rgba(0,0,0,0.1); width: 100%; }
        .room-card-cover { width: 100%; height: 100%; object-fit: cover; }
        .room-card-overlay { position: absolute; bottom: 0; left: 0; width: 100%; background: linear-gradient(to top, rgba(0,0,0,0.7), transparent); padding: 8px; display: flex; align-items: flex-end; justify-content: center; }
        .room-live-tag { position: absolute; top: 8px; left: 8px; background: rgba(0,0,0,0.6); border: 1px solid #22c55e; color: #22c55e; font-size: 9px; padding: 2px 6px; border-radius: 4px; font-weight: bold; display: flex; align-items: center; gap: 4px; z-index: 20;}
        
        .room-target-tag { position: absolute; top: 32px; left: 8px; background: rgba(0,0,0,0.7); border: 1px solid #eab308; color: #eab308; font-size: 8px; padding: 2px 6px; border-radius: 10px; font-weight: bold; display: flex; align-items: center; gap: 3px; z-index: 20;}
        .room-target-tag img { width: 10px; height: 10px; object-fit: contain; }

        .room-user-badge { position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.6); color: white; font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: bold; display: flex; align-items: center; gap: 4px; cursor: pointer; z-index: 20; }
        .room-card-title { color: white; font-size: 14px; font-weight: 800; text-shadow: 0 1px 3px rgba(0,0,0,0.8); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: center; }
        .room-info-bottom { display: flex; align-items: center; gap: 6px; padding-left: 2px; }
        .room-gender-icon { width: 16px; height: 16px; object-fit: contain; }
        .room-owner-name { font-size: 12px; font-weight: 600; color: #374151; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* GENERAL STYLES */
        .visual-root { position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; overflow: visible !important; }
        .visual-img { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 78%; height: 78%; border-radius: 50%; object-fit: cover; z-index: 10; }
        .visual-frame { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 270% !important; height: 270% !important; object-fit: contain; z-index: 20; pointer-events: none; filter: drop-shadow(0 5px 10px rgba(0,0,0,0.8)); }
        .profile-page-visual { width: 90px; height: 90px; position: relative; display: flex; align-items: center; justify-content: center; overflow: visible !important; flex-shrink: 0; }
        .frame-preview-box { width: 80px; height: 80px; position: relative; margin: 15px 0; display: flex; align-items: center; justify-content: center; overflow: visible !important; }

        .view-section { flex: 1; overflow-y: auto; padding-bottom: 80px; display: none; flex-direction: column; position: relative; width: 100%; height: 100%; }
        .view-active { display: flex !important; animation: fadeIn 0.2s ease; }
        .light-bg { background-color: var(--app-bg) !important; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* MAIN BOTTOM NAV */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--app-bg) !important; border: none !important; display: flex; justify-content: space-around; align-items: center; z-index: 50; padding-bottom: max(5px, env(safe-area-inset-bottom)); height: calc(60px + env(safe-area-inset-bottom)); box-shadow: none !important; }
        .nav-item { display: flex; flex-direction: column; align-items: center; font-size: 10px; color: #9ca3af; transition: 0.3s; flex: 1; padding: 10px 0; }
        .nav-item i { font-size: 22px; margin-bottom: 3px; }
        .nav-item.active { color: #dc2626; font-weight: bold; }

        /* ROOM VIEW */
        #view-room { display: none; flex-direction: column; height: 100dvh; width: 100%; padding-bottom: 0 !important; background: #000 !important; position: fixed; inset: 0; z-index: 60; padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); overflow: hidden; }
        #room-top-content { flex-shrink: 0; }
        .cinema-frame { position: relative; width: 96%; margin: 5px auto; aspect-ratio: 16/9; background: #000000; overflow: hidden; z-index: 10; border-radius: 20px; border: 1px solid #222; box-shadow: 0 5px 20px rgba(0,0,0,0.5); flex-shrink: 0; }
        #video-controls-wrapper { transition: all 0.4s ease-in-out; max-height: 200px; opacity: 1; overflow: hidden; margin-bottom: 5px; flex-shrink: 0; }
        
        #room-lower-half { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; background-size: cover; background-position: center; background-repeat: no-repeat; margin-top: 5px; min-height: 0; }
        #theme-video-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 0; pointer-events: none; }

        /* MICS AREA */
        #mics-scroll-area { flex-shrink: 0; overflow: visible; padding-top: 10px; background: transparent !important; z-index: 10; position: relative; height: auto; }
        .mics-container-main { display: flex; flex-direction: column; align-items: center; justify-content: flex-start; gap: 5px; padding-top: 15px; padding-bottom: 5px; width: 100%; }
        .seat-base { position: relative; display: flex; align-items: center; justify-content: center; background: transparent; border-radius: 50%; overflow: visible !important; }
        .mic-container-lg { width: 70px; height: 70px; }
        .mic-container-sm { width: 55px; height: 55px; }
        .chair-bg-img { position: absolute; width: 65%; height: 65%; object-fit: contain; opacity: 1; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.6)); z-index: 5; pointer-events: none; }
        .user-dp-visual { position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; z-index: 20; border-radius: 50%; }
        .top-mic-row { display: flex; justify-content: center; align-items: center; gap: 2px; margin-bottom: 10px; }
        .bottom-mic-row { display: flex; gap: 12px; justify-content: center; align-items: flex-start; flex-wrap: wrap; }
        .mic-wrapper { position: relative; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; }
        .has-frame .user-dp-visual { background: transparent; }
        .seat-mute-badge { position: absolute; bottom: 0; right: 0; width: 20px; height: 20px; background: rgba(0,0,0,0.7); border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 1px solid #ef4444; z-index: 30; }
        .seat-mute-badge i { font-size: 10px; color: #ef4444; }

        .action-menu-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; flex-direction: column; align-items: center; justify-content: center; background: rgba(0,0,0,0.8); border-radius: 50%; z-index: 150; gap: 3px; }
        .btn-action { font-size: 10px; font-weight: bold; padding: 3px 8px; border-radius: 4px; color: white; cursor: pointer; text-transform: uppercase; width: 90%; text-align: center; }
        .btn-green { background: #22c55e; } .btn-red { background: #ef4444; } .btn-yellow { background: #eab308; color: black; } .btn-blue { background: #3b82f6; }
        
        /* CHAT AREA */
        #chat-display-area { flex: 1; width: 100%; overflow-y: auto; -webkit-overflow-scrolling: touch; overscroll-behavior-y: contain; padding: 10px 15px; z-index: 20; display: flex; flex-direction: column; justify-content: flex-end; position: relative; background: transparent !important; color: white !important; text-shadow: 0 1px 2px black; padding-bottom: 10px; margin-bottom: 0; mask-image: linear-gradient(to bottom, transparent 0%, black 15%); -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 15%); }
        .chat-message-bubble { background: rgba(20, 20, 20, 0.7); backdrop-filter: blur(3px); padding: 6px 12px; border-radius: 15px; margin-bottom: 6px; border: 1px solid rgba(255, 255, 255, 0.15); color: white !important; font-size: 12px; max-width: 85%; width: fit-content; word-wrap: break-word; animation: slideInUp 0.2s ease-out; text-shadow: 0 1px 1px black; flex-shrink: 0; }
        .chat-message-bubble b { color: #facc15; margin-right: 5px; }
        .chat-system-msg { align-self: center; background: rgba(255, 255, 255, 0.2); color: #eee; font-size: 10px; font-style: italic; padding: 4px 10px; border-radius: 20px; margin: 5px 0; text-align: center; border: none; width: auto; max-width: 90%; flex-shrink: 0; text-shadow: 0 1px 2px black; }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* ROOM BOTTOM BAR */
        #room-bottom-bar { position: relative; flex-shrink: 0; width: 100%; height: var(--bottom-bar-height); padding: 0 25px; padding-bottom: max(2px, env(safe-area-inset-bottom)); background: transparent !important; border-top: none; display: flex; align-items: center; justify-content: space-between; z-index: 100; background: linear-gradient(to top, rgba(0,0,0,0.95), transparent); }
        .room-icon-btn { font-size: 16px; color: #ffffff; cursor: pointer; transition: 0.2s; text-shadow: 0 2px 4px rgba(0,0,0,0.8); }
        #room-chat-input-layer { display: none; position: fixed; bottom: 0; left: 0; width: 100%; background: #111; padding: 10px 15px; z-index: 1000; align-items: center; gap: 10px; border-top: 1px solid #333; padding-bottom: max(10px, env(safe-area-inset-bottom)); }

        #search-overlay { position: absolute; top: 70px; left: 0; width: 100%; background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px); z-index: 40; padding: 20px; transform: translateY(-150%); transition: transform 0.3s ease-out; border-bottom: 1px solid #ccc; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        #search-overlay.open { transform: translateY(0); }
        #edit-modal, #prophouse-modal, #create-room-view, #room-settings-modal, #friend-profile-modal, #room-users-modal, #theme-modal, #leaderboard-modal { position: fixed; inset: 0; z-index: 2000; background: rgba(0,0,0,0.95); backdrop-filter: blur(5px); display: none; flex-direction: column; }
        #edit-modal, #room-settings-modal, #friend-profile-modal, #room-users-modal, #theme-modal, #leaderboard-modal { align-items: center; justify-content: center; background: rgba(0,0,0,0.85); }
        #edit-modal.open, #prophouse-modal.open, #create-room-view.open, #room-settings-modal.open, #friend-profile-modal.open, #room-users-modal.open, #theme-modal.open { display: flex; }
        .frame-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; overflow-y: auto; padding-bottom: 50px; }
        .frame-card { background: #080808; border: 1px solid #222; border-radius: 12px; padding: 15px; display: flex; flex-direction: column; align-items: center; position: relative; transition: transform 0.2s; }
        
        .chat-bubble-me { background: #dc2626; color: white; align-self: flex-end; border-radius: 12px 12px 0 12px; } 
        .chat-bubble-friend { background: #333; color: white; align-self: flex-start; border-radius: 12px 12px 12px 0; }
        
        #guest-touch-blocker { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: transparent; z-index: 500; display: none; cursor: pointer; }
        #pull-refresh-indicator { height: 0; overflow: hidden; display: flex; align-items: center; justify-content: center; background: transparent; color: #dc2626; font-size: 20px; transition: height 0.2s; }
        #room-exit-bar { position: absolute; top: 0; left: 0; width: 100%; height: 100px; background: rgba(0,0,0,0.9); backdrop-filter: blur(8px); display: none; justify-content: space-between; align-items: center; padding: 0 30px; z-index: 2000; border-bottom: 1px solid rgba(255,255,255,0.1); padding-top: env(safe-area-inset-top); }
        #room-exit-blocker { position: absolute; top: 100px; left: 0; width: 100%; height: calc(100% - 100px); background: rgba(0,0,0,0.5); z-index: 1900; display: none; }
        .exit-icon-btn { background: none; border: none; cursor: pointer; padding: 5px; display: flex; align-items: center; justify-content: center; pointer-events: auto; }
        .icon-img { width: 75px; height: 75px; object-fit: contain; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.8)); transition: transform 0.2s; }
        .exit-icon-btn:active .icon-img { transform: scale(0.9); }
        
        .heartbeat-wrapper { width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; position: relative; margin-bottom: 20px; overflow: visible !important; opacity: 0; transition: opacity 0.5s ease; z-index: 5; margin-left: 2px; margin-right: 2px; }
        .heartbeat-active { opacity: 1; }
        .hb-img { width: 35px; height: 35px; object-fit: contain; z-index: 10; filter: drop-shadow(0 0 15px rgba(220, 38, 38, 0.9)); }
        .heartbeat-active .hb-img { animation: lovelyHeartBeat 1.2s infinite ease-in-out; }
        @keyframes lovelyHeartBeat { 0% { transform: scale(1); } 15% { transform: scale(1.3); } 30% { transform: scale(1); } 45% { transform: scale(1.15); } 60% { transform: scale(1); } 100% { transform: scale(1); } }
        .line-img { position: absolute; top: 50%; transform: translateY(-50%); height: 30px; width: 50px; object-fit: contain; z-index: 1; pointer-events: none; }
        .left-line { right: 25px; } .right-line { left: 25px; }
        
        #empty-state-trigger { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 40; width: 100%; height: 100%; pointer-events: none; }
        .empty-icon { font-size: 50px; color: rgba(255, 255, 255, 0.3); margin-bottom: 10px; }
        .empty-text { color: rgba(255, 255, 255, 0.3); font-size: 14px; font-weight: 500; }
        #auth-bg-video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: -1; }
        .auth-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.3); z-index: 0; }
        #auth-content-wrapper { z-index: 10; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; padding: 30px; padding-bottom: 60px; }
        .auth-logo-container { position: absolute; top: 15%; left: 50%; transform: translateX(-50%); display: flex; flex-direction: column; align-items: center; text-align: center; }
        .auth-logo-png { width: 70px; height: 70px; object-fit: contain; filter: drop-shadow(0 0 10px rgba(0,0,0,0.5)); margin-bottom: 20px; border-radius: 15px; border: 2px solid white; }
        .auth-buttons-group { width: 100%; max-width: 320px; display: flex; flex-direction: column; align-items: center; }
        .google-sign-btn { width: 100%; max-width: 320px; background: white; color: #333; font-family: 'Roboto', sans-serif; font-weight: 500; display: flex; align-items: center; justify-content: center; position: relative; padding: 12px; border-radius: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); margin-bottom: 10px; transition: transform 0.2s; cursor: pointer; }
        .google-sign-btn:active { transform: scale(0.98); }
        .google-icon-svg { position: absolute; left: 15px; width: 24px; height: 24px; }
        .email-login-trigger { width: 50px; height: 50px; border-radius: 50%; background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; cursor: pointer; border: 1px solid rgba(255,255,255,0.3); transition: background 0.2s; margin-top: 10px; }
        .email-login-trigger:hover { background: rgba(255,255,255,0.3); }
        .yaarann-text-design { font-size: 14px; font-weight: bold; color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.5); margin-top: 10px; }
        #email-auth-full-page { position: fixed; inset: 0; z-index: 50; display: none; flex-direction: column; align-items: center; justify-content: center; background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); transition: opacity 0.3s ease-in-out; opacity: 0; padding: 20px; padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); }
        #email-auth-full-page.open { display: flex; opacity: 1; }
        .email-form-box { width: 100%; max-width: 400px; background: rgba(255, 255, 255, 0.9); border: 1px solid rgba(200, 200, 200, 0.5); border-radius: 16px; padding: 30px 20px; box-shadow: 0 8px 30px rgba(0,0,0,0.2); }
        #auth-email-form-container input { background: #f1f1f1; border: 1px solid #ccc; color: #333; }
        .menu-list-container { background: white; margin-top: 10px; padding-bottom: 20px; }
        .menu-item { display: flex; align-items: center; justify-content: space-between; padding: 15px 20px; background: white; cursor: pointer; transition: background 0.2s; }
        .menu-item:active { background: #f9fafb; }
        .menu-icon-box { width: 24px; text-align: center; margin-right: 12px; }
        .menu-text { flex: 1; font-size: 14px; color: #374151; font-weight: 500; }
        .menu-arrow { color: #d1d5db; font-size: 12px; }
        @keyframes pulse-ring { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); } 100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); } }

        /* GENDER SELECTOR STYLES */
        .gender-options { display: flex; gap: 20px; justify-content: center; margin-top: 10px; margin-bottom: 10px; }
        .gender-option { display: flex; flex-direction: column; align-items: center; gap: 5px; cursor: pointer; opacity: 0.5; transition: all 0.2s; }
        .gender-option.selected { opacity: 1; transform: scale(1.1); }
        .gender-img { width: 40px; height: 40px; object-fit: contain; }
        .locked-gender { filter: grayscale(1); cursor: not-allowed; }

        /* CREATE ROOM FULL SCREEN */
        #create-room-view { background: #000; color: white; display: none; align-items: center; justify-content: center; padding: 30px; }
        .cr-cover-preview { width: 120px; height: 120px; border-radius: 50%; border: 3px solid #dc2626; object-fit: cover; margin-bottom: 30px; background: #222; }
        .cr-input { background: #222; border: 1px solid #333; color: white; padding: 12px; width: 100%; border-radius: 8px; margin-bottom: 15px; outline: none; text-align: center; }
        .cr-input:focus { border-color: #dc2626; }
        .cr-btn { background: #dc2626; width: 100%; padding: 15px; border-radius: 30px; font-weight: bold; font-size: 16px; margin-top: 20px; box-shadow: 0 0 15px rgba(220, 38, 38, 0.5); }
/* --- VIP NAME COLORS & ANIMATIONS --- */
.name-vip-green { color: #22c55e !important; text-shadow: 0 0 5px rgba(34,197,94,0.6) !important; font-weight: 900 !important; }
.name-vip-yellow { color: #facc15 !important; text-shadow: 0 0 5px rgba(250,204,21,0.6) !important; font-weight: 900 !important; }
.name-vip-pink { color: #ec4899 !important; text-shadow: 0 0 5px rgba(236,72,153,0.6) !important; font-weight: 900 !important; }

/* ===== VIP COLORFUL NAME - WORKING VERSION ===== */
.name-vip-colorful,
.seat-name.occupied.name-vip-colorful {
    background-image: linear-gradient(to right, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #8b00ff, #ff0000) !important;
    background-size: 200% 100% !important;
    color: transparent !important;
    -webkit-background-clip: text !important;
    background-clip: text !important;
    -webkit-text-fill-color: transparent !important;
    animation: shineVIPText 2s linear infinite !important;
    font-weight: 900 !important;
    text-shadow: none !important;
}

@keyframes shineVIPText {
    0% { background-position: 0% center; }
    100% { background-position: -200% center; }
}
/* --- ROOM ENTRY & CHAT LEVEL BADGE CSS --- */
/* نیا سلیک اینیمیشن */
@keyframes slideInLeft {
    from {
        opacity: 0;
        transform: translateX(-30px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}
.animate-slideInLeft {
    animation: slideInLeft 0.3s ease-out forwards;
}
/* پرانی کلاس کو ہٹانے کے لیے اسے کمینٹ کر دیا ہے */
/* .room-entry-box { ... } */
@keyframes pulse-heart {
    0%, 100% { transform: scale(1); opacity: 0.5; }
    50% { transform: scale(1.2); opacity: 1; }
}
        /* ================== HUGE ROCKET SYSTEM STYLES ================== */
        #rocket-trigger-btn { position: absolute; bottom: 70px; right: 15px; width: 50px; height: 50px; z-index: 50; cursor: pointer; animation: floatRocket 3s ease-in-out infinite; }
        .rocket-display-icon { width: 100%; height: 100%; object-fit: contain; filter: drop-shadow(0 0 8px rgba(255, 215, 0, 0.6)); }
        @keyframes floatRocket { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        
        #rocket-fly-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 3000; display: none; flex-direction: column; align-items: center; justify-content: flex-end; padding-bottom: 10%; }
        
        .flying-rocket { 
            width: 120vw; 
            max-width: 500px; 
            height: auto; 
            position: relative; 
            z-index: 3002; 
            filter: drop-shadow(0 20px 30px rgba(0,0,0,0.8));
        }
        
        .rocket-countdown { 
            font-size: 150px; 
            font-weight: 900; 
            color: #ffda44; 
            text-shadow: 0 8px 0 #b37700, 0 15px 30px rgba(0,0,0,0.9), 0 0 50px #ffea00; 
            position: absolute; 
            top: 25%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            z-index: 3005; 
            animation: popInNumber 1s infinite; 
        }
        
        @keyframes popInNumber { 
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; } 
            30% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; } 
            80% { transform: translate(-50%, -50%) scale(1); opacity: 1; } 
            100% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; } 
        }
        
        .rocket-aura {
            position: absolute;
            top: 55%; 
            left: 50%;
            transform: translate(-50%, -50%);
            width: 150vw; 
            height: 150vw;
            max-width: 600px; 
            max-height: 600px;
            border-radius: 50%;
            z-index: 3001; 
            opacity: 0;
            animation: pulse-aura 1s infinite alternate;
            pointer-events: none;
        }
        .aura-1 { background: radial-gradient(circle, rgba(34,197,94,0.7) 0%, transparent 70%); } 
        .aura-2 { background: radial-gradient(circle, rgba(59,130,246,0.7) 0%, transparent 70%); } 
        .aura-3 { background: radial-gradient(circle, rgba(16,185,129,0.7) 0%, transparent 70%); } 
        .aura-4 { background: radial-gradient(circle, rgba(250,204,21,0.7) 0%, transparent 70%); } 

        @keyframes pulse-aura {
            0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0.5; }
            100% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
        }

        .rocket-rumble { animation: rumble 0.1s infinite ease-in-out; }
        @keyframes rumble {
            0% { transform: translate(0, 0) rotate(0deg); }
            20% { transform: translate(-4px, 4px) rotate(-1deg); }
            40% { transform: translate(4px, -4px) rotate(1deg); }
            60% { transform: translate(-4px, -4px) rotate(-1deg); }
            80% { transform: translate(4px, 4px) rotate(1deg); }
            100% { transform: translate(0, 0) rotate(0deg); }
        }
        
        .rocket-launching { animation: bigLaunch 2.5s ease-in-out forwards; }
        @keyframes bigLaunch {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            15% { transform: translateY(30px) scale(0.95); opacity: 1; filter: drop-shadow(0 0 50px #ff0000); }
            100% { transform: translateY(-200vh) scale(1.2); opacity: 0; }
        }

        .sparkle-effect { position: absolute; width: 15px; height: 15px; background: #fff; border-radius: 50%; box-shadow: 0 0 20px #fff, 0 0 40px #ffea00; animation: sparkleAnim 1s ease-out forwards; z-index: 3006; }
        @keyframes sparkleAnim { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(3); opacity: 0; } }

        #rocket-details-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 100; align-items: center; justify-content: center; flex-direction: column; padding: 20px; }
        .rocket-modal-card { background: linear-gradient(180deg, #2e0249 0%, #5b0a91 100%); border: 2px solid #d946ef; border-radius: 24px; width: 95%; max-width: 400px; height: 80vh; display: flex; position: relative; padding: 10px; overflow: hidden; box-shadow: 0 0 30px rgba(168, 85, 247, 0.5); }
        .modal-left-col { width: 25%; display: flex; flex-direction: column; gap: 10px; align-items: center; padding-top: 20px; }
        .modal-level-btn { width: 50px; height: 50px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; color: white; cursor: pointer; position: relative; }
        .modal-level-btn.active { border-color: #facc15; background: rgba(250, 204, 21, 0.2); box-shadow: 0 0 10px rgba(250, 204, 21, 0.5); }
        .modal-center-col { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        .big-center-rocket { width: 150px; filter: drop-shadow(0 0 20px rgba(255,255,255,0.5)); }
        .modal-right-col { width: 15%; display: flex; justify-content: center; padding-top: 20px; padding-bottom: 20px; }
        .tube-container { width: 30px; height: 100%; background: rgba(255,255,255,0.1); border-radius: 20px; border: 2px solid rgba(255,255,255,0.3); position: relative; overflow: hidden; display: flex; flex-direction: column-reverse; }
        .tube-fill { width: 100%; background: linear-gradient(to top, #22c55e, #a3e635); transition: height 0.5s ease; }
        .tube-percent { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-90deg); color: white; font-weight: bold; font-size: 12px; text-shadow: 0 1px 2px black; }
        .rewards-panel { position: absolute; bottom: 20px; left: 0; width: 100%; padding: 0 20px; }
        .rewards-box { background: rgba(0,0,0,0.5); border: 1px solid #d946ef; border-radius: 12px; padding: 10px; display: flex; justify-content: space-around; align-items: center; }
        .reward-item { display: flex; flex-direction: column; align-items: center; color: #facc15; font-size: 10px; }
        .reward-img { width: 30px; height: 30px; object-fit: contain; margin-bottom: 5px; }

        /* Gift Targets Styling */
        .gift-targets-wrapper { display: flex; overflow-x: auto; gap: 10px; padding: 10px; border-bottom: 1px solid #444; background: rgba(0,0,0,0.3); margin-bottom: 10px; }
        .gift-target-avatar { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 2px solid transparent; cursor: pointer; transition: 0.2s; filter: opacity(0.5); }
        .gift-target-avatar.selected { border-color: #facc15; filter: opacity(1); transform: scale(1.1); box-shadow: 0 0 10px rgba(250, 204, 21, 0.5); }
        .gift-target-item { display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .gift-target-name { font-size: 9px; color: #ccc; max-width: 50px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Level Badge */
        .user-level-badge { display: inline-flex; items-center; gap: 3px; background: linear-gradient(90deg, #ff8c00, #ff0080); padding: 2px 8px; border-radius: 12px; color: white; font-size: 10px; font-weight: 900; box-shadow: 0 2px 5px rgba(0,0,0,0.3); border: 1px solid #ffda44; }
        .level-medal-img { width: 14px; height: 14px; object-fit: contain; }

        /* Gift Modal Styles */
        .gift-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; padding: 10px; }
        .gift-item { background: rgba(255,255,255,0.1); border-radius: 8px; padding: 5px; text-align: center; cursor: pointer; border: 1px solid transparent; }
        .gift-item:hover { border-color: #facc15; background: rgba(255,255,255,0.2); }
        .gift-img { width: 40px; height: 40px; object-fit: contain; margin: 0 auto; }
        .gift-price { font-size: 10px; color: #facc15; margin-top: 2px; display: block; }

        /* LUCKY FRUIT GAME STYLES */
    /* ہوبہو سکرین شاٹ جیسا گیم کنٹینر */
        #game-modal { background: rgba(0,0,0,0.6); display: none; align-items: flex-end; justify-content: center; z-index: 3000; position: fixed; inset: 0; padding-bottom: 0; }
        .game-container { width: 100%; max-width: 500px; height: auto; background: linear-gradient(to bottom, #3b0000, #1a0000); border-top: 4px solid #b8860b; border-top-left-radius: 20px; border-top-right-radius: 20px; position: relative; display: flex; flex-direction: column; margin: 0 auto; box-shadow: 0 -10px 30px rgba(0,0,0,0.9); }
        
        /* گیم کا ہیڈر اور راؤنڈ ٹیکسٹ */
        .game-header-top { display: flex; flex-direction: column; align-items: center; justify-content: center; padding-top: 10px; position: relative; }
        .game-title-img { height: 40px; object-fit: contain; margin-bottom: 2px; }
        .round-text-box { background: rgba(0,0,0,0.5); border-radius: 15px; padding: 2px 20px; font-size: 10px; color: #8b7355; border: 1px solid #331a00; margin-bottom: 8px; }

        /* فروٹ گرڈ (چھوٹے اور پرفیکٹ خانے) */
        .fruit-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; padding: 10px 15px; background: #260000; border-radius: 10px; margin: 0 10px; border: 2px solid #5c1e06; box-shadow: inset 0 0 10px rgba(0,0,0,0.8); }
        .fruit-item { height: 60px; background: linear-gradient(to bottom, #1a0000, #0d0000); border: 1px solid #ff4500; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; cursor: pointer; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .fruit-img { width: 35px; height: 35px; object-fit: contain; filter: drop-shadow(0 2px 3px rgba(0,0,0,0.8)); margin: auto; z-index: 2; transition: transform 0.2s; }
        .text-multiplier { font-size: 9px; color: #facc15; font-weight: 900; margin-bottom: 2px; z-index: 10; }
        .fruit-item.active { border: 2px solid #fff !important; box-shadow: 0 0 15px #fff, inset 0 0 10px #ffeb3b !important; background: radial-gradient(circle, #ff8c00 0%, #8b0000 100%) !important; transform: scale(1.05) !important; }
        
        /* سینٹر ٹائمر سکرین شاٹ کے مطابق */
        .center-timer { grid-column: 2 / span 2; grid-row: 2; height: 60px; background: #330000; border: 2px dotted #ff4500; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 32px; font-weight: 900; color: #ffeb3b; font-family: 'Courier New', monospace; box-shadow: inset 0 0 15px rgba(0,0,0,0.9); }

        /* بیٹ بٹنز (چپس) سکرین شاٹ کے مطابق (100, 1K, 10K, 50K) */
        .bet-controls { display: flex; justify-content: space-between; gap: 8px; padding: 12px 15px; width: 100%; }
        .chip-btn { flex: 1; height: 30px; background: linear-gradient(to bottom, #ffda44, #d97706); color: #3f0000; font-weight: 900; border-radius: 15px; font-size: 11px; border: 2px solid #fff; box-shadow: 0 4px 6px rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; cursor: pointer; transition: transform 0.1s; }
        .chip-btn.selected { border-color: #ff0000; box-shadow: 0 0 15px #ff4500; transform: scale(1.05); color: #fff; background: linear-gradient(to bottom, #ff4500, #8b0000); }

        /* بیلنس اور ٹوڈے وننگ */
        .game-footer { display: flex; justify-content: space-between; padding: 5px 20px; }
        .footer-box { display: flex; flex-direction: column; align-items: center; }
        .footer-label { font-size: 10px; color: #8b7355; font-weight: bold; margin-bottom: 2px; }
        .footer-value { font-size: 12px; color: #8b7355; font-weight: bold; display: flex; align-items: center; gap: 5px; }

        /* رزلٹ ہسٹری (نیچے والی پٹی) */
        .history-strip { display: flex; align-items: center; gap: 8px; padding: 8px 15px; background: #261300; border-top: 1px solid #331a00; overflow-x: auto; width: 100%; padding-bottom: max(8px, env(safe-area-inset-bottom)); }
        .history-label { font-size: 11px; color: #6b5335; font-weight: bold; }
        .history-item { position: relative; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .history-item img { width: 100%; height: 100%; object-fit: contain; filter: opacity(0.7); }
        .history-item.newest img { filter: opacity(1); transform: scale(1.2); }
        .new-tag { position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%); background: transparent; border: 1px solid #d97706; color: #d97706; font-size: 7px; padding: 0 4px; border-radius: 8px; font-weight: bold; }

        /* نیا رزلٹ پاپ اپ سکرین شاٹ کے مطابق */
        #new-result-popup { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); width: 85%; max-width: 320px; background: #e67e22; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.9); display: none; flex-direction: column; overflow: hidden; z-index: 5000; border: 2px solid #f39c12; }
        .popup-header-bar { display: flex; align-items: center; background: linear-gradient(to right, #f39c12, #f1c40f, #f39c12); padding: 10px; border-bottom: 2px dashed #fff; }
        .popup-header-bar img { width: 35px; height: 35px; object-fit: contain; margin-right: 10px; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.5)); }
        .popup-header-bar span { font-size: 12px; font-weight: bold; color: #fff; text-shadow: 0 1px 2px #000; flex: 1; text-align: center; }
        .popup-body { display: flex; align-items: center; justify-content: center; padding: 20px; background: #d35400; flex-direction: column; }
        .popup-icon-circle { width: 60px; height: 60px; border: 2px solid rgba(255,255,255,0.5); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; color: rgba(255,255,255,0.7); margin-bottom: 10px; }
        .popup-win-amount { font-size: 24px; font-weight: 900; color: #fff; text-shadow: 0 2px 4px #000; }
        
        /* Global Broadcast Fix */
        #global-winner-broadcast { z-index: 99999 !important; }
        .bet-overlay { position: absolute; bottom: 0; right: 0; background: rgba(0,0,0,0.8); color: white; font-size: 9px; font-weight: bold; padding: 2px 4px; border-radius: 4px; z-index: 10; }

        #game-result-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.9); z-index: 100; display: none; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(4px); transition: transform 0.3s ease-out; transform: scale(0); }

        /* ================== 2-SLOT BROADCAST SYSTEM ================== */
        /* 1. شروع میں بینر دائیں (Right) طرف چھپا رہے گا (बिना किसी एनीमेशन के ताकि वापस जाते हुए नजर ना आए) */
        .global-broadcast-slot { position: fixed; left: 2%; width: 96%; height: 60px; z-index: 99999; display: flex; align-items: center; pointer-events: none; transform: translateX(120vw); transition: none; }
        .slot-1 { top: 85px; } 
        .slot-2 { top: 155px; } 
        
        /* 2. بینر دائیں سے سکرین کے درمیان میں آئے گا */
        .bc-show { transform: translateX(0) !important; transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) !important; }
        
        /* 3. بینر درمیان سے بائیں (Left) طرف نکل جائے گا */
        .bc-hide { transform: translateX(-120vw) !important; transition: transform 0.5s ease-in !important; }

        /* WIN BANNER STYLE */
        .bc-wrapper { width: 100%; height: 100%; position: relative; display: flex; align-items: center; justify-content: space-between; }
        .bc-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: fill; z-index: -1; }
        .bc-user-col { display: flex; flex-direction: column; align-items: center; justify-content: center; min-width: 60px; margin-left: 15px; z-index: 2; }
        .bc-dp { width: 36px; height: 36px; border-radius: 50%; border: 2px solid #ffffff; object-fit: cover; box-shadow: 0 2px 5px rgba(0,0,0,0.8); }
        .bc-name { font-size: 11px; color: #ffffff; font-weight: 900; text-shadow: 1px 1px 0 #000, -1px -1px 0 #000; margin-top: 2px; max-width: 70px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: center; }
        .bc-coins-container { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); z-index: 2; }
        .bc-coins { font-size: 20px; font-weight: 900; color: #ffffff; text-shadow: 2px 2px 0 #000, 0 4px 10px rgba(0,0,0,0.8); animation: pulse-coin 1s infinite; }

        /* ROCKET BANNER STYLE */
        .rb-wrapper { width: 100%; height: 100%; position: relative; display: flex; align-items: center; justify-content: space-between; background: linear-gradient(90deg, rgba(15,23,42,0.95) 0%, rgba(88,28,135,0.95) 100%); border: 2px solid #a855f7; border-radius: 35px; box-shadow: 0 0 15px rgba(168,85,247,0.6); padding-right: 10px; pointer-events: auto;}
        .rb-png { width: 45px; height: 45px; object-fit: contain; filter: drop-shadow(0 2px 5px rgba(0,0,0,0.8)); margin-left: 10px; }
        .rb-center-col { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .rb-roomname { font-size: 13px; font-weight: 900; color: #ffffff; text-shadow: 1px 1px 0 #000; }
        .rb-go-btn { background: linear-gradient(to bottom, #ef4444, #991b1b); color: white; font-weight: 900; font-size: 11px; padding: 4px 12px; border-radius: 20px; border: 2px solid #facc15; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }

        /* NEW GIFT BANNER STYLE */
        .gb-wrapper { width: 100%; height: 100%; position: relative; display: flex; align-items: center; justify-content: space-between; background: linear-gradient(90deg, rgba(220,38,38,0.9) 0%, rgba(245,158,11,0.9) 100%); border: 2px solid #fcd34d; border-radius: 35px; box-shadow: 0 0 15px rgba(245,158,11,0.6); padding: 0 5px; }
        .gb-user { display: flex; flex-direction: column; align-items: center; width: 50px; }
        .gb-dp { width: 32px; height: 32px; border-radius: 50%; border: 2px solid #fff; object-fit: cover; }
        .gb-name { font-size: 9px; color: #fff; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 50px; text-shadow: 1px 1px 0 #000; }
        .gb-center { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .gb-action-text { font-size: 10px; color: #fff; font-weight: bold; font-style: italic; }
        .gb-gift-img { height: 35px; object-fit: contain; animation: bounce 1s infinite; }
        .gb-coins { font-size: 10px; color: #facc15; font-weight: 900; text-shadow: 1px 1px 0 #000; background: rgba(0,0,0,0.4); padding: 1px 6px; border-radius: 10px; margin-top: 2px; }
         /* SweetAlert Z-index Fix for Recharge Modal */
        .swal2-container {
    z-index: 99999 !important;
}
/* --- NEW LEADERBOARD & HOME TOP 3 CSS --- */
/* --- NEW LEADERBOARD & HOME TOP 3 CSS (ANIMATED) --- */
.home-top3-container { position: absolute; bottom: 5px; left: 50%; transform: translateX(-50%); display: flex; align-items: flex-end; justify-content: center; width: 100%; pointer-events: none; z-index: 5; }
.home-top-dp { border-radius: 50%; object-fit: cover; box-shadow: 0 3px 6px rgba(0,0,0,0.9); background: #222; border: 1.5px solid #fff; }
.dp-rank-2 { width: 22px; height: 22px; border-color: #c0c0c0; z-index: 2; margin-right: -8px; margin-bottom: 2px; }
.dp-rank-1 { width: 30px; height: 30px; border-color: #facc15; z-index: 3; animation: popBounce 3s infinite ease-in-out; }
.dp-rank-3 { width: 22px; height: 22px; border-color: #cd7f32; z-index: 1; margin-left: -8px; margin-bottom: 2px; }

@keyframes popBounce {
    0%, 30%, 100% { transform: translateY(0) scale(1); box-shadow: 0 2px 4px rgba(0,0,0,0.8); }
    15% { transform: translateY(-6px) scale(1.15); box-shadow: 0 8px 15px rgba(250, 204, 21, 0.9); }
}

/* ================= VIP ROYAL BLUE LEADERBOARD ================= */
#leaderboard-modal { background: linear-gradient(to bottom, #0a1930, #020813); display: none; flex-direction: column; z-index: 3000; position: fixed; inset: 0; font-family: 'Montserrat', sans-serif; overflow: hidden; }

.lb-m-tab { color: #888; font-size: 11px; font-weight: bold; padding: 6px 12px; border-radius: 18px; cursor: pointer; transition: 0.3s; }
.lb-m-tab.active { color: #fff; background: linear-gradient(to right, #d4af37, #aa7c11); box-shadow: 0 2px 10px rgba(212, 175, 55, 0.5); }

.lb-sub-tabs { display: flex; justify-content: center; gap: 30px; padding: 10px 15px; border-bottom: 1px solid rgba(255,255,255,0.1); }
.lb-s-tab { color: #888; font-size: 14px; font-weight: bold; cursor: pointer; transition: 0.3s; padding-bottom: 5px; border-bottom: 2px solid transparent; letter-spacing: 0.5px; }
.lb-s-tab.active { color: #fff; border-bottom: 2px solid #fff; }

/* بیک گراؤنڈ امیج کا لنک اپڈیٹ کر دیا گیا ہے */
.lb-stage-bg { background: url('./stage_bg.png') bottom center no-repeat; background-size: cover; padding: 30px 10px 20px 10px; display: flex; justify-content: center; align-items: flex-end; gap: 15px; min-height: 250px; }
.vip-podium-item { display: flex; flex-direction: column; align-items: center; position: relative; z-index: 10; }
.vip-podium-dp { border-radius: 50%; object-fit: cover; border: 3px solid; box-shadow: 0 5px 15px rgba(0,0,0,0.8); background: #111; }
.rank-1-dp { width: 80px; height: 80px; border-color: #facc15; z-index: 3; }
.rank-2-dp, .rank-3-dp { width: 60px; height: 60px; border-color: #c0c0c0; z-index: 2; margin-bottom: -15px; }
.rank-3-dp { border-color: #cd7f32; }

.vip-crown { position: absolute; top: -25px; width: 40px; object-fit: contain; filter: drop-shadow(0 2px 4px black); }
.vip-rank-badge { margin-top: -10px; width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 900; color: white; border: 2px solid #000; z-index: 5; }
.bg-gold { background: linear-gradient(to bottom, #fde047, #ca8a04); }
.bg-silver { background: linear-gradient(to bottom, #e2e8f0, #64748b); }
.bg-bronze { background: linear-gradient(to bottom, #fdba74, #b45309); }

.vip-list-item { display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.05); margin: 8px 15px; padding: 12px 15px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(5px); }

.lb-my-rank-bar { position: absolute; bottom: 0; left: 0; width: 100%; height: 70px; background: linear-gradient(to right, #0d47a1, #1565c0); border-top: 1px solid #4fc3f7; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; box-shadow: 0 -5px 20px rgba(0,0,0,0.5); z-index: 50; }

.lb-list-container { flex: 1; overflow-y: auto; padding: 10px 15px; padding-bottom: max(20px, env(safe-area-inset-bottom)); background: #111; }

/* --- NEW LEVEL SYSTEM MODAL CSS --- */
#level-system-modal {
    position: fixed; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(8px);
    z-index: 4000; display: none; flex-direction: column; align-items: center; justify-content: center;
}
.level-modal-content {
    background: linear-gradient(to bottom, #111827, #000000); border: 2px solid #374151;
    width: 90%; max-width: 400px; border-radius: 20px; padding: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.8);
    max-height: 85vh; display: flex; flex-direction: column;
}
.level-progress-box {
    background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
    border-radius: 15px; padding: 15px; text-align: center; margin-bottom: 15px;
}
.level-bar-bg { width: 100%; height: 10px; background: #333; border-radius: 5px; overflow: hidden; margin-top: 10px; }
.level-bar-fill { height: 100%; background: linear-gradient(90deg, #facc15, #ef4444); transition: width 0.5s ease; }
.reward-list-container { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; padding-right: 5px; }
.reward-item-box {
    background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
    border-radius: 12px; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center;
}
.reward-item-box.locked { opacity: 0.5; filter: grayscale(1); }
.reward-item-box.claimed { border-color: #22c55e; background: rgba(34,197,94,0.1); }
.claim-btn {
    background: linear-gradient(to bottom, #eab308, #ca8a04); color: white; font-size: 10px;
    font-weight: 900; padding: 5px 12px; border-radius: 20px; cursor: pointer; border: 1px solid #fef08a;
}
.claim-btn:disabled { background: #555; border-color: #444; color: #aaa; cursor: not-allowed; }
        /* --- OFFICIAL & SUPER ADMIN CSS --- */
        .v-badge-profile { width: 16px; height: 16px; object-fit: contain; margin-left: 5px; display: inline-block; vertical-align: middle; }
        .v-badge-mic { position: absolute; bottom: 0; left: 0; width: 14px; height: 14px; object-fit: contain; z-index: 35; filter: drop-shadow(0 1px 2px rgba(0,0,0,0.8)); }
        
        #admin-panel-modal { background: rgba(0,0,0,0.9); display: none; flex-direction: column; z-index: 4000; position: fixed; inset: 0; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .admin-box { background: #1f2937; width: 90%; max-width: 400px; border-radius: 16px; border: 2px solid #ef4444; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.8); }
        .admin-input { w-full; background: #111827; border: 1px solid #374151; color: white; padding: 10px; border-radius: 8px; outline: none; margin-bottom: 10px; text-align: center; }
        .admin-input:focus { border-color: #ef4444; }
        .admin-action-btn { font-size: 11px; font-weight: bold; padding: 8px; border-radius: 6px; color: white; text-align: center; cursor: pointer; transition: 0.2s; }
        .admin-action-btn:active { transform: scale(0.95); }

        /* --- CHAT HEADER DP & PROFILE MODAL CSS --- */
        .chat-header-dp-wrapper { position: relative; display: inline-block; flex-shrink: 0; }
        .chat-header-dp { width: 42px; height: 42px; border-radius: 50%; object-fit: cover; border: 2px solid #e5e7eb; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .chat-header-v-badge { position: absolute; bottom: -2px; right: -4px; width: 18px; height: 18px; background: white; border-radius: 50%; object-fit: contain; box-shadow: 0 1px 3px rgba(0,0,0,0.3); padding: 1px; }

        .fp-dp-wrapper { position: relative; display: inline-block; margin-bottom: 15px; }
        .fp-dp { width: 90px; height: 90px; border-radius: 50%; border: 3px solid #dc2626; object-fit: cover; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .fp-v-badge { position: absolute; bottom: 0; right: 0; width: 26px; height: 26px; background: white; border-radius: 50%; padding: 2px; box-shadow: 0 2px 5px rgba(0,0,0,0.4); z-index: 10; object-fit: contain; }
    </style>
</head>
<body>

    <audio id="rocket-sound" src="./rocket_sound.mp3" preload="auto"></audio>

    <!-- UNIFIED 2-SLOT BROADCAST SYSTEM -->
    <div id="broadcast-slot-1" class="global-broadcast-slot slot-1"></div>
    <div id="broadcast-slot-2" class="global-broadcast-slot slot-2"></div>
    
    <input type="file" id="image-upload" accept="image/*" style="display: none;">
    <input type="file" id="video-upload" accept="video/*" style="display: none;">
    
    <div id="app-container">
        
        <header id="app-header">
            <div id="header-home-content" class="w-full flex items-center justify-between">
                <div class="tabs-wrapper">
                    <button onclick="switchHomeTab('following')" id="tab-following" class="home-tab">Following</button>
                    <button onclick="switchHomeTab('popular')" id="tab-popular" class="home-tab active">Popular</button>
                    <button onclick="switchHomeTab('recent')" id="tab-recent" class="home-tab">Recent</button>
                </div>
                <div class="header-icons">
                    <button onclick="toggleSearch()" class="icon-btn text-gray-800"><i class="fa-solid fa-magnifying-glass"></i></button>
                    <button onclick="triggerCreateRoom()" class="icon-btn text-red-600"><i class="fa-solid fa-square-plus"></i></button>
                </div>
            </div>
            <div id="header-inbox-content" class="w-full hidden">
                <h1 class="text-3xl font-extrabold text-gray-900 tracking-tight">Messages</h1> 
            </div>
            <div id="header-profile-content" class="w-full hidden"></div>
        </header>

        <div id="floating-room-btn" style="position: fixed; bottom: 90px; right: 20px; width: 65px; height: 65px; border-radius: 50%; background: black; border: 2px solid #dc2626; z-index: 60; display: none; align-items: center; justify-content: center; animation: pulse-ring 2s infinite; cursor: grab; touch-action: none; overflow: hidden;">
            <img id="float-btn-img" src="" style="width: 100%; height: 100%; object-fit: cover;">
            <i class="fa-solid fa-music" style="position: absolute; font-size: 24px; color: white; filter: drop-shadow(0 2px 2px black); z-index: 10;"></i>
        </div>

        <div id="search-overlay">
            <div class="flex gap-2">
                <input type="number" id="search-input" placeholder="User ID" class="flex-1 bg-gray-50 border border-gray-300 rounded-full px-4 py-2 text-gray-900 focus:outline-none focus:border-red-600 appearance-none shadow-sm">
                <button onclick="searchUser()" class="bg-red-700 text-white px-4 rounded-full shadow"><i class="fa-solid fa-arrow-right"></i></button>
            </div>
            <div id="search-result" class="mt-4"></div>
            <button onclick="toggleSearch()" class="mt-4 text-xs text-gray-500 w-full text-center">Close Search</button>
        </div>

        <div id="create-room-view">
            <button onclick="closeCreateRoom()" class="absolute top-5 right-5 text-gray-400 text-2xl"><i class="fa-solid fa-xmark"></i></button>
            <h2 class="text-2xl font-bold mb-8 uppercase tracking-wider">Setup Room</h2>
            <img id="cr-preview" src="https://placehold.co/200x200?text=Cover" class="cr-cover-preview">
            <div class="w-full max-w-xs">
                <label class="text-xs text-gray-400 ml-2 uppercase">Room Name</label>
                <input type="text" id="cr-name" class="cr-input" placeholder="Enter Room Name">
                <label class="text-xs text-gray-400 ml-2 uppercase">Cover Image URL</label>
                <input type="text" id="cr-cover" class="cr-input" placeholder="Paste Image Link" oninput="document.getElementById('cr-preview').src = this.value || 'https://placehold.co/200x200?text=Cover'">
                <button onclick="finalizeCreateRoom()" class="cr-btn">GO LIVE</button>
            </div>
        </div>

        <div id="room-settings-modal">
            <div class="bg-white p-6 rounded-xl w-11/12 max-w-sm border border-gray-300 relative shadow-2xl">
                <button onclick="closeRoomSettings()" class="absolute top-3 right-3 text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button>
                <h3 class="text-gray-900 font-bold mb-4 text-center">Room Settings</h3>
                <div class="space-y-3">
                    <div><label class="text-xs text-gray-500">Room Name</label><input type="text" id="rs-name" class="w-full bg-gray-100 border border-gray-300 rounded p-2 text-gray-900 focus:border-red-600 outline-none" placeholder="Room Name"></div>
                    <div><label class="text-xs text-gray-500">Cover URL</label><input type="text" id="rs-cover" class="w-full bg-gray-100 border border-gray-300 rounded p-2 text-gray-900 focus:border-red-600 outline-none text-xs" placeholder="Image URL"></div>
                    <div class="flex items-center justify-between bg-gray-100 p-2 rounded border border-gray-200 mt-2">
                        <span class="text-sm font-bold text-gray-700">Lock Room (Private)</span>
                        <input type="checkbox" id="rs-lock" class="w-5 h-5 accent-red-600">
                    </div>
                    <div onclick="openThemeModal()" class="flex items-center justify-between bg-gray-800 text-white p-3 rounded cursor-pointer mt-2">
                        <span class="font-bold">Room Themes</span>
                        <i class="fa-solid fa-chevron-right"></i>
                    </div>
                </div>
                <button onclick="saveRoomSettings()" class="w-full bg-red-700 hover:bg-red-800 text-white font-bold py-3 rounded mt-6 shadow-md">SAVE SETTINGS</button>
            </div>
        </div>
        
        <div id="theme-modal">
            <div class="bg-zinc-900 p-6 rounded-xl w-11/12 max-w-sm border border-zinc-700 relative shadow-2xl overflow-y-auto max-h-[80vh]">
                <button onclick="closeThemeModal()" class="absolute top-3 right-3 text-gray-400"><i class="fa-solid fa-xmark text-xl"></i></button>
                <h3 class="text-white font-bold mb-4 text-center">Select Room Theme</h3>
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div class="bg-black border border-gray-700 p-2 rounded flex flex-col items-center">
                        <img src="./theme1.png" class="w-full h-20 object-cover rounded mb-2" onerror="this.src='https://placehold.co/100x100?text=Theme+1'">
                        <div class="flex gap-1 w-full"><button onclick="applyTheme('theme1.png')" class="bg-green-600 text-white text-[10px] px-2 py-1 rounded flex-1 font-bold">USE</button><button onclick="removeTheme()" class="bg-red-600 text-white text-[10px] px-2 py-1 rounded flex-1 font-bold">REMOVE</button></div>
                    </div>
                    <div class="bg-black border border-gray-700 p-2 rounded flex flex-col items-center">
                        <img src="./theme2.png" class="w-full h-20 object-cover rounded mb-2" onerror="this.src='https://placehold.co/100x100?text=Theme+2'">
                        <div class="flex gap-1 w-full"><button onclick="applyTheme('theme2.png')" class="bg-green-600 text-white text-[10px] px-2 py-1 rounded flex-1 font-bold">USE</button><button onclick="removeTheme()" class="bg-red-600 text-white text-[10px] px-2 py-1 rounded flex-1 font-bold">REMOVE</button></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="recharge-modal" class="hidden fixed inset-0 bg-black/90 z-[2500] flex-col items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-gray-900 w-full max-w-sm rounded-2xl border border-yellow-500 overflow-hidden shadow-2xl relative">
                <button onclick="closeRechargeModal()" class="absolute top-3 right-3 text-gray-900 hover:text-white bg-yellow-400 rounded-full w-6 h-6 flex items-center justify-center z-10"><i class="fa-solid fa-xmark text-sm"></i></button>
                
                <div class="bg-gradient-to-r from-yellow-600 to-yellow-400 p-4 text-center">
                    <h2 class="text-2xl font-black text-black tracking-wider">WALLET</h2>
                </div>

                <div class="p-4">
                    <div class="flex justify-around bg-gray-800 p-3 rounded-xl border border-gray-700 mb-4 shadow-inner">
                        <div class="text-center">
                            <div class="text-[10px] text-gray-400 font-bold uppercase">Live Coins</div>
                            <div class="text-yellow-400 font-black text-lg" id="wallet-balance-display">0</div>
                        </div>
                        <div class="w-px bg-gray-600"></div>
                        <div class="text-center">
                            <div class="text-[10px] text-gray-400 font-bold uppercase">Diamonds</div>
                            <div class="text-pink-400 font-black text-lg" id="wallet-diamonds-display">0</div>
                        </div>
                    </div>
                    
                    <button onclick="convertDiamonds()" class="w-full bg-pink-600 hover:bg-pink-700 text-white font-bold py-2 rounded-xl mb-4 shadow-lg text-sm transition active:scale-95">
                        EXCHANGE DIAMONDS TO COINS
                    </button>

                    <div class="space-y-3">
                        <div onclick="buyCoins(300, 300000)" class="flex justify-between items-center bg-gray-800 p-3 rounded-xl border border-gray-700 cursor-pointer hover:border-yellow-400 transition active:scale-95 shadow-md">
                            <div class="flex items-center gap-3">
                                <img src="./coins_small.png" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3135/3135673.png'" class="w-8 h-8 object-contain">
                                <div class="flex flex-col">
                                    <span class="text-white font-bold text-sm">300,000 Coins</span>
                                    <span class="text-[9px] text-gray-400">Basic Package</span>
                                </div>
                            </div>
                            <div class="bg-yellow-500 text-black font-black px-3 py-1 rounded-full text-xs shadow-sm">Rs. 300</div>
                        </div>
                        <div onclick="buyCoins(1400, 1000000)" class="flex justify-between items-center bg-gray-800 p-3 rounded-xl border border-gray-700 cursor-pointer hover:border-yellow-400 transition active:scale-95 shadow-md relative overflow-hidden">
                            <div class="absolute -left-4 top-2 bg-red-600 text-white text-[8px] font-bold px-4 py-0.5 rotate-[-45deg] z-0">HOT</div>
                            <div class="flex items-center gap-3 z-10 pl-2">
                                <img src="./coins_medium.png" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3135/3135673.png'" class="w-10 h-10 object-contain">
                                <div class="flex flex-col">
                                    <span class="text-yellow-400 font-black text-sm">1,000,000 Coins</span>
                                    <span class="text-[9px] text-gray-400">Popular Package</span>
                                </div>
                            </div>
                            <div class="bg-yellow-500 text-black font-black px-3 py-1 rounded-full text-xs shadow-sm z-10">Rs. 1400</div>
                        </div>
                        <div onclick="buyCoins(3000, 2000000)" class="flex justify-between items-center bg-gray-800 p-3 rounded-xl border border-gray-700 cursor-pointer hover:border-yellow-400 transition active:scale-95 shadow-md">
                            <div class="flex items-center gap-3">
                                <img src="./coins_large.png" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3135/3135673.png'" class="w-12 h-12 object-contain">
                                <div class="flex flex-col">
                                    <span class="text-white font-bold text-sm">2,000,000 Coins</span>
                                    <span class="text-[9px] text-gray-400">Mega Package</span>
                                </div>
                            </div>
                            <div class="bg-yellow-500 text-black font-black px-3 py-1 rounded-full text-xs shadow-sm">Rs. 3000</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- NEW VIP LEADERBOARD MODAL -->
        <div id="leaderboard-modal">
            <!-- Top Header -->
            <div class="lb-header flex justify-between items-center px-4 py-3">
                <button onclick="closeLeaderboard()" class="text-white text-xl"><i class="fa-solid fa-chevron-left"></i></button>
                <div class="lb-main-tabs flex gap-2 bg-black/40 p-1 rounded-full">
                    <span class="lb-m-tab active" onclick="switchMainTab(0)">Contribution</span>
                    <span class="lb-m-tab" onclick="switchMainTab(1)">Charm</span>
                    <span class="lb-m-tab" onclick="switchMainTab(2)">Room</span>
                </div>
                <button class="text-white text-xl"><i class="fa-regular fa-calendar-days"></i></button>
            </div>

            <!-- Sub Tabs (Daily, Weekly, Monthly) -->
            <div class="lb-sub-tabs">
                <span class="lb-s-tab active" onclick="switchSubTab('daily')">Daily</span>
                <span class="lb-s-tab" onclick="switchSubTab('weekly')">Weekly</span>
                <span class="lb-s-tab" onclick="switchSubTab('monthly')">Monthly</span>
            </div>

            <!-- Dynamic Content Area -->
            <div class="lb-content-area flex-1 overflow-y-auto pb-24" id="lb-content-area">
                <!-- Podium & List will be generated here by JS -->
            </div>

            <!-- Bottom Sticky Bar (My Rank) -->
            <div class="lb-my-rank-bar">
                <div class="text-white font-bold text-sm" id="my-rank-text">No ranking</div>
                <div class="flex items-center gap-2">
                    <img src="" id="my-rank-dp" class="w-10 h-10 rounded-full border-2 border-yellow-400 object-cover">
                    <span class="text-white font-bold text-sm" id="my-rank-name">User</span>
                </div>
                <div class="text-yellow-400 font-bold text-sm">🪙 <span id="my-rank-score">0</span></div>
            </div>
        </div>

        <div id="edit-modal">
            <div class="bg-white p-6 rounded-xl w-11/12 max-w-sm border border-gray-300 relative shadow-2xl">
                <button onclick="closeEditModal()" class="absolute top-3 right-3 text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button>
                <h3 class="text-gray-900 font-bold mb-4 text-center">Edit Profile</h3>
                <div class="flex flex-col items-center mb-2">
                    <div class="profile-page-container" style="width: 100px; height: 100px;">
                        <div id="edit-preview-visual" class="visual-root"></div>
                    </div>
                    <div class="flex gap-3 text-xs mt-2"><button onclick="triggerImageUpload()" class="text-blue-600 font-medium hover:underline">Upload File</button></div>
                </div>
                <div class="gender-options">
                    <div class="gender-option" id="opt-male" onclick="selectGender('male')"><img src="./male.png" class="gender-img" onerror="this.src='https://placehold.co/40?text=M'"><span class="text-[10px] font-bold text-gray-500">MALE</span></div>
                    <div class="gender-option" id="opt-female" onclick="selectGender('female')"><img src="./female.png" class="gender-img" onerror="this.src='https://placehold.co/40?text=F'"><span class="text-[10px] font-bold text-gray-500">FEMALE</span></div>
                </div>
                <p id="gender-lock-msg" class="text-[9px] text-red-500 text-center mb-3 hidden">Gender change locked for 7 days.</p>
                <div class="space-y-3">
                    <div><input type="text" id="edit-name" class="w-full bg-gray-100 border border-gray-300 rounded p-2 text-gray-900 focus:border-red-600 outline-none" placeholder="Display Name"></div>
                    <div><input type="text" id="edit-img-url" class="w-full bg-gray-100 border border-gray-300 rounded p-2 text-gray-900 focus:border-red-600 outline-none text-xs" placeholder="Image URL (Optional)"></div>
                    <div><input type="text" id="edit-email" disabled class="w-full bg-gray-200 border border-gray-300 rounded p-2 text-gray-600 outline-none text-xs cursor-not-allowed" placeholder="Registered Email"></div>
                    <div><textarea id="edit-bio" rows="2" class="w-full bg-gray-100 border border-gray-300 rounded p-2 text-gray-900 focus:border-red-600 outline-none" placeholder="Bio"></textarea></div>
                </div>
                <button onclick="saveProfile()" class="w-full bg-red-700 hover:bg-red-800 text-white font-bold py-3 rounded mt-6 shadow-md">SAVE PROFILE</button>
            </div>
        </div>
        
        <div id="friend-profile-modal">
            <div class="bg-white p-6 rounded-xl w-11/12 max-w-sm border border-gray-300 relative shadow-2xl flex flex-col items-center">
                <button onclick="closeFriendProfile()" class="absolute top-3 right-3 text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button>
                <div class="w-24 h-24 rounded-full border-2 border-red-600 mb-3 overflow-hidden"><img id="fp-image" src="" class="w-full h-full object-cover"></div>
                <h3 id="fp-name" class="text-xl font-extrabold text-gray-900">User Name</h3>
                <div class="flex items-center gap-2 mb-2"><span class="text-xs text-gray-400 font-bold uppercase">ID: <span id="fp-id">0000</span></span><img id="fp-gender" src="" class="w-4 h-4 object-contain"></div>
                <p id="fp-bio" class="text-center text-sm text-gray-600 italic mb-4 px-2">No bio available.</p>
                <button id="fp-action-btn" class="w-full bg-blue-600 text-white font-bold py-2 rounded-full shadow-lg transition transform active:scale-95">FOLLOW</button>
            </div>
        </div>

        <div id="room-users-modal">
            <div class="bg-gray-900 p-5 rounded-xl w-11/12 max-w-sm border border-gray-700 relative shadow-2xl max-h-[80%] flex flex-col">
                <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-2"><h3 class="text-white font-bold text-lg">Room Users</h3><button onclick="closeRoomUsers()" class="text-gray-400"><i class="fa-solid fa-xmark text-xl"></i></button></div>
                <div id="room-users-list" class="flex-1 overflow-y-auto space-y-2"></div>
            </div>
        </div>

        <div id="prophouse-modal">
            <div class="flex justify-between items-center mb-6 border-b border-zinc-800 pb-4"><h2 class="text-2xl font-bold text-white tracking-wider">PROP <span class="text-red-600">HOUSE</span></h2><button onclick="closePropHouse()" class="text-gray-400 text-xl"><i class="fa-solid fa-xmark"></i></button></div>
            <div id="frame-grid" class="frame-grid flex-1"></div>
        </div>

        <div id="view-auth" class="view-section z-50 fixed inset-0">
            <video id="auth-bg-video" autoplay muted loop playsinline><source src="./login_bg.mp4" type="video/mp4"></video>
            <div class="auth-overlay"></div>
            <div id="auth-content-wrapper">
                <div class="auth-logo-container">
                    <img src="./app_icon.png" class="auth-logo-png" alt="App Icon">
                    <h1 class="text-4xl font-bold mb-2 text-white drop-shadow-lg">★𝐘𝐚𝐫𝐚𝐚𝐧★</h1> 
                </div>
                <div id="auth-main-screen" class="auth-buttons-group">
                    <button onclick="loginWithGoogle()" class="google-sign-btn"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="G" class="google-icon-svg"><span>Sign in with Google</span></button>
                    <div class="yaarann-text-design"><span class="text-gray-400">** * *</span> ★𝐘𝐚𝐫𝐚𝐚𝐧★ <span class="text-gray-400">* * **</span></div>
                    <div onclick="showEmailForm()" class="email-login-trigger"><i class="fa-solid fa-envelope"></i></div>
                </div>
            </div>
        </div>
        
        <div id="email-auth-full-page">
            <div class="email-form-box">
                <div class="flex justify-between items-center mb-6"><h2 id="email-form-title" class="text-2xl font-bold text-gray-900">Email Login</h2><button onclick="hideEmailForm()" class="text-gray-600 hover:text-red-500 transition"><i class="fa-solid fa-xmark text-xl"></i></button></div>
                <form id="auth-form" class="space-y-4 text-left">
                    <div id="username-field" class="hidden"><label class="text-xs text-gray-500 ml-2">Name</label><input type="text" id="username" class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-white focus:border-red-600 outline-none"></div>
                    <input type="email" id="email" placeholder="Email" required class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-white focus:border-red-600 outline-none">
                    <input type="password" id="password" placeholder="Password" required class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-white focus:border-red-600 outline-none">
                    <button type="submit" id="auth-btn" class="w-full bg-red-700 py-3 rounded-lg font-bold shadow-lg mt-4 text-white">LOGIN</button>
                </form>
                <p onclick="toggleAuthMode()" id="auth-switch" class="mt-4 text-center text-sm text-gray-600 cursor-pointer hover:text-red-600 transition">Create an account</p>
            </div>
        </div>

        <div id="view-home" class="view-section light-bg">
            <div id="pull-refresh-indicator"><i class="fa-solid fa-rotate-right fa-spin"></i></div>
            <div class="px-4">
                <div class="modern-carousel" id="main-banner-carousel">
                    <div class="carousel-track" id="banner-track">
                        <div class="carousel-slide"><img src="./banner1.png" class="carousel-img" onerror="this.src='https://placehold.co/600x200?text=Banner+1'"></div>
                        <div class="carousel-slide"><img src="./banner2.png" class="carousel-img" onerror="this.src='https://placehold.co/600x200?text=Banner+2'"></div>
                        <div class="carousel-slide"><img src="./banner3.png" class="carousel-img" onerror="this.src='https://placehold.co/600x200?text=Banner+3'"></div>
                    </div>
                    <div class="carousel-dots" id="banner-dots"></div>
                </div>
            </div>
            <div class="mid-menu-container">
                <div class="mid-menu-item" onclick="openLeaderboard(0)">
                    <img src="./icon_contribution.png" class="mid-menu-img" onerror="this.src='https://placehold.co/100x70?text=Contrib'">
                    <div class="home-top3-container" id="home-top-contrib"></div>
                </div>
                <div class="mid-menu-item" onclick="openLeaderboard(1)">
                    <img src="./icon_charm.png" class="mid-menu-img" onerror="this.src='https://placehold.co/100x70?text=Charm'">
                    <div class="home-top3-container" id="home-top-charm"></div>
                </div>
                <div class="mid-menu-item" onclick="openLeaderboard(2)">
                    <img src="./icon_room.png" class="mid-menu-img" onerror="this.src='https://placehold.co/100x70?text=Room'">
                    <div class="home-top3-container" id="home-top-room"></div>
                </div>
            </div>
            <div id="home-content-container">
                <h3 class="text-sm font-extrabold px-4 mt-2 mb-1 text-gray-800 tracking-wider">ROOMS</h3>
                <div id="home-room-list"></div>
            </div>
        </div>

        <div id="view-inbox" class="view-section light-bg">
            <div class="p-4">
                <div id="requests-section"><h2 class="text-xs font-bold uppercase tracking-widest mb-2">Notifications</h2><div id="inbox-list" class="space-y-2 mb-6"></div></div>
                <h2 class="text-xs font-bold uppercase tracking-widest mb-2">My Following (Chat)</h2><div id="friends-chat-list" class="space-y-2"></div>
            </div>
        </div>

        <div id="view-chat" class="view-section bg-white flex-col hidden" style="z-index: 100;">
            <div class="flex items-center gap-3 p-3 border-b border-gray-200 bg-gray-50 shadow-sm sticky top-0 z-10" id="dm-header">
                <button onclick="closeDirectChat(); event.stopPropagation();" class="text-gray-600 p-2"><i class="fa-solid fa-arrow-left text-lg"></i></button>
                
                <div class="flex-1 flex items-center gap-3 cursor-pointer" onclick="viewFriendProfile(currentChatFriendId)" id="dm-header-content">
                    <!-- JS will inject DP, Name, Badge here -->
                </div>
                
                <i class="fa-solid fa-chevron-right text-gray-300 text-sm pr-2"></i>
            </div>
            <div id="dm-messages" class="flex-1 overflow-y-auto p-4 space-y-2 bg-gray-100"></div>
            <form id="dm-form" class="p-3 bg-white border-t border-gray-200 flex gap-2 sticky bottom-0 z-20 pb-[env(safe-area-inset-bottom)] shadow-[0_-2px_10px_rgba(0,0,0,0.05)]">
                <input type="text" id="dm-input" placeholder="Message..." class="flex-1 bg-gray-100 border border-gray-300 rounded-full px-4 text-black focus:outline-none focus:border-blue-400">
                <button type="submit" class="text-blue-600 px-3"><i class="fa-solid fa-paper-plane text-xl"></i></button>
            </form>
        </div>

        <div id="friend-profile-modal">
            <div class="bg-white p-6 rounded-2xl w-11/12 max-w-sm border border-gray-200 relative shadow-2xl flex flex-col items-center">
                <button onclick="closeFriendProfile()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-700 bg-gray-100 rounded-full w-8 h-8 flex items-center justify-center transition"><i class="fa-solid fa-xmark"></i></button>
                
                <!-- DP with V-Badge Corner -->
                <div class="fp-dp-wrapper mt-2">
                    <img id="fp-image" src="" class="fp-dp">
                    <img id="fp-v-badge" src="./v_badge.png" class="fp-v-badge hidden" onerror="this.style.display='none'">
                </div>
                
                <h3 id="fp-name" class="text-2xl font-black text-gray-900 mb-1">User Name</h3>
                
                <div id="fp-level-badge" class="user-level-badge mb-3 shadow-md">
                    <img id="fp-medal-img" src="" class="level-medal-img"> 
                    <span id="fp-level-text">Lv.1</span>
                </div>

                <div class="flex items-center gap-2 mb-3 bg-gray-50 px-3 py-1 rounded-full border border-gray-200">
                    <span class="text-[10px] text-gray-500 font-bold uppercase tracking-widest">ID: <span id="fp-id" class="text-gray-900 font-mono text-xs ml-1">0000</span></span>
                    <span class="text-gray-300">|</span>
                    <img id="fp-gender" src="" class="w-4 h-4 object-contain filter drop-shadow-sm">
                </div>
                
                <p id="fp-bio" class="text-center text-sm text-gray-600 italic mb-6 px-4 w-full truncate bg-gray-50 py-2 rounded-lg">No bio available.</p>
                
                <button id="fp-action-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-black tracking-widest py-3 rounded-xl shadow-lg transition transform active:scale-95">FOLLOW</button>
            </div>
        </div>

        <div id="view-profile" class="view-section light-bg">
            <div onclick="openEditModal()" class="flex items-center p-5 bg-white cursor-pointer relative">
                <div class="profile-page-visual mr-4" id="profile-visual-container"></div>
                <div class="flex-1 flex flex-col justify-center">
                    <h2 id="profile-name" class="text-2xl font-extrabold text-gray-900 mb-0.5 flex items-center">...<img id="profile-v-badge" src="./v_badge.png" class="v-badge-profile hidden" onerror="this.style.display='none'"></h2>
                    
                  <!-- NEW LEVEL & OFFICIAL BADGE DISPLAY -->
                    <div class="flex justify-between items-center w-full pr-4">
                        <div>
                            <div id="profile-level-badge" class="user-level-badge mb-1 w-max">
                                <img id="profile-medal-img" src="" class="level-medal-img" onerror="this.style.display='none'"> 
                                <span id="profile-level-text">Lv.1</span>
                            </div>

                            <div class="flex items-center gap-2">
                                <span class="text-gray-400 text-xs font-bold uppercase tracking-wide">ID:</span>
                                <span id="profile-id" class="text-gray-800 font-mono text-base font-bold">...</span>
                                <div onclick="copyToClipboard(document.getElementById('profile-id').innerText); event.stopPropagation();" class="p-1 cursor-pointer active:scale-90 transition"><i class="fa-regular fa-copy text-gray-400 text-xs ml-1"></i></div>
                            </div>
                        </div>
                        
                        <!-- VERIFY OFFICIAL PNG (تصویر کے دائرے والی جگہ پر) -->
                        <img id="profile-verify-official" src="./verify_official.png" class="h-8 object-contain hidden filter drop-shadow-md" onerror="this.style.display='none'">
                    </div>
                </div>
                <div class="flex items-center justify-center"><i class="fa-solid fa-chevron-right text-gray-300 text-lg"></i></div>
            </div>
            <p id="profile-bio" class="text-gray-500 text-xs px-5 pb-3 bg-white truncate italic">...</p>
            <div class="flex justify-around items-center bg-white border-t border-b border-gray-100 py-3 mb-2">
                <div onclick="showFriendList('following')" class="flex flex-col items-center flex-1 border-r border-gray-100 cursor-pointer active:bg-gray-50"><span id="stat-following" class="font-bold text-lg text-gray-900">0</span><span class="text-[10px] text-gray-500 uppercase tracking-wide">Follow</span></div>
                <div onclick="showFriendList('fans')" class="flex flex-col items-center flex-1 cursor-pointer active:bg-gray-50"><span id="stat-fans" class="font-bold text-lg text-gray-900">0</span><span class="text-[10px] text-gray-500 uppercase tracking-wide">Fans</span></div>
            </div>
            <div class="bg-white flex flex-col pb-10">
                <div class="menu-list-container">
                    <div class="menu-item" onclick="openRechargeModal()"><div class="menu-icon-box"><i class="fa-solid fa-wallet text-yellow-500 text-lg"></i></div><div class="menu-text">Recharge & Wallet</div><i class="fa-solid fa-chevron-right menu-arrow"></i></div>
                    
                    <!-- NEW: SUPER ADMIN & CUSTOMER SUPPORT -->
                    <div class="menu-item hidden" id="btn-super-admin" onclick="openAdminPanel()"><div class="menu-icon-box"><i class="fa-solid fa-user-shield text-red-600 text-lg"></i></div><div class="menu-text text-red-600 font-bold">Official Panel</div><i class="fa-solid fa-chevron-right menu-arrow"></i></div>
                    
                    <div class="menu-item" onclick="openCustomerSupport()"><div class="menu-icon-box"><i class="fa-solid fa-headset text-blue-500 text-lg"></i></div><div class="menu-text">Customer Service</div><i class="fa-solid fa-chevron-right menu-arrow"></i></div>
                    <div class="menu-item" onclick="showInviteModal()"><div class="menu-icon-box"><i class="fa-solid fa-user-plus text-green-500 text-lg"></i></div><div class="menu-text">Invite friends</div><span class="bg-red-500 text-white text-[10px] px-2 py-0.5 rounded-full mr-2">Invite</span><i class="fa-solid fa-chevron-right menu-arrow"></i></div>
                    <div class="menu-item" onclick="openPropHouse()"><div class="menu-icon-box"><i class="fa-solid fa-store text-blue-500 text-lg"></i></div><div class="menu-text">Store</div><i class="fa-solid fa-chevron-right menu-arrow"></i></div>
                    <div class="menu-item" onclick="showCharmBoard()"><div class="menu-icon-box"><i class="fa-solid fa-heart text-pink-500 text-lg"></i></div><div class="menu-text">Love House (Charm)</div><i class="fa-solid fa-chevron-right menu-arrow"></i></div>
                    <div class="menu-item" onclick="openLevelModal()"><div class="menu-icon-box"><i class="fa-solid fa-crown text-purple-500 text-lg"></i></div><div class="menu-text">Level Center</div><i class="fa-solid fa-chevron-right menu-arrow"></i></div>
                    <div class="menu-item" onclick="openPropHouse()"><div class="menu-icon-box"><i class="fa-solid fa-warehouse text-green-600 text-lg"></i></div><div class="menu-text">Prop Warehouse</div><i class="fa-solid fa-chevron-right menu-arrow"></i></div>
                    <div class="menu-item" onclick="logout()"><div class="menu-icon-box"><i class="fa-solid fa-power-off text-red-600 text-lg"></i></div><div class="menu-text text-red-600">Logout</div><i class="fa-solid fa-chevron-right menu-arrow"></i></div>
                </div>
            </div>
        </div>

           <div id="view-room">
            <!-- FULL SCREEN GIFT VIDEO ANIMATION -->
            <!-- گفٹ اینیمیشن 8 سیکنڈ والا کنٹینر -->
<div id="gift-animation-container" class="fixed inset-0 w-full h-full z-[3500] pointer-events-none hidden flex-col items-center justify-center">
    <video id="gift-animation-player" class="w-full h-full object-contain absolute inset-0" muted playsinline></video>
    <div id="gift-animation-text" class="absolute bottom-1/4 text-white text-3xl font-black drop-shadow-[0_5px_5px_rgba(0,0,0,1)] text-center animate-bounce z-10" style="text-shadow: 2px 2px 4px #000;"></div>
</div>
            
           
            <div id="room-exit-bar">
                <button onclick="minimizeRoom()" class="exit-icon-btn"><img src="./minimize.png" class="icon-img" alt="Minimize"></button>
                <button onclick="leaveRoomFull()" class="exit-icon-btn"><img src="./exit.png" class="icon-img" alt="Leave"></button>
            </div>
            <div id="room-exit-blocker" onclick="closeExitMenu()"></div>

            <div id="room-top-content">
                <div class="flex items-center justify-between px-4 py-2 bg-zinc-900 border-b border-zinc-800">
                    <div class="flex items-center gap-2 overflow-hidden">
                        <img id="room-header-cover" src="https://placehold.co/40x40" class="w-10 h-10 rounded-full border border-gray-600 object-cover flex-shrink-0">
                        <div class="flex flex-col min-w-0">
                            <span id="room-header-name" class="text-sm font-bold text-white truncate">Room Name</span>
                            <div class="flex items-center text-[10px] text-gray-400">
                                <span>ID: <span id="room-header-id">00000</span></span><span class="mx-1">|</span><i class="fa-solid fa-users text-gray-500 mr-1"></i><span id="room-user-count" onclick="showRoomUserList()" class="font-bold text-white cursor-pointer hover:text-red-500 underline">0</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-4 items-center flex-shrink-0">
                        <button onclick="window.showInviteModal()" class="text-white hover:text-green-400"><i class="fa-solid fa-user-plus text-lg"></i></button>
                        <button onclick="window.openRoomSettings()" class="text-white hover:text-blue-400"><i class="fa-solid fa-gear text-lg"></i></button>
                        <button onclick="window.toggleExitMenu()" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-right-from-bracket text-lg"></i></button>
                    </div>
                </div>

                <div class="w-full flex-shrink-0" onclick="hideAllMicMenus(event)">
                    <div class="cinema-frame relative group">
                        <div id="guest-touch-blocker" onclick="handleGuestTap()"></div>
                        <div id="empty-state-trigger"><i class="fa-solid fa-video empty-icon"></i><span class="empty-text">Play Video</span></div>
                        <div id="screen-placeholder" class="absolute inset-0 flex flex-col items-center justify-center bg-black text-zinc-800"></div>
                        <iframe id="video-iframe" class="w-full h-full hidden absolute inset-0 z-10" style="object-fit: contain; width: 100%; height: 100%; background: black;" src="" frameborder="0" allow="autoplay; encrypted-media; picture-in-picture; gyroscope" allowfullscreen></iframe>
                        <video id="local-video-player" class="w-full h-full hidden absolute inset-0 z-20" style="background: black;" controls playsinline></video>
                    </div>
                    <div id="video-controls-wrapper">
                        <div class="flex items-center gap-2 px-4 py-2 bg-black border-b border-zinc-800 overflow-x-auto">
                            <input type="text" id="direct-yt-link" placeholder="Paste YouTube Link..." class="flex-1 bg-gray-800 border border-gray-700 rounded px-2 py-1 text-xs text-white outline-none focus:border-red-600">
                            <button onclick="playDirectVideo()" class="bg-red-600 text-white px-3 py-1 rounded text-xs font-bold whitespace-nowrap"><i class="fa-solid fa-play mr-1"></i> PLAY</button>
                            <button onclick="window.clearScreen()" class="bg-gray-700 text-white px-3 py-1 rounded text-xs font-bold border border-gray-600 whitespace-nowrap">CLEAR</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="room-lower-half">
                <video id="theme-video-bg" loop muted playsinline class="hidden absolute top-0 left-0 w-full h-full object-cover -z-10"></video>

                <div id="rocket-trigger-btn" onclick="openRocketDetails()">
                    <img src="./rocket1.png" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3135/3135715.png'" class="rocket-display-icon" id="main-rocket-icon">
                </div>
                
                <!-- NEW GAME (GREEDY) ICON - SQAURE PNG -->
                <div id="game-trigger-btn" onclick="openGame()" class="absolute bottom-2 right-4 w-10 h-10 z-50 cursor-pointer hover:scale-105 transition">
                    <img src="./game_icon.png" onerror="this.src='https://placehold.co/100x100?text=Game'" class="w-full h-full object-cover rounded-lg shadow-[0_0_10px_rgba(250,204,21,0.5)] border border-yellow-400">
                </div>
                
                <div id="rocket-details-modal">
                    <div class="rocket-modal-card">
                        <button onclick="closeRocketDetails()" class="absolute top-2 right-3 text-gray-400 z-50"><i class="fa-solid fa-xmark text-xl"></i></button>
                        <div class="modal-left-col">
                            <div class="modal-level-btn" id="btn-lvl-4"><span>LV.4</span></div>
                            <div class="modal-level-btn" id="btn-lvl-3"><span>LV.3</span></div>
                            <div class="modal-level-btn" id="btn-lvl-2"><span>LV.2</span></div>
                            <div class="modal-level-btn" id="btn-lvl-1"><span>LV.1</span></div>
                        </div>
                        <div class="modal-center-col">
                            <img id="modal-big-rocket" src="./rocket1.png" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3135/3135715.png'" class="big-center-rocket">
                            <div class="rewards-panel">
                                <div class="rewards-box">
                                    <div class="reward-item"><img src="https://placehold.co/40?text=F" class="reward-img"><span>Frame x1</span></div>
                                    <div class="reward-item"><img src="https://placehold.co/40?text=E" class="reward-img"><span>Entry x1</span></div>
                                    <div class="reward-item"><img src="https://placehold.co/40?text=B" class="reward-img"><span>Badge x1</span></div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-right-col">
                            <div class="tube-container">
                                <div id="rocket-tube-fill" class="tube-fill"></div>
                                <div id="rocket-tube-text" class="tube-percent">0%</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="rocket-fly-layer"></div>

                <div id="mics-scroll-area">
                    <div class="mics-container-main">
                        <div class="top-mic-row flex justify-center items-center gap-2">
                            <div class="mic-wrapper" id="wrapper-seat1"><div class="seat-base mic-container-lg" id="cont-seat1" onclick="toggleMicMenu('seat1', 'UMAR', event)"><img src="./chair.png" class="chair-bg-img" onerror="this.style.display='none'"><div id="seat1-visual" class="user-dp-visual"></div><div id="menu-seat1" class="action-menu-overlay"></div></div><span id="seat1-name" class="seat-name">UMAR</span></div>
                            <div id="heartbeat-container" class="heartbeat-wrapper"><img src="./left.png" class="line-img left-line" alt="Left Line"><img src="./couple_heart.png" class="hb-img" alt="Heart"><img src="./right.png" class="line-img right-line" alt="Right Line"></div>
                            <div class="mic-wrapper" id="wrapper-seat2"><div class="seat-base mic-container-lg" id="cont-seat2" onclick="toggleMicMenu('seat2', 'GURIYA', event)"><img src="./chair.png" class="chair-bg-img" onerror="this.style.display='none'"><div id="seat2-visual" class="user-dp-visual"></div><div id="menu-seat2" class="action-menu-overlay"></div></div><span id="seat2-name" class="seat-name">GURIYA</span></div>
                        </div>
                        <div class="bottom-mic-row flex justify-center gap-3 flex-wrap">
                            <div class="mic-wrapper" id="wrapper-seat3"><div class="seat-base mic-container-sm" id="cont-seat3" onclick="toggleMicMenu('seat3', '1', event)"><img src="./chair.png" class="chair-bg-img" onerror="this.style.display='none'"><div id="seat3-visual" class="user-dp-visual"></div><div id="menu-seat3" class="action-menu-overlay"></div></div><span id="seat3-name" class="seat-name">1</span></div>
                            <div class="mic-wrapper" id="wrapper-seat4"><div class="seat-base mic-container-sm" id="cont-seat4" onclick="toggleMicMenu('seat4', '2', event)"><img src="./chair.png" class="chair-bg-img" onerror="this.style.display='none'"><div id="seat4-visual" class="user-dp-visual"></div><div id="menu-seat4" class="action-menu-overlay"></div></div><span id="seat4-name" class="seat-name">2</span></div>
                            <div class="mic-wrapper" id="wrapper-seat5"><div class="seat-base mic-container-sm" id="cont-seat5" onclick="toggleMicMenu('seat5', '3', event)"><img src="./chair.png" class="chair-bg-img" onerror="this.style.display='none'"><div id="seat5-visual" class="user-dp-visual"></div><div id="menu-seat5" class="action-menu-overlay"></div></div><span id="seat5-name" class="seat-name">3</span></div>
                            <div class="mic-wrapper" id="wrapper-seat6"><div class="seat-base mic-container-sm" id="cont-seat6" onclick="toggleMicMenu('seat6', '4', event)"><img src="./chair.png" class="chair-bg-img" onerror="this.style.display='none'"><div id="seat6-visual" class="user-dp-visual"></div><div id="menu-seat6" class="action-menu-overlay"></div></div><span id="seat6-name" class="seat-name">4</span></div>
                        </div>
                    </div>
                </div>

                <div id="chat-display-area"></div>
            </div>
            
            <div id="room-bottom-bar">
                <div class="flex items-center justify-between w-full" id="room-icons-container">
                    <i onclick="openRoomChatInput()" class="fa-solid fa-comment-dots room-icon-btn"></i>
                    <i onclick="minimizeRoom(); switchTab('view-inbox', document.getElementById('btn-inbox'))" class="fa-solid fa-inbox room-icon-btn"></i>
                    <i onclick="toggleMic()" id="btn-mic" class="fa-solid fa-microphone room-icon-btn text-white"></i>
                    <i onclick="toggleSpeaker()" id="btn-speaker" class="fa-solid fa-volume-high room-icon-btn text-white"></i>
                    <i onclick="openGiftModal()" class="fa-solid fa-gift room-icon-btn text-pink-400"></i>
                </div>
                
                <form id="room-chat-input-layer" onsubmit="sendRoomMessage(event)">
                    <button type="button" onclick="closeRoomChatInput()" class="text-gray-400"><i class="fa-solid fa-xmark"></i></button>
                    <input type="text" id="room-chat-input-field" placeholder="Type here..." class="flex-1 bg-zinc-800 border border-zinc-700 rounded-full px-4 py-2 text-sm text-white focus:outline-none">
                    <button type="submit" class="text-blue-500"><i class="fa-solid fa-paper-plane"></i></button>
                </form>
            </div>
        </div>
        
        <nav id="bottom-nav" class="bottom-nav hidden">
            <div class="nav-item active" id="btn-home" onclick="switchTab('view-home', this)"><i class="fa-solid fa-house"></i><span>Home</span></div>
            <div class="nav-item" id="btn-inbox" onclick="switchTab('view-inbox', this)"><div class="relative"><i class="fa-solid fa-inbox"></i><div id="inbox-dot" class="absolute top-0 right-0 w-2 h-2 bg-red-600 rounded-full hidden"></div></div><span>Inbox</span></div>
            <div class="nav-item" id="btn-profile" onclick="switchTab('view-profile', this)"><i class="fa-solid fa-user"></i><span>Me</span></div>
        </nav>
    </div>

    <!-- NEW 8 GIFTS MODAL WITH TARGET SELECTOR -->
    <div id="gift-modal" class="hidden fixed inset-0 bg-black/80 z-[200] flex flex-col justify-end">
        <div onclick="document.getElementById('gift-modal').classList.add('hidden')" class="flex-1"></div>
        <div class="bg-gray-900 rounded-t-2xl p-4 border-t border-gray-700 flex flex-col">
            
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-white font-bold text-sm">Send to: <span id="gift-target-name-display" class="text-yellow-400">Owner</span></h3>
                <span class="text-yellow-400 text-xs font-bold">Coins: <span id="gift-modal-coins">0</span></span>
            </div>

            <!-- Horizontal Target Selector -->
            <div class="gift-targets-wrapper" id="gift-target-list">
                <!-- Dynamically Populated -->
            </div>

            <div class="gift-grid">
                <div class="gift-item" onclick="sendGift('Rose', 10000)"><img src="https://placehold.co/50?text=🌹" class="gift-img"><span class="gift-price">10k</span></div>
                <div class="gift-item" onclick="sendGift('Ring', 50000)"><img src="https://placehold.co/50?text=💍" class="gift-img"><span class="gift-price">50k</span></div>
                <div class="gift-item" onclick="sendGift('Car', 300000)"><img src="https://placehold.co/50?text=🏎️" class="gift-img"><span class="gift-price">300k</span></div>
                <div class="gift-item" onclick="sendGift('Rocket', 500000)"><img src="./rocket4.png" onerror="this.src='https://placehold.co/50?text=🚀'" class="gift-img"><span class="gift-price">500k</span></div>
                <div class="gift-item" onclick="sendGift('Crown', 1000000)"><img src="./crown.png" onerror="this.src='https://placehold.co/50?text=👑'" class="gift-img"><span class="gift-price">1M</span></div>
                <div class="gift-item" onclick="sendGift('Castle', 5000000)"><img src="./castle.png" onerror="this.src='https://placehold.co/50?text=🏰'" class="gift-img"><span class="gift-price">5M</span></div>
                <div class="gift-item" onclick="sendGift('Yacht', 10000000)"><img src="./yacht.png" onerror="this.src='https://placehold.co/50?text=🛥️'" class="gift-img"><span class="gift-price">10M</span></div>
                <div class="gift-item" onclick="sendGift('Dragon', 50000000)"><img src="./dragon.png" onerror="this.src='https://placehold.co/50?text=🐉'" class="gift-img"><span class="gift-price">50M</span></div>
            </div>
        </div>
    </div>
<!-- SUPER ADMIN PANEL MODAL -->
    <div id="admin-panel-modal">
        <div class="admin-box relative">
            <button onclick="closeAdminPanel()" class="absolute top-3 right-3 text-gray-400 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
            <h2 class="text-xl font-black text-red-500 mb-4 text-center tracking-widest uppercase"><i class="fa-solid fa-shield-halved mr-2"></i>Official Panel</h2>
            
            <div class="flex gap-2 mb-4">
                <input type="number" id="admin-search-id" class="admin-input flex-1 !mb-0" placeholder="Enter User ID">
                <button onclick="searchUserForAdmin()" class="bg-red-600 text-white px-4 rounded-lg font-bold"><i class="fa-solid fa-search"></i></button>
            </div>

            <div id="admin-target-user" class="hidden bg-gray-800 p-3 rounded-lg border border-gray-700 mb-4">
                <div class="flex items-center gap-3 mb-3">
                    <img id="admin-target-dp" src="" class="w-12 h-12 rounded-full border-2 border-red-500 object-cover">
                    <div>
                        <div id="admin-target-name" class="text-white font-bold text-sm">Name</div>
                        <div id="admin-target-uid-display" class="text-xs text-gray-400">ID: <span></span></div>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-2">
                    <div class="admin-action-btn bg-yellow-600" onclick="adminAction('warn')"><i class="fa-solid fa-triangle-exclamation mr-1"></i> Send Warning</div>
                    <div class="admin-action-btn bg-green-600" onclick="adminAction('coins')"><i class="fa-solid fa-coins mr-1"></i> Send Coins</div>
                    <div class="admin-action-btn bg-red-600" onclick="adminAction('ban')"><i class="fa-solid fa-ban mr-1"></i> Ban User</div>
                    <div class="admin-action-btn bg-blue-600" onclick="adminAction('unban')"><i class="fa-solid fa-unlock mr-1"></i> Unban User</div>
                    <div class="admin-action-btn bg-purple-600" id="btn-make-official" onclick="adminAction('official')"><i class="fa-solid fa-certificate mr-1"></i> Make Official</div>
                    <div class="admin-action-btn bg-gray-700" onclick="adminAction('delete')"><i class="fa-solid fa-trash mr-1"></i> Delete ID</div>
                </div>
            </div>
        </div>
    </div>
    <!-- LUCKY FRUIT GAME MODAL -->
    <div id="game-modal">
        <div class="game-container">
            
            <div class="game-header-top">
                <button onclick="closeGame()" class="absolute top-2 right-4 text-[#8b7355] text-xl z-50 hover:text-red-500"><i class="fa-solid fa-circle-xmark"></i></button>
                <button onclick="openGameHistory()" class="absolute top-2 left-4 text-[#8b7355] text-xl z-50 hover:text-yellow-400"><i class="fa-solid fa-clock-rotate-left"></i></button>
                
                <h2 class="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-b from-[#ffda44] to-[#d97706] tracking-wider mb-1" style="-webkit-text-stroke: 1px #5c1e06;">LUCKY FRUIT</h2>
                <div class="round-text-box" id="round-number-display">Round ... of today</div>
            </div>

            <!-- ہوبہو سکرین شاٹ جیسا رزلٹ پاپ اپ -->
            <div id="new-result-popup">
                <div class="popup-header-bar">
                    <div style="width: 45px; height: 45px; background: rgba(255,255,255,0.2); border-radius: 5px; display: flex; align-items: center; justify-content: center; margin-right: 10px;">
                        <img id="popup-fruit-img" src="" alt="Fruit">
                    </div>
                    <span id="popup-text">You didn't participate this round</span>
                </div>
                <div class="popup-body">
                    <div id="popup-circle" class="popup-icon-circle">!</div>
                    <div id="popup-amount" class="popup-win-amount hidden"></div>
                </div>
            </div>
            
            <div class="fruit-grid">
                <div class="fruit-item" id="f-0" onclick="placeBet(0)"><img src="./orange.png" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3137/3137000.png'" class="fruit-img"><div class="text-multiplier">5 times</div><div class="bet-overlay" id="bet-0"></div></div>
                <div class="fruit-item" id="f-1" onclick="placeBet(1)"><img src="./lemon.png" onerror="this.src='https://cdn-icons-png.flaticon.com/512/1182/1182141.png'" class="fruit-img"><div class="text-multiplier">5 times</div><div class="bet-overlay" id="bet-1"></div></div>
                <div class="fruit-item" id="f-2" onclick="placeBet(2)"><img src="./grapes.png" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3137/3137042.png'" class="fruit-img"><div class="text-multiplier">5 times</div><div class="bet-overlay" id="bet-2"></div></div>
                <div class="fruit-item" id="f-3" onclick="placeBet(3)"><img src="./cherry.png" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3137/3137014.png'" class="fruit-img"><div class="text-multiplier">5 times</div><div class="bet-overlay" id="bet-3"></div></div>
                
                <div class="fruit-item" id="f-4">
                    <img src="./small_bonus.png" onerror="this.src='https://placehold.co/100x100/00bfff/white?text=Lucky'" class="fruit-img" style="width: 80%; height: 80%;">
                </div>
                
                <div class="center-timer" id="game-timer">30</div>
                
                <div class="fruit-item" id="f-5">
                    <img src="./big_bonus.png" onerror="this.src='https://placehold.co/100x100/ff00ff/white?text=Lucky'" class="fruit-img" style="width: 80%; height: 80%;">
                </div>
                
                <div class="fruit-item" id="f-6" onclick="placeBet(6)"><img src="./apple.png" onerror="this.src='https://cdn-icons-png.flaticon.com/512/415/415733.png'" class="fruit-img"><div class="text-multiplier">10 times</div><div class="bet-overlay" id="bet-6"></div></div>
                <div class="fruit-item" id="f-7" onclick="placeBet(7)"><img src="./melon.png" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3137/3137030.png'" class="fruit-img"><div class="text-multiplier">15 times</div><div class="bet-overlay" id="bet-7"></div></div>
                <div class="fruit-item" id="f-8" onclick="placeBet(8)"><img src="./mango.png" onerror="this.src='https://cdn-icons-png.flaticon.com/512/6864/6864273.png'" class="fruit-img"><div class="text-multiplier">25 times</div><div class="bet-overlay" id="bet-8"></div></div>
                <div class="fruit-item" id="f-9" onclick="placeBet(9)"><img src="./berry.png" onerror="this.src='https://cdn-icons-png.flaticon.com/512/590/590685.png'" class="fruit-img"><div class="text-multiplier">45 times</div><div class="bet-overlay" id="bet-9"></div></div>
            </div>

            <!-- بڑے بیٹس (10K سے 1M تک) -->
            <div class="bet-controls">
                <button class="chip-btn selected" onclick="selectChip(10000, this)">10K</button>
                <button class="chip-btn" onclick="selectChip(50000, this)">50K</button>
                <button class="chip-btn" onclick="selectChip(500000, this)">500K</button>
                <button class="chip-btn" onclick="selectChip(1000000, this)">1M <i class="fa-brands fa-bitcoin"></i></button>
            </div>

            <div class="game-footer">
                <div class="footer-box">
                    <span class="footer-label">Balance</span>
                    <span class="footer-value"><img src="https://cdn-icons-png.flaticon.com/512/3135/3135673.png" style="width:12px;"> <span id="game-balance">0</span></span>
                </div>
                <div class="footer-box">
                    <span class="footer-label">Today's Winnings</span>
                    <span class="footer-value"><img src="https://cdn-icons-png.flaticon.com/512/3135/3135673.png" style="width:12px;"> <span id="game-today-win">0</span></span>
                </div>
            </div>

            <!-- ہسٹری سکرین شاٹ کے مطابق -->
            <div class="history-strip" id="game-history-strip">
                <span class="history-label">Results:</span>
            </div>

            <div id="game-history-modal" class="absolute inset-0 bg-black/95 z-[100] hidden flex-col">
                <div class="flex justify-between items-center p-4 border-b border-gray-700 bg-gray-900">
                    <h3 class="text-white font-bold"><i class="fa-solid fa-clock-rotate-left text-yellow-400 mr-2"></i>Bet History</h3>
                    <button onclick="closeGameHistory()" class="text-gray-400 text-xl"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <div id="game-history-list" class="flex-1 overflow-y-auto p-2 space-y-2"></div>
            </div>
        </div>
    </div>
    <!-- LEVEL SYSTEM MODAL -->
<div id="level-system-modal">
    <div class="level-modal-content relative">
        <button onclick="closeLevelModal()" class="absolute top-3 right-3 text-gray-400 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
        <h2 class="text-2xl font-black text-white text-center mb-4 uppercase tracking-widest">My Level</h2>
        
        <div class="level-progress-box">
            <div id="modal-current-level-badge" class="flex justify-center mb-2 scale-125"></div>
            <div class="flex justify-between text-xs text-gray-400 font-bold mt-2">
                <span id="modal-exp-current">0 EXP</span>
                <span id="modal-exp-needed">0 EXP Needed</span>
            </div>
            <div class="level-bar-bg"><div id="modal-level-bar" class="level-bar-fill" style="width: 0%;"></div></div>
        </div>

        <h3 class="text-sm font-bold text-gray-300 mb-2">Level Rewards</h3>
        <div class="reward-list-container" id="level-rewards-list">
            <!-- Rewards will be injected here by JS -->
        </div>
    </div>
</div>
    <script type="module">
    window.closeLevelModal = () => { 
    document.getElementById('level-system-modal').style.display = 'none'; 
};

window.claimLevelReward = async (lvl, type, val) => {
    Swal.fire({title: 'Claiming...', allowOutsideClick: false, showConfirmButton: false, background: '#111', color: '#fff'});
    
    try {
        if (type === 'coins') { 
            currentCoins += val; 
            await update(ref(db, `users/${currentUser.uid}`), { coins: currentCoins }); 
        } 
        else if (type === 'vip') { 
            await update(ref(db, `users/${currentUser.uid}/unlockedVIPs`), { [val]: true }); 
        }
        
        await update(ref(db, `users/${currentUser.uid}/claimedLevelRewards`), { [lvl]: true });
        
        Swal.fire({icon: 'success', title: 'Reward Claimed!', text: 'Check your Wallet or Prop House.', background: '#111', color: '#fff'});
        
        openLevelModal(); 
        
    } catch (error) {
        Swal.fire('Error', error.message, 'error');
    }
};
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getDatabase, ref, set, get, push, onValue, update, remove, child, onDisconnect, runTransaction, onChildAdded } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDsINqjN-WfgOHYm592c0Hq1zyoonDJ5qI",
            authDomain: "yaraan-app-b2296.firebaseapp.com",
            databaseURL: "https://yaraan-app-b2296-default-rtdb.firebaseio.com",
            projectId: "yaraan-app-b2296",
            storageBucket: "yaraan-app-b2296.firebasestorage.app",
            messagingSenderId: "39282278939",
            appId: "1:39282278939:web:2337152b888edd03af2ebe"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let currentUser = null;
        let currentRoomId = null;
        let currentRoomOwner = null;
        let currentRoomData = null; 
        let currentUserJoinTime = 0; 
        let currentChatFriendId = null;
        let isSignup = false;
        let currentEditingImg = null;
        let currentHomeTab = 'popular'; 
        let currentRoomSeats = {};
        let selectedGender = null;
        let isMicMuted = false;
        let isSpeakerMuted = false;
        let currentUserIsOfficial = false; // NEW
        const SUPER_ADMIN_ID = 10005; // مین باس کی آئی ڈی
        
        // Economy & Levels
        let currentCoins = 50000; 
        let currentDiamonds = 0;
        let currentUserExp = 0; // NEW: Track User XP for Levels

        // Gift Target
        let selectedGiftTargetUid = null;
        let selectedGiftTargetName = "";

        const ROCKET_LEVELS = [ 
            { level: 1, cost: 300000, img: './rocket1.png' }, 
            { level: 2, cost: 500000, img: './rocket2.png' }, 
            { level: 3, cost: 2000000, img: './rocket3.png' }, 
            { level: 4, cost: 3000000, img: './rocket4.png' } 
        ];
        let currentRoomExp = 0;
        let lastRocketLevel = 0;
        let rocketQueue = [];
        let isRocketFlying = false;
        let isFirstRocketLoad = true; 
        // ================== NEW HARD LEVEL & REWARD SYSTEM ==================
const LEVEL_COLORS =[
    "", // 0 (Not used)
    "linear-gradient(to right, #22c55e, #16a34a)", // 1-10: Green
    "linear-gradient(to right, #3b82f6, #2563eb)", // 11-20: Blue
    "linear-gradient(to right, #ec4899, #db2777)", // 21-30: Pink
    "linear-gradient(to right, #1e3a8a, #172554)", // 31-40: Dark Blue
    "linear-gradient(to right, #ca8a04, #a16207)", // 41-50: Dark Yellow
    "linear-gradient(to right, #be185d, #9d174d)", // 51-60: Dark Pink
    "linear-gradient(to right, #ef4444, #dc2626)", // 61-70: Red
    "linear-gradient(to right, #7f1d1d, #450a0a)", // 71-80: Dark Red
    "linear-gradient(to right, #d1d5db, #9ca3af)", // 81-90: Dark White
    "linear-gradient(to right, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff)" // 91-100: Colorful
];

function getExpForLevel(lvl) {
    if(lvl <= 1) return 0;
    return Math.floor(Math.pow(lvl, 2.5) * 2000); 
}

function getUserLevel(exp) {
    let xp = exp || 0;
    let lvl = 1;
    while(xp >= getExpForLevel(lvl + 1) && lvl < 100) { lvl++; }
    return lvl;
}

function getLevelTier(lvl) {
    return Math.min(10, Math.ceil(lvl / 10));
}

function getMedalImage(lvl) {
    return `./medal${getLevelTier(lvl)}.png`; // یہ میڈل 1 سے 10 تک خود اٹھائے گا
}

function renderLevelHTML(exp) {
    let lvl = getUserLevel(exp);
    let tier = getLevelTier(lvl);
    let medal = getMedalImage(lvl);
    let bgStyle = LEVEL_COLORS[tier] || LEVEL_COLORS[1];
    
    return `<div class="user-level-badge" style="background: ${bgStyle}; border-color: rgba(255,255,255,0.4); box-shadow: 0 2px 5px rgba(0,0,0,0.5);">
                <img src="${medal}" class="level-medal-img" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3135/3135692.png'">
                <span style="text-shadow: 1px 1px 2px black;">Lv.${lvl}</span>
            </div>`;
}

window.openLevelModal = async () => {
    document.getElementById('level-system-modal').style.display = 'flex';
    
    let currentExp = currentUserExp || 0;
    let currentLvl = getUserLevel(currentExp);
    let prevExp = getExpForLevel(currentLvl);
    let nextExp = getExpForLevel(currentLvl + 1);
    
    if (currentLvl >= 100) { nextExp = currentExp; } 
    let percent = currentLvl >= 100 ? 100 : ((currentExp - prevExp) / (nextExp - prevExp)) * 100;
    
    // سب سے اوپر والے میڈل کو پلیٹ سے بڑا کرنے کے لیے style میں scale اور position دی گئی ہے
    let topBadgeHtml = renderLevelHTML(currentExp).replace('class="user-level-badge"', 'class="user-level-badge" style="transform: scale(1.6); position: relative; top: -10px; z-index: 10; border-radius: 8px;"');
    document.getElementById('modal-current-level-badge').innerHTML = topBadgeHtml;
    
    document.getElementById('modal-exp-current').innerText = `${currentExp.toLocaleString()} EXP`;
    document.getElementById('modal-exp-needed').innerText = currentLvl >= 100 ? "MAX LEVEL" : `${nextExp.toLocaleString()} Needed`;
    document.getElementById('modal-level-bar').style.width = `${Math.min(100, Math.max(0, percent))}%`;

    const snap = await get(ref(db, `users/${currentUser.uid}/claimedLevelRewards`));
    const claimedData = snap.val() || {};
    const rewardsList = document.getElementById('level-rewards-list');
    rewardsList.innerHTML = '';

    // 1 سے 100 تک آٹو لیولز ریوارڈز
    const rewards =[];
    for(let i = 1; i <= 100; i++) {
        let rewardName, rewardType, rewardVal, rewardImg;
        let medalImg = getMedalImage(i); // آپ کے میڈل کی تصویر
        
        if (i === 10) { rewardName = '50,000 Coins'; rewardType = 'coins'; rewardVal = 50000; rewardImg = medalImg; }
        else if (i === 20) { rewardName = 'VIP Green & 100k Coins'; rewardType = 'vip'; rewardVal = 'name-vip-green'; rewardImg = medalImg; }
        else if (i === 30) { rewardName = 'VIP Yellow & 150k Coins'; rewardType = 'vip'; rewardVal = 'name-vip-yellow'; rewardImg = medalImg; }
        else if (i === 40) { rewardName = '300,000 Coins'; rewardType = 'coins'; rewardVal = 300000; rewardImg = medalImg; }
        else if (i === 50) { rewardName = 'VIP Pink & 500k Coins'; rewardType = 'vip'; rewardVal = 'name-vip-pink'; rewardImg = medalImg; }
        else if (i === 60) { rewardName = '1M Coins'; rewardType = 'coins'; rewardVal = 1000000; rewardImg = medalImg; }
        else if (i === 70) { rewardName = 'VIP Colorful'; rewardType = 'vip'; rewardVal = 'name-vip-colorful'; rewardImg = medalImg; }
        else if (i === 80) { rewardName = '5M Coins'; rewardType = 'coins'; rewardVal = 5000000; rewardImg = medalImg; }
        else if (i === 90) { rewardName = '10M Coins'; rewardType = 'coins'; rewardVal = 10000000; rewardImg = medalImg; }
        else if (i === 100) { rewardName = 'MAX Level VIP & 50M Coins'; rewardType = 'vip'; rewardVal = 'name-vip-colorful'; rewardImg = medalImg; }
        else { 
            // باقی نارمل لیولز کے لیے (1,2,3... 11,12...)
            rewardName = `${(i * 1000).toLocaleString()} Coins`; 
            rewardType = 'coins'; 
            rewardVal = i * 1000; 
            rewardImg = medalImg; 
        }
        
        rewards.push({ lvl: i, name: rewardName, type: rewardType, val: rewardVal, img: rewardImg });
    }

    rewards.forEach(r => {
        let isClaimed = claimedData[r.lvl] === true;
        let isUnlocked = currentLvl >= r.lvl;
        let btnHtml = ''; let boxClass = 'reward-item-box';
        
        if (isClaimed) { btnHtml = `<button class="claim-btn" disabled>CLAIMED</button>`; boxClass += ' claimed'; } 
        else if (isUnlocked) { btnHtml = `<button class="claim-btn" onclick="claimLevelReward(${r.lvl}, '${r.type}', ${r.type==='coins' ? r.val : `'${r.val}'`})">CLAIM</button>`; } 
        else { btnHtml = `<button class="claim-btn" disabled><i class="fa-solid fa-lock"></i> Lvl ${r.lvl}</button>`; boxClass += ' locked'; }

        rewardsList.innerHTML += `<div class="${boxClass}"><div class="flex items-center gap-3"><img src="${r.img}" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3135/3135692.png'" class="w-10 h-10 object-contain drop-shadow-md"><div><div class="text-white font-bold text-sm">Level ${r.lvl}</div><div class="text-yellow-400 text-xs">${r.name}</div></div></div>${btnHtml}</div>`;
    });
};

     // =============== VIP LEADERBOARDS LOGIC ===============
let currentLbMainTab = 0; // 0=Contrib, 1=Charm, 2=Room
let currentLbSubTab = 'daily'; // daily, weekly, monthly

window.openLeaderboard = async (tabIndex = 0) => {
    document.getElementById('leaderboard-modal').style.display = 'flex';
    document.getElementById('my-rank-dp').src = currentUser.photoURL || 'https://placehold.co/100';
    document.getElementById('my-rank-name').innerText = currentUser.displayName || 'User';
    switchMainTab(tabIndex);
};

window.closeLeaderboard = () => { document.getElementById('leaderboard-modal').style.display = 'none'; };

window.switchMainTab = (index) => {
    currentLbMainTab = index;
    document.querySelectorAll('.lb-m-tab').forEach((t, i) => {
        if(i === index) t.classList.add('active'); else t.classList.remove('active');
    });
    fetchAllLeaderboardsVIP();
};

window.switchSubTab = (type) => {
    currentLbSubTab = type;
    document.querySelectorAll('.lb-s-tab').forEach(t => {
        if(t.innerText.toLowerCase() === type) t.classList.add('active'); else t.classList.remove('active');
    });
    fetchAllLeaderboardsVIP();
};

async function fetchAllLeaderboardsVIP() {
    const contentArea = document.getElementById('lb-content-area');
    contentArea.innerHTML = '<div class="text-center text-white mt-20 font-bold">Loading Data...</div>';

    const usersSnap = await get(ref(db, 'users'));
    const roomsSnap = await get(ref(db, 'rooms'));
    
    let uArr = [], rArr =[];
    let timeKey = currentLbSubTab; // 'daily', 'weekly', 'monthly'

    if(usersSnap.exists()) {
        usersSnap.forEach(s => { 
            let u = s.val(); u.uid = s.key;
            u.exp_score = Number(u[`userExp_${timeKey}`]) || 0; 
            u.charm_score = Number(u[`charm_${timeKey}`]) || 0;
            uArr.push(u); 
        });
    }
    
    if(roomsSnap.exists()) {
        roomsSnap.forEach(s => { 
            let r = s.val(); r.id = s.key;
            r.wealth_score = Number(r[`wealth_${timeKey}`]) || 0;
            rArr.push(r); 
        });
    }

    let sortedData =[]; let icon = '🪙'; let myScore = 0; let myRank = "No ranking";

    if (currentLbMainTab === 0) {
        sortedData =[...uArr].sort((a,b) => b.exp_score - a.exp_score); icon = '🪙';
        let me = sortedData.findIndex(u => u.uid === currentUser.uid);
        if(me !== -1 && sortedData[me].exp_score > 0) { myRank = me + 1; myScore = sortedData[me].exp_score; }
    } else if (currentLbMainTab === 1) {
        sortedData = [...uArr].sort((a,b) => b.charm_score - a.charm_score); icon = '💎';
        let me = sortedData.findIndex(u => u.uid === currentUser.uid);
        if(me !== -1 && sortedData[me].charm_score > 0) { myRank = me + 1; myScore = sortedData[me].charm_score; }
    } else {
        sortedData = [...rArr].sort((a,b) => b.wealth_score - a.wealth_score); icon = '🎁';
        let me = sortedData.findIndex(r => r.owner === currentUser.uid);
        if(me !== -1 && sortedData[me].wealth_score > 0) { myRank = me + 1; myScore = sortedData[me].wealth_score; }
    }

    document.getElementById('my-rank-text').innerText = myRank !== "No ranking" ? `No. ${myRank}` : myRank;
    document.getElementById('my-rank-score').innerText = myScore.toLocaleString();

    renderVIPLeaderboard(sortedData.filter(d => (d.exp_score > 0 || d.charm_score > 0 || d.wealth_score > 0)), currentLbMainTab, icon);
}

function renderVIPLeaderboard(dataList, tabType, icon) {
    const contentArea = document.getElementById('lb-content-area');
    if(dataList.length === 0) {
        contentArea.innerHTML = '<div class="text-center text-gray-400 mt-20 font-bold">No ranking for this period.</div>'; return;
    }

    let top1 = dataList[0], top2 = dataList[1], top3 = dataList[2];
    
    let podiumHTML = `<div class="lb-stage-bg">`;
    if(top2) podiumHTML += createVIPPodiumUser(top2, 2, tabType, icon);
    if(top1) podiumHTML += createVIPPodiumUser(top1, 1, tabType, icon);
    if(top3) podiumHTML += createVIPPodiumUser(top3, 3, tabType, icon);
    podiumHTML += `</div>`;

    let listHTML = `<div class="pb-5 pt-2">`;
    for(let i = 3; i < dataList.length; i++) {
        let d = dataList[i];
        let name = d.username || d.roomName;
        let pic = tabType === 2 ? d.roomCover : d.photoURL;
        if(!pic) pic = `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=random`;
        let score = tabType === 0 ? d.exp_score : (tabType === 1 ? d.charm_score : d.wealth_score);
        let clickAct = tabType === 2 ? `onclick="joinRoom('${d.id}'); closeLeaderboard();"` : '';

        // V-Badge Check for List Users (Placed on DP)
        let isOfficial = d.isOfficial || d.customId === 10005;
        let vBadgeHTML = isOfficial ? `<img src="./v_badge.png" class="absolute -bottom-1 -right-1 w-5 h-5 bg-white rounded-full p-[2px] shadow-md z-10 object-contain border border-gray-200" onerror="this.style.display='none'">` : '';

        listHTML += `
        <div class="vip-list-item" ${clickAct}>
            <div class="flex items-center gap-4">
                <span class="text-gray-400 font-bold w-4 text-center">${i+1}</span>
                <div class="relative flex-shrink-0">
                    <img src="${pic}" class="w-12 h-12 rounded-full object-cover border-2 border-gray-600 shadow-md">
                    ${vBadgeHTML}
                </div>
                <div class="max-w-[120px]">
                    <span class="text-white font-bold text-sm truncate block">${name}</span>
                </div>
            </div>
            <div class="text-yellow-400 font-bold text-xs">${score.toLocaleString()} ${icon}</div>
        </div>`;
    }
    listHTML += `</div>`;
    contentArea.innerHTML = podiumHTML + listHTML;
}

function createVIPPodiumUser(d, rank, tabType, icon) {
    let name = d.username || d.roomName;
    let pic = tabType === 2 ? d.roomCover : d.photoURL;
    if(!pic) pic = `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=random`;
    let score = tabType === 0 ? d.exp_score : (tabType === 1 ? d.charm_score : d.wealth_score);
    let crown = rank === 1 ? '<img src="https://cdn-icons-png.flaticon.com/512/3135/3135692.png" class="vip-crown">' : '';
    let badgeClass = rank === 1 ? 'bg-gold' : (rank === 2 ? 'bg-silver' : 'bg-bronze');
    
    let isOfficial = d.isOfficial || d.customId === 10005;
    let badgeSize = rank === 1 ? 'w-[26px] h-[26px]' : 'w-[22px] h-[22px]';
    let badgePos = rank === 1 ? 'bottom-2 -right-2' : 'bottom-1 -right-2';
    let vBadgeHTML = isOfficial ? `<img src="./v_badge.png" class="absolute ${badgePos} ${badgeSize} bg-white rounded-full p-[2px] shadow-lg z-20 object-contain border border-gray-200" onerror="this.style.display='none'">` : '';

    return `
    <div class="vip-podium-item">
        ${crown}
        <div class="relative flex justify-center">
            <img src="${pic}" class="vip-podium-dp rank-${rank}-dp">
            ${vBadgeHTML}
        </div>
        <div class="vip-rank-badge ${badgeClass} relative z-30">${rank}</div>
        <div class="mt-2 max-w-[80px] text-center">
            <span class="${d.nameColorClass || 'text-white'} font-bold text-[10px] truncate block">${name}</span>
        </div>
        <span class="text-yellow-400 font-bold text-[9px] drop-shadow-md">${score.toLocaleString()} ${icon}</span>
    </div>`;
}

// اصلی تصویر نکالنے کا فنکشن

       // اصلی تصویر نکالنے کا فنکشن
        function getRealAvatar(d, isRoom) {
    if(!d) return 'https://ui-avatars.com/api/?name=?&background=random';
    let name = d.username || d.roomName || 'User';
    let pic = isRoom ? d.roomCover : d.photoURL;
    
    if(!pic || pic.trim() === '') {
        // نام میں موجود سپیس کو فکس کرنے کے لیے encodeURIComponent لگایا ہے تاکہ تصویر غائب نہ ہو
        let safeName = encodeURIComponent(name);
        pic = `https://ui-avatars.com/api/?name=${safeName}&background=random&color=fff&bold=true`;
    }
    return pic;
}

        // یہ فنکشن ہوم سکرین کے بٹنوں پر تصویریں لگائے گا
        window.updateHomeTopDPs = async () => {
    const usersSnap = await get(ref(db, 'users'));
    const roomsSnap = await get(ref(db, 'rooms'));
    
    let uArr = [], rArr =[];
    if(usersSnap.exists()) {
        usersSnap.forEach(s => { 
            let u = s.val(); 
            u.uid = s.key;
            // Force Number() لگایا ہے تاکہ لاکھوں کروڑوں کی ویلیو غلط نہ ہو
            u.userExp = Number(u.userExp) || 0; 
            u.charm = Number(u.charm) || 0;
            uArr.push(u); 
        });
    }
    if(roomsSnap.exists()) {
        roomsSnap.forEach(s => { 
            let r = s.val(); 
            r.id = s.key;
            r.wealth = Number(r.wealth) || 0;
            rArr.push(r); 
        });
    }
    
    // 100% رئیل سورٹنگ جو اندر اور باہر بالکل سیم رزلٹ دے گی
    let topContrib = [...uArr].sort((a,b) => b.userExp - a.userExp).slice(0,3);
    let topCharm   = [...uArr].sort((a,b) => b.charm - a.charm).slice(0,3);
    let topRoom    = [...rArr].sort((a,b) => b.wealth - a.wealth).slice(0,3);

    renderHomeDPs('home-top-contrib', topContrib, false, "0s");
    renderHomeDPs('home-top-charm', topCharm, false, "1s");
    renderHomeDPs('home-top-room', topRoom, true, "2s");
};
        function renderHomeDPs(elementId, top3Array, isRoom, animDelay) {
            const container = document.getElementById(elementId);
            if(!container) return;
            container.innerHTML = '';
            
            if(top3Array.length === 0) return; 

            let html = '';
            
            // Rank 2 (Left Side)
            if(top3Array[1]) {
                html += `<img src="${getRealAvatar(top3Array[1], isRoom)}" class="home-top-dp dp-rank-2" onerror="this.src='https://placehold.co/100/333/FFF?text=?'">`;
            }
            // Rank 1 (Center - with Animation)
            if(top3Array[0]) {
                html += `<img src="${getRealAvatar(top3Array[0], isRoom)}" class="home-top-dp dp-rank-1" style="animation-delay: ${animDelay};" onerror="this.src='https://placehold.co/100/333/FFF?text=?'">`;
            }
            // Rank 3 (Right Side)
            if(top3Array[2]) {
                html += `<img src="${getRealAvatar(top3Array[2], isRoom)}" class="home-top-dp dp-rank-3" onerror="this.src='https://placehold.co/100/333/FFF?text=?'">`;
            }
            
            container.innerHTML = html;
        }
        // =============== RECHARGE & WALLET LOGIC ===============
        window.openRechargeModal = () => {
            document.getElementById('wallet-balance-display').innerText = (currentCoins || 0).toLocaleString();
            document.getElementById('wallet-diamonds-display').innerText = (currentDiamonds || 0).toLocaleString();
            document.getElementById('recharge-modal').classList.remove('hidden');
            document.getElementById('recharge-modal').classList.add('flex');
        };
        
        window.closeRechargeModal = () => {
            document.getElementById('recharge-modal').classList.add('hidden');
            document.getElementById('recharge-modal').classList.remove('flex');
        };

        window.convertDiamonds = async () => {
            if(!currentUser) return;
            if(currentDiamonds < 100) return Swal.fire({toast:true, icon:'error', title:'Need at least 100 Diamonds to convert!', position:'top', showConfirmButton:false, timer:1500});
            
            currentCoins += currentDiamonds;
            currentDiamonds = 0;
            
            await update(ref(db, `users/${currentUser.uid}`), { coins: currentCoins, diamonds: 0 });
            
            document.getElementById('wallet-balance-display').innerText = currentCoins.toLocaleString();
            document.getElementById('wallet-diamonds-display').innerText = "0";
            if(document.getElementById('game-balance')) document.getElementById('game-balance').innerText = currentCoins.toLocaleString();
            if(document.getElementById('gift-modal-coins')) document.getElementById('gift-modal-coins').innerText = currentCoins.toLocaleString();
            
            Swal.fire({toast:true, icon:'success', title:'Converted to Live Coins!', position:'top', showConfirmButton:false, timer:2000});
        }
        
        window.buyCoins = (pkr, coins) => {
            if(!currentUser) return Swal.fire('Error', 'Please login first', 'error');
            Swal.fire({
                title: 'Confirm Purchase',
                text: `Pay Rs. ${pkr} to get ${coins.toLocaleString()} coins?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Yes, Buy Now',
                cancelButtonText: 'Cancel',
                background: '#111',
                color: '#fff'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    Swal.fire({title: 'Processing...', text: 'Connecting to payment gateway', allowOutsideClick: false, showConfirmButton: false, background: '#111', color: '#fff'});
                    setTimeout(async () => {
                        currentCoins += coins;
                        await update(ref(db, `users/${currentUser.uid}`), { coins: currentCoins });
                        document.getElementById('wallet-balance-display').innerText = currentCoins.toLocaleString();
                        if(document.getElementById('game-balance')) document.getElementById('game-balance').innerText = currentCoins.toLocaleString();
                        if(document.getElementById('gift-modal-coins')) document.getElementById('gift-modal-coins').innerText = currentCoins.toLocaleString();
                        Swal.fire({ icon: 'success', title: 'Purchase Successful!', text: `You received ${coins.toLocaleString()} coins!`, background: '#111', color: '#fff' });
                    }, 1500);
                }
            });
        };

        function initRocketListener(rid) {
            document.getElementById('rocket-trigger-btn').classList.remove('hidden');
            isFirstRocketLoad = true; // جب بھی روم میں جائیں، یہ بتا دے کہ یہ پہلی بار ہے
            onValue(ref(db, `rooms/${rid}/roomExp`), (snap) => { currentRoomExp = snap.val() || 0; updateRocketUI(currentRoomExp); });
        }

        function updateRocketUI(exp) {
            let targetLevel = 0; let targetImg = ROCKET_LEVELS[0].img; let nextThreshold = ROCKET_LEVELS[0].cost; let prevThreshold = 0;
            for (let i = 0; i < ROCKET_LEVELS.length; i++) {
                if (exp >= ROCKET_LEVELS[i].cost) {
                    targetLevel = ROCKET_LEVELS[i].level; targetImg = ROCKET_LEVELS[i].img; prevThreshold = ROCKET_LEVELS[i].cost;
                    if (i < ROCKET_LEVELS.length - 1) { nextThreshold = ROCKET_LEVELS[i+1].cost; } else { nextThreshold = exp * 1.5; }
                }
            }
            
            const triggerImg = document.getElementById('main-rocket-icon'); if (triggerImg) triggerImg.src = targetImg;
            document.getElementById('modal-big-rocket').src = targetImg;
            document.querySelectorAll('.modal-level-btn').forEach(btn => btn.classList.remove('active'));
            if(targetLevel >= 1) document.getElementById('btn-lvl-1').classList.add('active'); 
            if(targetLevel >= 2) document.getElementById('btn-lvl-2').classList.add('active'); 
            if(targetLevel >= 3) document.getElementById('btn-lvl-3').classList.add('active'); 
            if(targetLevel >= 4) document.getElementById('btn-lvl-4').classList.add('active');
            
            let percentage = 0;
            if (targetLevel < 4) { percentage = ((exp - prevThreshold) / (nextThreshold - prevThreshold)) * 100; } else { percentage = 100; }
            percentage = Math.max(0, Math.min(100, percentage));
            document.getElementById('rocket-tube-fill').style.height = `${percentage}%`; document.getElementById('rocket-tube-text').innerText = `${Math.floor(percentage)}%`;

            // FIXED QUEUE LOGIC
            if (isFirstRocketLoad) {
                // اگر پہلی بار روم اوپن کیا ہے تو صرف لیول سیٹ کرو، راکٹ مت اڑاؤ
                lastRocketLevel = targetLevel;
                isFirstRocketLoad = false;
            } else if (targetLevel > lastRocketLevel) {
                // اگر گیم کے دوران کوئی گفٹ کرے تو راکٹ اڑاؤ
                let startLoop = Math.max(1, lastRocketLevel + 1);
                if (lastRocketLevel === 0 && targetLevel > 0) { startLoop = 1; } // جب زیرو سے سیدھا بڑا گفٹ لگے

                for(let lvl = startLoop; lvl <= targetLevel; lvl++) {
                    const rData = ROCKET_LEVELS.find(r => r.level === lvl);
                    if(rData) {
                        rocketQueue.push({ imgSrc: rData.img, targetLevel: lvl, isMaxLevel: (lvl === 4) });
                    }
                }
                processRocketQueue();
            }
            lastRocketLevel = targetLevel;
        }

        function processRocketQueue() {
            if (isRocketFlying || rocketQueue.length === 0) return;
            isRocketFlying = true;
            
            const nextRocket = rocketQueue.shift(); 
            playRocketAnimation(nextRocket.imgSrc, nextRocket.targetLevel, nextRocket.isMaxLevel);
        }

        function playRocketAnimation(imgSrc, targetLevel, isMaxLevel) {
            const layer = document.getElementById('rocket-fly-layer'); 
            layer.style.display = 'flex';
            
            const audio = document.getElementById('rocket-sound');
            audio.currentTime = 0;
            audio.play().catch(e => console.log("Sound play error: ", e));

            let auraClass = 'aura-1';
            if(targetLevel === 2) auraClass = 'aura-2';
            if(targetLevel === 3) auraClass = 'aura-3';
            if(targetLevel === 4) auraClass = 'aura-4';

            layer.innerHTML = `
                <div class="rocket-aura ${auraClass}"></div>
                <div id="rocket-countdown-display" class="rocket-countdown">9</div>
                <img src="${imgSrc}" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3135/3135715.png'" id="active-flying-rocket" class="flying-rocket rocket-rumble" style="opacity: 1;">
            `;
            
            let count = 9; 
            const counterEl = document.getElementById('rocket-countdown-display'); 
            const rocketEl = document.getElementById('active-flying-rocket'); 
            const auraEl = layer.querySelector('.rocket-aura');
            
            // عالمی براڈکاسٹ
            if(typeof broadcastRocketLaunch === "function"){
                broadcastRocketLaunch(currentRoomId, currentRoomData?.roomName || 'A Room', targetLevel, imgSrc);
            }

            const interval = setInterval(() => {
                count--;
                if (count > 0) { 
                    counterEl.innerText = count; 
                } else {
                    clearInterval(interval); 
                    counterEl.style.display = 'none'; 
                    if(auraEl) auraEl.style.display = 'none'; 
                    
                    rocketEl.classList.remove('rocket-rumble'); 
                    rocketEl.classList.add('rocket-launching');
                    
                    for(let i=0; i<30; i++) { 
                        const spark = document.createElement('div'); 
                        spark.className = 'sparkle-effect'; 
                        spark.style.left = (Math.random() * 80 + 10) + '%'; 
                        spark.style.top = (Math.random() * 80 + 10) + '%'; 
                        spark.style.animationDelay = Math.random() + 's'; 
                        layer.appendChild(spark); 
                    }
                    
                    // MAXIMUM LEVEL RESET LOGIC
                    if (isMaxLevel) { 
                        setTimeout(() => { 
                            set(ref(db, `rooms/${currentRoomId}/roomExp`), 0); 
                            push(ref(db, `rooms/${currentRoomId}/messages`), { name: "System", text: "✨ Rocket Cycle Reset! Start again! ✨", type: 'system', timestamp: Date.now() }); 
                        }, 2000); 
                    }
                    
                    setTimeout(() => { 
                        layer.style.display = 'none'; 
                        layer.innerHTML = ''; 
                        
                        isRocketFlying = false;
                        processRocketQueue(); // کیو میں اگلا راکٹ چیک کریں
                    }, 2500);
                }
            }, 1000);
        }

        // ================== GLOBAL ROCKET BROADCAST LOGIC ==================
        // ================== UNIFIED 2-SLOT BROADCAST SYSTEM ==================
        let globalBroadcastQueue =[];
        let slots = {
            slot1: { isBusy: false, el: document.getElementById('broadcast-slot-1') },
            slot2: { isBusy: false, el: document.getElementById('broadcast-slot-2') }
        };

        // 1. Send Game Win
        function broadcastWin(name, amount, dpUrl) {
            push(ref(db, `sys/broadcasts`), { type: 'win', name, amount, dp: dpUrl || 'https://placehold.co/100', time: Date.now() });
        }
        
        // 2. Send Rocket
        function broadcastRocketLaunch(roomId, roomName, level, img) {
            push(ref(db, `sys/broadcasts`), { type: 'rocket', roomId, roomName, level, img, amount: 9999999, time: Date.now() }); // Amount fake high to prioritize
        }

        // 3. Send Gift
        function broadcastGift(senderName, senderDp, receiverName, receiverDp, giftName, img, coins) {
            push(ref(db, `sys/broadcasts`), { type: 'gift', senderName, senderDp, receiverName, receiverDp, giftName, img, amount: coins, time: Date.now() });
        }

        // Listen to all broadcasts
        onChildAdded(ref(db, 'sys/broadcasts'), (snap) => {
            const data = snap.val();
            if(data && (Date.now() - data.time < 30000)) { // 30 seconds expiry
                globalBroadcastQueue.push(data);
                processBroadcastSlots();
            }
        });

        function processBroadcastSlots() {
            // Sort queue so biggest amount wins/gifts show first
            globalBroadcastQueue.sort((a, b) => b.amount - a.amount);

            if (globalBroadcastQueue.length > 0) {
                if (!slots.slot1.isBusy) { playInSlot('slot1', globalBroadcastQueue.shift()); }
                else if (!slots.slot2.isBusy) { playInSlot('slot2', globalBroadcastQueue.shift()); }
            }
        }

        function playInSlot(slotKey, data) {
            if(!data) return;
            const slot = slots[slotKey];
            slot.isBusy = true;
            
            let innerHTML = '';
            
            if (data.type === 'win') {
                innerHTML = `
                <div class="bc-wrapper">
                    <img src="./broadcast_bg.png" class="bc-bg" onerror="this.style.display='none'">
                    <!-- یوزر نیم اب بائیں طرف (Left) آئے گا -->
                    <div class="bc-user-col" style="margin-left: 10px; margin-right: auto;"><img src="${data.dp}" class="bc-dp"><span class="bc-name">${data.name}</span></div>
                    <div class="bc-coins-container"><div class="bc-coins">${data.amount.toLocaleString()} 🪙</div></div>
                    <div style="width: 60px;"></div>
                </div>`;
            } 
            else if (data.type === 'rocket') {
                innerHTML = `
                <div class="rb-wrapper">
                    <img src="${data.img}" class="rb-png">
                    <div class="rb-center-col">
                        <div class="rb-roomname">${data.roomName}</div><div class="text-yellow-400 text-[10px] font-bold">Launched Level ${data.level} Rocket!</div>
                    </div>
                    <button class="rb-go-btn" onclick="window.joinRoom('${data.roomId}')">GO 🚀</button>
                </div>`;
            }
            else if (data.type === 'gift') {
                innerHTML = `
                <div class="gb-wrapper">
                    <div class="gb-user"><img src="${data.senderDp}" class="gb-dp"><span class="gb-name">${data.senderName}</span></div>
                    <div class="gb-center">
                        <span class="gb-action-text">sent to</span>
                        <img src="${data.img}" class="gb-gift-img">
                        <span class="gb-coins">${data.amount.toLocaleString()} 🪙</span>
                    </div>
                    <div class="gb-user"><img src="${data.receiverDp}" class="gb-dp"><span class="gb-name">${data.receiverName}</span></div>
                </div>`;
            }

            slot.el.innerHTML = innerHTML;
            slot.el.classList.remove('bc-hide');
            void slot.el.offsetWidth; // Trigger reflow
            slot.el.classList.add('bc-show');

            // Wait 6 seconds, then hide
            setTimeout(() => {
                slot.el.classList.remove('bc-show');
                slot.el.classList.add('bc-hide');
                
                // Wait for hide animation to finish, then free slot
                setTimeout(() => {
                    slot.isBusy = false;
                    processBroadcastSlots(); // Check queue again
                }, 600);
            }, 6000);
        }

        // ================== TARGETED GIFTING LOGIC ==================
        window.openGiftModal = async () => {
            if(!currentRoomId) return;
            document.getElementById('gift-modal').classList.remove('hidden');
            
            // Popuate gift target array (Owner + Seated users)
            let targets = [];
            
            // Get owner info
            if(currentRoomOwner) {
                let ownerSnap = await get(ref(db, `users/${currentRoomOwner}`));
                let ownerData = ownerSnap.val();
                if(ownerData) {
                    targets.push({ uid: currentRoomOwner, name: "Owner", pic: ownerData.photoURL });
                }
            }

            // Get seated users
            for(let i=1; i<=6; i++) {
                let s = currentRoomSeats[`seat${i}`];
                if(s && s.uid && s.uid !== currentRoomOwner && s.uid !== currentUser.uid) { // Prevent self and duplicate owner
                    targets.push({ uid: s.uid, name: s.name, pic: s.pic });
                }
            }

            // Render Target List
            const listEl = document.getElementById('gift-target-list');
            listEl.innerHTML = '';
            
            if(targets.length > 0) {
                // Default select first person
                selectedGiftTargetUid = targets[0].uid;
                selectedGiftTargetName = targets[0].name;
                document.getElementById('gift-target-name-display').innerText = selectedGiftTargetName;

                targets.forEach(t => {
                    let isSelected = (t.uid === selectedGiftTargetUid) ? 'selected' : '';
                    listEl.innerHTML += `
                        <div class="gift-target-item" onclick="selectGiftTarget('${t.uid}', '${t.name}', this)">
                            <img src="${t.pic}" class="gift-target-avatar ${isSelected}" onerror="this.src='https://placehold.co/100'">
                            <span class="gift-target-name">${t.name}</span>
                        </div>
                    `;
                });
            } else {
                listEl.innerHTML = `<div class="text-xs text-gray-500 w-full text-center py-2">No one to send gifts to.</div>`;
                selectedGiftTargetUid = null;
                document.getElementById('gift-target-name-display').innerText = "None";
            }
        };

        window.selectGiftTarget = (uid, name, el) => {
            selectedGiftTargetUid = uid;
            selectedGiftTargetName = name;
            document.getElementById('gift-target-name-display').innerText = name;
            
            document.querySelectorAll('.gift-target-avatar').forEach(img => img.classList.remove('selected'));
            el.querySelector('.gift-target-avatar').classList.add('selected');
        };

        window.sendGift = async (giftName, cost) => {
            if(!currentRoomId) return;
            if(!selectedGiftTargetUid) return Swal.fire({toast:true, icon:'warning', title:'No user selected!', position:'center', timer:1500, showConfirmButton:false});
            if(currentCoins < cost) return Swal.fire({toast:true, icon:'error', title:'Not enough coins!', position:'center', timer:1500, showConfirmButton:false});

            // --- 5 AM PKT آٹو ریسیٹ سسٹم ---
            let now = new Date();
            let pktTime = new Date(now.getTime() + (5 * 60 * 60 * 1000) + (now.getTimezoneOffset() * 60000));
            if(pktTime.getHours() < 5) pktTime.setDate(pktTime.getDate() - 1); 

            let dateStr = pktTime.toISOString().split('T')[0]; // Daily 
            let weekStr = dateStr.substring(0, 7) + '-W' + Math.ceil(pktTime.getDate() / 7); // Weekly 
            let monthStr = dateStr.substring(0, 7); // Monthly

            // 1. SENDER UPDATE (Contribution)
            const sSnap = await get(ref(db, `users/${currentUser.uid}`));
            let sData = sSnap.val() || {};
            
            let exp_d = (sData.lastGiftDate === dateStr) ? (Number(sData.userExp_daily) || 0) : 0;
            let exp_w = (sData.lastGiftWeek === weekStr) ? (Number(sData.userExp_weekly) || 0) : 0;
            let exp_m = (sData.lastGiftMonth === monthStr) ? (Number(sData.userExp_monthly) || 0) : 0;

            currentCoins -= cost;
            currentUserExp += cost; 

            await update(ref(db, `users/${currentUser.uid}`), { 
                coins: currentCoins, userExp: currentUserExp,
                userExp_daily: exp_d + cost, userExp_weekly: exp_w + cost, userExp_monthly: exp_m + cost,
                lastGiftDate: dateStr, lastGiftWeek: weekStr, lastGiftMonth: monthStr
            });

            if(document.getElementById('gift-modal-coins')) document.getElementById('gift-modal-coins').innerText = currentCoins.toLocaleString();
            document.getElementById('profile-level-text').innerText = `Lv.${getUserLevel(currentUserExp)}`;
            document.getElementById('profile-medal-img').src = getMedalImage(getUserLevel(currentUserExp));

            // 2. RECEIVER UPDATE (Charm)
            const rSnap = await get(ref(db, `users/${selectedGiftTargetUid}`));
            let rData = rSnap.val() || {};
            
            let charm_d = (rData.lastGiftDate === dateStr) ? (Number(rData.charm_daily) || 0) : 0;
            let charm_w = (rData.lastGiftWeek === weekStr) ? (Number(rData.charm_weekly) || 0) : 0;
            let charm_m = (rData.lastGiftMonth === monthStr) ? (Number(rData.charm_monthly) || 0) : 0;

            await update(ref(db, `users/${selectedGiftTargetUid}`), {
                charm: (Number(rData.charm)||0) + cost, diamonds: (Number(rData.diamonds)||0) + (cost*0.3),
                charm_daily: charm_d + cost, charm_weekly: charm_w + cost, charm_monthly: charm_m + cost,
                lastGiftDate: dateStr, lastGiftWeek: weekStr, lastGiftMonth: monthStr
            });

            // 3. ROOM UPDATE (Wealth)
            const rmSnap = await get(ref(db, `rooms/${currentRoomId}`));
            let rmData = rmSnap.val() || {};
            
            let wlt_d = (rmData.lastGiftDate === dateStr) ? (Number(rmData.wealth_daily) || 0) : 0;
            let wlt_w = (rmData.lastGiftWeek === weekStr) ? (Number(rmData.wealth_weekly) || 0) : 0;
            let wlt_m = (rmData.lastGiftMonth === monthStr) ? (Number(rmData.wealth_monthly) || 0) : 0;

            await update(ref(db, `rooms/${currentRoomId}`), {
                roomExp: (Number(rmData.roomExp)||0) + cost, wealth: (Number(rmData.wealth)||0) + cost,
                wealth_daily: wlt_d + cost, wealth_weekly: wlt_w + cost, wealth_monthly: wlt_m + cost,
                lastGiftDate: dateStr, lastGiftWeek: weekStr, lastGiftMonth: monthStr
            });

            // 4. Send Message & Global Broadcast
            let giftImgSrc = document.querySelector(`.gift-item[onclick*="${giftName}"] .gift-img`).src;
            await push(ref(db, `rooms/${currentRoomId}/messages`), { 
                name: currentUser.displayName, text: `Sent ${giftName} 🎁 to ${selectedGiftTargetName}`, 
                type: 'gift', giftName: giftName, timestamp: Date.now() 
            });

            let targetPic = document.querySelector('.gift-target-avatar.selected').src;
            broadcastGift(currentUser.displayName, currentUser.photoURL, selectedGiftTargetName, targetPic, giftName, giftImgSrc, cost);
            
            document.getElementById('gift-modal').classList.add('hidden'); 
            Swal.fire({ toast: true, icon: 'success', title: `${giftName} Sent!`, position: 'bottom', timer: 1500, showConfirmButton: false, background: '#111', color: '#fff' });
        };

        const bannerTrack = document.getElementById('banner-track'); const bannerDots = document.getElementById('banner-dots'); let bannerIndex = 0; let bannerInterval; const totalBanners = 3; 
        for(let i=0; i<totalBanners; i++) { const dot = document.createElement('div'); dot.classList.add('dot'); if(i === 0) dot.classList.add('active'); bannerDots.appendChild(dot); }
        function updateBanner() { bannerTrack.style.transform = `translateX(-${bannerIndex * 100}%)`; const dots = document.querySelectorAll('.dot'); dots.forEach((d, idx) => { if(idx === bannerIndex) d.classList.add('active'); else d.classList.remove('active'); }); }
        function nextBanner() { bannerIndex = (bannerIndex + 1) % totalBanners; updateBanner(); }
        function startAutoBanner() { if(bannerInterval) clearInterval(bannerInterval); bannerInterval = setInterval(nextBanner, 3000); }
        let bannerStartX = 0; const bannerContainer = document.getElementById('main-banner-carousel');
        bannerContainer.addEventListener('touchstart', (e) => { bannerStartX = e.touches[0].clientX; e.stopPropagation(); clearInterval(bannerInterval); }, {passive: false});
        bannerContainer.addEventListener('touchmove', (e) => { e.stopPropagation(); }, {passive: false});
        bannerContainer.addEventListener('touchend', (e) => { e.stopPropagation(); const endX = e.changedTouches[0].clientX; const diff = endX - bannerStartX; if (diff > 50) { bannerIndex = (bannerIndex - 1 + totalBanners) % totalBanners; updateBanner(); } else if (diff < -50) { bannerIndex = (bannerIndex + 1) % totalBanners; updateBanner(); } startAutoBanner(); }, {passive: false});
        startAutoBanner();

        const floatBtn = document.getElementById('floating-room-btn'); let isDragging = false; let dragStartX, dragStartY, btnStartX, btnStartY;
        floatBtn.addEventListener('touchstart', (e) => { isDragging = false; dragStartX = e.touches[0].clientX; dragStartY = e.touches[0].clientY; const rect = floatBtn.getBoundingClientRect(); btnStartX = rect.left; btnStartY = rect.top; }, {passive: false});
        floatBtn.addEventListener('touchmove', (e) => { isDragging = true; e.preventDefault(); const currentX = e.touches[0].clientX; const currentY = e.touches[0].clientY; const deltaX = currentX - dragStartX; const deltaY = currentY - dragStartY; floatBtn.style.left = (btnStartX + deltaX) + 'px'; floatBtn.style.top = (btnStartY + deltaY) + 'px'; floatBtn.style.bottom = 'auto'; floatBtn.style.right = 'auto'; }, {passive: false});
        floatBtn.onclick = (e) => { if(!isDragging) { restoreRoom(); } };

        window.showEmailForm = () => { document.getElementById('email-auth-full-page').classList.add('open'); document.getElementById('auth-form').reset(); isSignup = false; document.getElementById('username-field').classList.add('hidden'); document.getElementById('auth-btn').textContent = "LOGIN"; document.getElementById('auth-switch').textContent = "Create an account"; document.getElementById('email-form-title').textContent = "Email Login"; }
        window.hideEmailForm = () => { document.getElementById('email-auth-full-page').classList.remove('open'); }
        window.loginWithGoogle = async () => { const provider = new GoogleAuthProvider(); try { const result = await signInWithPopup(auth, provider); const user = result.user; const userRef = ref(db, `users/${user.uid}`); const snap = await get(userRef); if(!snap.exists()) { await generateAndSaveId(user.uid, user.displayName, user.email, user.photoURL); } localStorage.setItem('user_logged_in', 'true'); } catch (error) { Swal.fire('Login Error', error.message, 'error'); } };

        let touchStartX = 0; let touchStartY = 0; document.addEventListener('touchstart', e => { if(e.target.closest('.modern-carousel') || e.target.closest('.gift-targets-wrapper')) return; touchStartX = e.changedTouches[0].screenX; touchStartY = e.changedTouches[0].screenY; }, {passive: false}); document.addEventListener('touchend', e => { if(e.target.closest('.modern-carousel') || e.target.closest('.gift-targets-wrapper')) return; let touchEndX = e.changedTouches[0].screenX; let touchEndY = e.changedTouches[0].screenY; handleGesture(touchStartX, touchStartY, touchEndX, touchEndY); }, {passive: false});
        function handleGesture(sX, sY, eX, eY) { const diffX = eX - sX; const diffY = eY - sY; if (Math.abs(diffX) < 50) return; const roomView = document.getElementById('view-room'); const profileView = document.getElementById('view-profile'); const propModal = document.getElementById('prophouse-modal'); const homeView = document.getElementById('view-home'); if (diffX < -50 && Math.abs(diffX) > Math.abs(diffY)) { if (roomView.style.display === 'flex') { window.toggleExitMenu(); return; } if (profileView.style.display === 'flex') { switchTab('view-home', document.getElementById('btn-home')); return; } if (propModal.classList.contains('open')) { closePropHouse(); return; } } if (homeView.style.display === 'flex' && Math.abs(diffX) > Math.abs(diffY)) { let currentIndex = tabs.indexOf(currentHomeTab); if (diffX < -50 && currentIndex < tabs.length - 1) switchHomeTab(tabs[currentIndex + 1]); else if (diffX > 50 && currentIndex > 0) switchHomeTab(tabs[currentIndex - 1]); return; } }

        const homeView = document.getElementById('view-home'); const refreshIndicator = document.getElementById('pull-refresh-indicator'); let homeStartY = 0; homeView.addEventListener('touchstart', (e) => { if (homeView.scrollTop === 0) homeStartY = e.touches[0].pageY; }, {passive: true}); homeView.addEventListener('touchmove', (e) => { if (homeView.scrollTop === 0 && e.touches[0].pageY > homeStartY) refreshIndicator.style.height = `${(e.touches[0].pageY - homeStartY)/2}px`; }, {passive: true}); homeView.addEventListener('touchend', () => { if (parseInt(refreshIndicator.style.height) > 30) { refreshIndicator.style.height = '40px'; refreshHomeRooms(); setTimeout(() => { refreshIndicator.style.height = '0px'; }, 1000); } else { refreshIndicator.style.height = '0px'; } });
        function forceScrollBottom() { const chatArea = document.getElementById('chat-display-area'); if (chatArea) { chatArea.scrollTop = chatArea.scrollHeight; } } window.addEventListener('resize', () => { if(currentRoomId) setTimeout(forceScrollBottom, 100); });
        
        window.toggleAuthMode = () => { isSignup = !isSignup; document.getElementById('username-field').classList.toggle('hidden'); if (isSignup) { document.getElementById('auth-btn').textContent = "CREATE ACCOUNT"; document.getElementById('auth-switch').textContent = "Back to Login"; document.getElementById('email-form-title').textContent = "Create Account"; } else { document.getElementById('auth-btn').textContent = "LOGIN"; document.getElementById('auth-switch').textContent = "Create an account"; document.getElementById('email-form-title').textContent = "Email Login"; } };
        document.getElementById('auth-form').addEventListener('submit', async (e) => { e.preventDefault(); const email = document.getElementById('email').value; const pass = document.getElementById('password').value; try { if(isSignup) { const username = document.getElementById('username').value.trim(); if(!username) return Swal.fire('Error', 'Name required', 'error'); const cred = await createUserWithEmailAndPassword(auth, email, pass); await generateAndSaveId(cred.user.uid, username, email); await updateProfile(cred.user, { displayName: username, photoURL: `https://ui-avatars.com/api/?name=${username}&background=random` }); localStorage.setItem('user_logged_in', 'true'); } else { await signInWithEmailAndPassword(auth, email, pass); localStorage.setItem('user_logged_in', 'true'); } hideEmailForm(); } catch(err) { Swal.fire('Error', err.message, 'error'); } });
        async function generateAndSaveId(uid, username, email, photoURL) { const countRef = ref(db, 'sys/userCount'); const result = await runTransaction(countRef, (current) => (current || 0) + 1); const newId = 10000 + result.snapshot.val(); await set(ref(db, `users/${uid}`), { username: username, email: email, uid: uid, photoURL: photoURL || `https://ui-avatars.com/api/?name=${username}`, customId: newId, bio: "YARAAN User", currentFrame: null, userExp: 0 }); await set(ref(db, `idToUid/${newId}`), uid); return newId; }
        
        onAuthStateChanged(auth, (user) => { currentUser = user; const authView = document.getElementById('view-auth'); if (user) { localStorage.setItem('user_logged_in', 'true'); authView.classList.remove('view-active'); authView.style.display = 'none'; document.getElementById('bottom-nav').classList.remove('hidden'); document.getElementById('bottom-nav').classList.add('flex'); document.getElementById('app-header').style.display = 'flex'; loadData(); switchTab('view-home', document.querySelector('#btn-home')); switchHomeTab('popular'); } else { localStorage.removeItem('lastRoomId'); localStorage.removeItem('user_logged_in'); authView.style.display = 'flex'; authView.classList.add('view-active'); } });
        window.logout = () => { localStorage.removeItem('lastRoomId'); localStorage.removeItem('user_logged_in'); signOut(auth).then(()=> window.location.reload()); };
        window.switchHomeTab = (tabName) => { currentHomeTab = tabName; document.querySelectorAll('.home-tab').forEach(t => t.classList.remove('active')); document.getElementById(`tab-${tabName}`).classList.add('active'); refreshHomeRooms(); }

        window.refreshHomeRooms = async () => {
            if(!currentUser) return; const homeList = document.getElementById('home-room-list'); homeList.innerHTML = '<p class="text-center text-gray-400 text-xs mt-4 col-span-2">Loading...</p>'; const roomsSnap = await get(ref(db, 'rooms')); if(!roomsSnap.exists()) { homeList.innerHTML = `<p class="text-gray-400 text-center mt-10 text-sm col-span-2">No live rooms found.</p>`; return; } const friendsSnap = await get(ref(db, `users/${currentUser.uid}/friends`)); const friendIds = friendsSnap.exists() ? Object.keys(friendsSnap.val()) : []; let history = JSON.parse(localStorage.getItem('room_history') || '[]'); homeList.innerHTML = ''; let hasLive = false; const promises = [];
            roomsSnap.forEach(r => { const d = r.val(); const roomId = r.key; const isOwnerPresent = d.activeUsers && Object.keys(d.activeUsers).includes(d.owner); if (d.isLocked === true) return; if (d.isLive === true && isOwnerPresent) { let shouldShow = false; if (currentHomeTab === 'following') { if (friendIds.includes(d.owner) || d.owner === currentUser.uid) shouldShow = true; } else if (currentHomeTab === 'popular') shouldShow = true; else if (currentHomeTab === 'recent') { if (history.includes(roomId)) shouldShow = true; } if (shouldShow) { hasLive = true; const p = get(ref(db, `users/${d.owner}`)).then(uSnap => { const uData = uSnap.exists() ? uSnap.val() : {}; return { ...d, id: roomId, gender: uData.gender || 'male', nameColorClass: uData.nameColorClass || '' }; }); promises.push(p); } } }); 
            const results = await Promise.all(promises);
            results.forEach(d => { 
                const roomNameDisplay = d.roomName || (d.ownerName + "'s Room"); 
                const roomCoverDisplay = d.roomCover || `https://ui-avatars.com/api/?name=${roomNameDisplay}&background=random&size=200`; 
                const genderIcon = d.gender === 'female' ? './female.png' : './male.png'; 
                const userCount = d.activeUsers ? Object.keys(d.activeUsers).length : 0; 
                
                // === HOME CARD ROCKET INDICATOR LOGIC ===
                let rExp = d.roomExp || 0;
                let nextRocket = './rocket1.png';
                let rLvl = 1;
                if(rExp >= 2000000) { nextRocket = './rocket4.png'; rLvl = 4; }
                else if(rExp >= 500000) { nextRocket = './rocket3.png'; rLvl = 3; }
                else if(rExp >= 300000) { nextRocket = './rocket2.png'; rLvl = 2; }
                
                let rocketTagHTML = `<div class="room-target-tag"><img src="${nextRocket}" onerror="this.style.display='none'"><span>Lv.${rLvl}</span></div>`;

                homeList.innerHTML += `<div onclick="joinRoom('${d.id}')" class="room-card-wrapper cursor-pointer">
                    <div class="room-card-new">
                        <img src="${roomCoverDisplay}" class="room-card-cover" onerror="this.src='https://placehold.co/200x200?text=Room'">
                        <div class="room-live-tag"><span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span> LIVE</div>
                        ${rocketTagHTML}
                        <div class="room-user-badge"><i class="fa-solid fa-user text-[8px]"></i><span>${userCount}</span></div>
                        <div class="room-card-overlay"><div class="room-card-title">${roomNameDisplay}</div></div>
                    </div>
                    <div class="room-info-bottom"><img src="${genderIcon}" class="room-gender-icon"><div class="room-owner-name ${d.nameColorClass}">${d.ownerName}</div></div>
                </div>`; 
            });
            if(!hasLive) homeList.innerHTML = `<p class="text-gray-400 text-center mt-10 text-sm col-span-2">No live rooms.</p>`;
        }

        async function loadData() {
            const mySnap = await get(ref(db, `users/${currentUser.uid}`)); 
            if(mySnap.exists()) { 
                const d = mySnap.val(); 
                if (!d.customId || d.customId > 900000000) { 
                    await generateAndSaveId(currentUser.uid, d.username, d.email, d.photoURL); 
                } else { 
                    document.getElementById('profile-id').innerText = d.customId; 
                } 
                let nameEl = document.getElementById('profile-name');
                nameEl.innerHTML = `<span class="${d.nameColorClass || 'text-gray-900'}">${d.username}</span> <img id="profile-v-badge" src="./v_badge.png" class="v-badge-profile hidden" onerror="this.style.display='none'">`; 
                document.getElementById('profile-bio').innerText = d.bio || ""; 
                const container = document.getElementById('profile-visual-container'); 
                let html = `<div class="visual-root"><img src="${d.photoURL}" class="visual-img">`; 
                if(d.currentFrame) html += `<img src="${d.currentFrame}" class="visual-frame">`; 
                html += `</div>`; 
                container.innerHTML = html; 
                document.getElementById('edit-preview-visual').innerHTML = html; 
                selectedGender = d.gender || null; 
                updateGenderUI(d.lastGenderChange);
                
                currentCoins = d.coins || 50000; 
                currentDiamonds = d.diamonds || 0; 
                currentUserExp = d.userExp || 0; 

                document.getElementById('profile-level-text').innerText = `Lv.${getUserLevel(currentUserExp)}`;
                document.getElementById('profile-medal-img').src = getMedalImage(getUserLevel(currentUserExp));

                if(document.getElementById('game-balance')) { document.getElementById('game-balance').innerText = currentCoins.toLocaleString(); }
                if(document.getElementById('gift-modal-coins')) { document.getElementById('gift-modal-coins').innerText = currentCoins.toLocaleString(); }
                
                // --- ONLINE STATUS TRACKER (آن لائن / آف لائن سسٹم) ---
                const connectedRef = ref(db, '.info/connected');
                onValue(connectedRef, (snap) => {
                    if (snap.val() === true) {
                        const statusRef = ref(db, `users/${currentUser.uid}/status`);
                        set(statusRef, 'online');
                        onDisconnect(statusRef).set('offline'); // نیٹ بند ہونے پر آف لائن
                    }
                });

                // --- OFFICIAL / SUPER ADMIN LOGIC ---
                window.currentUserIsOfficial = d.isOfficial || false;
                window.SUPER_ADMIN_ID = 10005; 
                
                let adminBtn = document.getElementById('btn-super-admin');
                let vBadgeName = document.getElementById('profile-v-badge'); // نام کے آگے والا
                let vBadgeProfile = document.getElementById('profile-verify-official'); // لیول کے سامنے والا بڑا بیج

                if(d.customId === window.SUPER_ADMIN_ID || window.currentUserIsOfficial) {
                    if(adminBtn) adminBtn.classList.remove('hidden');
                    if(vBadgeName) vBadgeName.classList.remove('hidden');
                    if(vBadgeProfile) vBadgeProfile.classList.remove('hidden'); // نیا بیج شو کریں
                    
                    if(!d.currentFrame) {
                        update(ref(db, `users/${currentUser.uid}`), { currentFrame: './frame_official.png' });
                    }
                } else {
                    if(adminBtn) adminBtn.classList.add('hidden');
                    if(vBadgeName) vBadgeName.classList.add('hidden');
                    if(vBadgeProfile) vBadgeProfile.classList.add('hidden'); // نیا بیج چھپائیں
                }
                
                if(d.isBanned) {
                    Swal.fire({icon:'error', title:'Account Banned', text:'Your account has been banned by YARAAN Official.', allowOutsideClick: false, showConfirmButton: false});
                    setTimeout(() => window.logout(), 3000);
                }
            }
            updateHomeTopDPs();
            
            onValue(ref(db, `users/${currentUser.uid}/friends`), async (snap) => { 
                const chatList = document.getElementById('friends-chat-list'); 
                chatList.innerHTML = ''; let count = 0; 
                if(snap.exists()) { 
                    count = Object.keys(snap.val()).length; 
                    for (const [uid, name] of Object.entries(snap.val())) { 
                        const fSnap = await get(ref(db, `users/${uid}`)); 
                        const fData = fSnap.val() || {}; 
                        const pic = fData.photoURL || `https://ui-avatars.com/api/?name=${name}`; 
                        chatList.innerHTML += `<div onclick="openDirectChat('${uid}', '${name}')" class="bg-white p-3 rounded flex items-center justify-between cursor-pointer border border-gray-200 shadow-sm hover:shadow-md transition"><div class="flex items-center gap-3"><img src="${pic}" class="w-10 h-10 rounded-full border border-gray-300 object-cover"><span class="text-gray-900 text-sm font-medium">${name}</span></div></div>`; 
                    } 
                } 
                document.getElementById('stat-following').innerText = count; 
                document.getElementById('stat-fans').innerText = count; 
                refreshHomeRooms(); 
            });

            onValue(ref(db, `users/${currentUser.uid}/inbox`), snap => { 
                const list = document.getElementById('inbox-list'); 
                const badge = document.getElementById('inbox-dot'); 
                list.innerHTML = ''; let count = 0; 
                if(snap.exists()) { 
                    const data = snap.val(); 
                    if(data.requests) Object.entries(data.requests).forEach(([key, val]) => { count++; list.innerHTML += inboxItem(key, val, 'req'); }); 
                    if(data.invites) Object.entries(data.invites).forEach(([key, val]) => { count++; list.innerHTML += inboxItem(key, val, 'inv'); }); 
                    if(data.system) Object.entries(data.system).forEach(([key, val]) => { count++; list.innerHTML += inboxItem(key, val, 'sys'); }); 
                } 
                if(count > 0) badge.classList.remove('hidden'); else badge.classList.add('hidden'); 
            });
        }

        function inboxItem(key, val, type) { 
            if(type === 'req') return `<div class="bg-white border border-gray-200 shadow-sm p-2 rounded flex justify-between items-center mb-1"><span class="text-xs text-gray-800 font-medium">Followed you: ${val.fromName}</span><div class="flex gap-2"><button onclick="acceptFriend('${val.fromUid}', '${val.fromName}')" class="text-blue-600 text-xs font-bold border border-blue-600 px-2 py-1 rounded hover:bg-blue-50">FOLLOW BACK</button><button onclick="delNotif('requests/${key}')" class="text-red-500"><i class="fa-solid fa-xmark"></i></button></div></div>`; 
            if(type === 'sys') return `<div class="bg-red-50 border border-red-200 shadow-sm p-3 rounded flex items-center gap-3 mb-2 relative overflow-hidden"><div class="absolute top-0 left-0 w-1 h-full bg-red-600"></div><img src="${val.icon || './yaraan_dp.png'}" class="w-10 h-10 rounded-full border border-red-500 object-cover bg-white"><div class="flex-1"><h4 class="text-red-600 font-bold text-xs flex items-center">${val.fromName} <img src="./v_badge.png" class="w-3 h-3 ml-1" onerror="this.style.display='none'"></h4><p class="text-[10px] text-gray-700 font-medium leading-tight mt-0.5">${val.message}</p></div><button onclick="delNotif('system/${key}')" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-trash text-sm"></i></button></div>`;
            return `<div class="bg-white border border-gray-200 shadow-sm p-2 rounded flex justify-between items-center mb-1"><span class="text-xs text-gray-800 font-medium">Invite: ${val.fromName}</span><div class="flex gap-2"><button onclick="joinRoom('${val.roomId}')" class="text-blue-600 font-bold hover:underline">JOIN</button><button onclick="delNotif('invites/${key}')" class="text-red-500"><i class="fa-solid fa-xmark"></i></button></div></div>`; 
        }

        window.triggerCreateRoom = async () => { const roomSnap = await get(ref(db, `rooms/${currentUser.uid}`)); if(roomSnap.exists()) { joinRoom(currentUser.uid); } else { document.getElementById('cr-name').value = ""; document.getElementById('cr-cover').value = ""; document.getElementById('cr-preview').src = 'https://placehold.co/200x200?text=Cover'; document.getElementById('create-room-view').classList.add('open'); } };
        window.closeCreateRoom = () => { document.getElementById('create-room-view').classList.remove('open'); }
        window.finalizeCreateRoom = async () => { const rName = document.getElementById('cr-name').value; const rCover = document.getElementById('cr-cover').value; if(!rName) return Swal.fire('Error', 'Room Name is required', 'error'); const myId = document.getElementById('profile-id').innerText; await update(ref(db, `rooms/${currentUser.uid}`), { owner: currentUser.uid, ownerName: currentUser.displayName, ownerCustomId: myId, active: true, isLive: true, roomName: rName, roomCover: rCover || null }); closeCreateRoom(); joinRoom(currentUser.uid); }
        window.openRoomSettings = async () => { if(!currentRoomId || currentRoomId !== currentUser.uid) { return Swal.fire('Access Denied', 'Only owner can change settings', 'warning'); } const snap = await get(ref(db, `rooms/${currentRoomId}`)); const d = snap.val(); document.getElementById('rs-name').value = d.roomName || ''; document.getElementById('rs-cover').value = d.roomCover || ''; document.getElementById('rs-lock').checked = d.isLocked || false; document.getElementById('room-settings-modal').classList.add('open'); }
        window.closeRoomSettings = () => document.getElementById('room-settings-modal').classList.remove('open');
        window.saveRoomSettings = async () => { const n = document.getElementById('rs-name').value; const c = document.getElementById('rs-cover').value; const l = document.getElementById('rs-lock').checked; await update(ref(db, `rooms/${currentRoomId}`), { roomName: n, roomCover: c, isLocked: l }); document.getElementById('room-header-name').innerText = n; if(c) document.getElementById('room-header-cover').src = c; closeRoomSettings(); }
        window.openThemeModal = () => { closeRoomSettings(); document.getElementById('theme-modal').classList.add('open'); }
        window.closeThemeModal = () => document.getElementById('theme-modal').classList.remove('open');
        window.applyTheme = async (themeName) => { if(!currentRoomId || currentRoomId !== currentUser.uid) return; await update(ref(db, `rooms/${currentRoomId}`), { theme: themeName }); Swal.fire({toast:true, icon:'success', title:'Theme Applied', position:'top', timer:1500, showConfirmButton:false}); closeThemeModal(); }
        window.removeTheme = async () => { if(!currentRoomId || currentRoomId !== currentUser.uid) return; await update(ref(db, `rooms/${currentRoomId}`), { theme: null }); Swal.fire({toast:true, icon:'info', title:'Theme Removed', position:'top', timer:1500, showConfirmButton:false}); closeThemeModal(); }

        window.handleGuestTap = () => { };
        window.playDirectVideo = () => { const input = document.getElementById('direct-yt-link'); const val = input.value.trim(); if(!val) return; let videoId = ''; const ytRegExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/; const match = val.match(ytRegExp); if (match && match[2].length == 11) { videoId = match[2]; } else if(val.includes('shorts/')) { const parts = val.split('shorts/'); if(parts[1]) videoId = parts[1].split('?')[0]; } if(videoId && videoId.length > 5) { playVideoById(videoId); input.value = ""; } else { Swal.fire({toast:true, icon:'error', title:'Invalid YouTube Link', position:'top'}); } };
        function playVideoById(id) { set(ref(db, `rooms/${currentRoomId}/videoId`), {type:'yt', id:id, timestamp: Date.now()}); push(ref(db, `rooms/${currentRoomId}/messages`), { name: "System", text: `${currentUser.displayName} started a video.`, type: 'system', timestamp: Date.now() }); }

        window.joinRoom = async (rid) => { 
            let history = JSON.parse(localStorage.getItem('room_history') || '[]'); history = history.filter(id => id !== rid); history.unshift(rid); if(history.length > 20) history.pop(); localStorage.setItem('room_history', JSON.stringify(history)); localStorage.setItem('lastRoomId', rid);
            const kickSnap = await get(ref(db, `rooms/${rid}/kicked/${currentUser.uid}`)); if (kickSnap.exists()) { if (Date.now() - kickSnap.val() < 20 * 60 * 1000) { localStorage.removeItem('lastRoomId'); return Swal.fire('Banned', 'Kicked from room.', 'error'); } } 
            currentRoomId = rid; currentUserJoinTime = Date.now(); 
            get(ref(db, `rooms/${rid}`)).then(snap => { 
                currentRoomData = snap.val(); currentRoomOwner = currentRoomData.owner; const rCover = currentRoomData.roomCover || `https://ui-avatars.com/api/?name=${currentRoomData.roomName}`; document.getElementById('room-header-cover').src = rCover; document.getElementById('room-header-name').innerText = currentRoomData.roomName; document.getElementById('room-header-id').innerText = currentRoomData.ownerCustomId || '...'; document.getElementById('guest-touch-blocker').style.display = 'none'; document.getElementById('empty-state-trigger').style.display = 'flex'; 
                const theme = currentRoomData.theme; const area = document.getElementById('room-lower-half'); const videoBg = document.getElementById('theme-video-bg');
                if(theme) { if(theme.endsWith('.mp4')) { area.style.backgroundImage = 'none'; videoBg.src = `./${theme}`; videoBg.classList.remove('hidden'); videoBg.play().catch(e => console.log("Auto-play prevented")); } else { videoBg.classList.add('hidden'); videoBg.pause(); area.style.backgroundImage = `url('./${theme}')`; } } else { area.style.backgroundImage = 'none'; videoBg.classList.add('hidden'); videoBg.pause(); }
                if(rid === currentUser.uid) { update(ref(db, `rooms/${rid}`), { isLive: true }); onDisconnect(ref(db, `rooms/${rid}/isLive`)).set(false); } 
            }); 
            onValue(ref(db, `rooms/${rid}/kicked/${currentUser.uid}`), (s) => { if(s.exists() && currentRoomId === rid) { leaveRoomFull(); Swal.fire('Kicked', 'Removed by host.', 'warning'); } }); 
            switchTab('view-room'); 
            initRocketListener(rid);
            const userRef = ref(db, `rooms/${rid}/activeUsers/${currentUser.uid}`); set(userRef, currentUser.displayName); onDisconnect(userRef).remove();
            onValue(ref(db, `rooms/${rid}/activeUsers`), (snap) => { const count = snap.exists() ? Object.keys(snap.val()).length : 0; document.getElementById('room-user-count').innerText = count; });
            // یوزر کا کرنٹ EXP ڈیٹا بیس میں میسج کے ساتھ بھیجیں تاکہ انٹری اینیمیشن بن سکے
push(ref(db, `rooms/${rid}/messages`), { 
    name: currentUser.displayName, 
    uid: currentUser.uid,  // 🟢 یہ شامل کریں
    type: 'entry', 
    userExp: currentUserExp || 0,
    nameColorClass: currentRoomSeats.nameColorClass || null,
    timestamp: Date.now() 
});
            onValue(ref(db, `rooms/${rid}/theme`), s => { const t = s.val(); const area = document.getElementById('room-lower-half'); const videoBg = document.getElementById('theme-video-bg'); if(t) { if(t.endsWith('.mp4')) { area.style.backgroundImage = 'none'; videoBg.src = `./${t}`; videoBg.classList.remove('hidden'); videoBg.play().catch(e => console.log("Playback error", e)); } else { videoBg.classList.add('hidden'); videoBg.pause(); area.style.backgroundImage = `url('./${t}')`; } } else { area.style.backgroundImage = 'none'; videoBg.classList.add('hidden'); videoBg.pause(); } });
            const rr = ref(db, `rooms/${rid}`);
            onValue(child(rr, 'videoId'), s => { const v=s.val(); const iframe=document.getElementById('video-iframe'); const trigger=document.getElementById('empty-state-trigger'); const local=document.getElementById('local-video-player'); local.classList.add('hidden'); if(v) { trigger.style.display = 'none'; iframe.classList.remove('hidden'); if(v.type === 'yt') { const origin = window.location.origin; const embedUrl = `https://www.youtube.com/embed/${v.id}?autoplay=1&mute=0&controls=1&playsinline=1&showinfo=0&rel=0&iv_load_policy=3&modestbranding=1&enablejsapi=1&origin=${origin}&widget_referrer=${origin}`; if(iframe.src !== embedUrl) iframe.src = embedUrl; } } else { trigger.style.display = 'flex'; iframe.classList.add('hidden'); iframe.src=""; } }); 
            onValue(child(rr, 'seats'), s => { currentRoomSeats = s.val() || {}; updateSeat('seat1', currentRoomSeats.seat1, "UMAR"); updateSeat('seat2', currentRoomSeats.seat2, "GURIYA"); updateSeat('seat3', currentRoomSeats.seat3, "1"); updateSeat('seat4', currentRoomSeats.seat4, "2"); updateSeat('seat5', currentRoomSeats.seat5, "3"); updateSeat('seat6', currentRoomSeats.seat6, "4"); const hc = document.getElementById('heartbeat-container'); const seat1Occupied = currentRoomSeats.seat1 && currentRoomSeats.seat1.uid; const seat2Occupied = currentRoomSeats.seat2 && currentRoomSeats.seat2.uid; if(seat1Occupied && seat2Occupied) { hc.classList.add('heartbeat-active'); } else { hc.classList.remove('heartbeat-active'); } document.querySelectorAll('.action-menu-overlay').forEach(b => b.style.display = 'none'); }); 
            // MP4 Video Mapping (اپنے فولڈر میں ان ناموں سے ویڈیوز رکھ لیں)
            const giftVideos = {
                'Rose': './rose.mp4',
                'Ring': './ring.mp4',
                'Car': './car.mp4',
                'Rocket': './rocket_gift.mp4',
                'Crown': './crown.mp4',
                'Castle': './castle.mp4',
                'Yacht': './yacht.mp4',
                'Dragon': './dragon.mp4'
            };

            onValue(child(rr, 'messages'), s => { 
                const chatArea = document.getElementById('chat-display-area'); 
                chatArea.innerHTML = ''; 
                if(s.exists()) { 
                    Object.values(s.val()).forEach(m => { 
                        if(m.timestamp > currentUserJoinTime) { 
                            
                            // لیول بیج بنانا (اگر EXP موجود ہو)
                            let levelBadgeHtml = m.userExp !== undefined ? renderLevelHTML(m.userExp).replace('class="user-level-badge"', 'class="user-level-badge" style="transform: scale(0.85); transform-origin: left center;"') : '';
                            let colorClass = (m.nameColorClass && m.nameColorClass !== "") ? m.nameColorClass : 'text-yellow-400';

                            if(m.type === 'system') { 
                                chatArea.innerHTML += `<div class="chat-system-msg">${m.text}</div>`; 
                            } 
 else if (m.type === 'entry') {
    // 🟢 اب صرف Welcome Name دکھے گا
    let colorClass = (m.nameColorClass && m.nameColorClass !== "") ? m.nameColorClass : 'text-yellow-400';
    
    // 🟢 نام پر کلک کرنے سے پروفائل کھلے گا (اگر uid ہو)
    let nameHtml = m.uid 
        ? `<span onclick="viewFriendProfile('${m.uid}')" class="font-extrabold ${colorClass} cursor-pointer hover:underline">${m.name}</span>`
        : `<span class="font-extrabold ${colorClass}">${m.name}</span>`;

    chatArea.innerHTML += `
    <div class="chat-system-msg">
        Welcome ${nameHtml}
    </div>`;
}
                            else if (m.type === 'gift') {
    let giftColorClass = (m.nameColorClass && m.nameColorClass !== "") ? m.nameColorClass : 'text-yellow-400';
    chatArea.innerHTML += `<div class="chat-message-bubble">${levelBadgeHtml} <b class="${giftColorClass}">${m.name}:</b> <span class="text-white">${m.text}</span></div>`; 
}
                        else { 
    // 🟢 FIXED: nameColorClass اب یہاں بھی استعمال ہوگا
    let msgColorClass = (m.nameColorClass && m.nameColorClass !== "") ? m.nameColorClass : 'text-yellow-400';
    chatArea.innerHTML += `<div class="chat-message-bubble mb-1 items-center">${levelBadgeHtml}<span class="font-black ${msgColorClass}">${m.name}</span><span class="text-white font-bold mx-0.5">:</span> <span class="text-white">${m.text}</span></div>`; 
}
                            // گفٹ اینیمیشن (8 سیکنڈ ٹائمر کے ساتھ)
                            if(m.type === 'gift' && m.giftName && (Date.now() - m.timestamp < 3000)) {
                                let videoSrc = giftVideos[m.giftName];
                                if(videoSrc) {
                                    let containerEl = document.getElementById('gift-animation-container');
                                    let vidEl = document.getElementById('gift-animation-player');
                                    let textEl = document.getElementById('gift-animation-text');
                                    
                                    if(containerEl && containerEl.classList.contains('hidden')) {
                                        vidEl.src = videoSrc;
                                        textEl.innerHTML = `${m.name} sent <br><span class="text-yellow-400 text-4xl">${m.giftName}</span>!`;
                                        containerEl.classList.remove('hidden');
                                        containerEl.style.display = 'flex';
                                        vidEl.play().catch(e => console.log("Video auto-play prevented:", e));
                                        
                                        setTimeout(() => {
                                            containerEl.classList.add('hidden');
                                            containerEl.style.display = 'none';
                                            vidEl.pause();
                                            vidEl.currentTime = 0; 
                                        }, 8000);
                                    }
                                }
                            }
                        } 
                    }); 
                    setTimeout(forceScrollBottom, 100); 
                } 
            });
         
        };

        window.updateSeat = (seatId, data, defaultName) => { 
    const visualDiv = document.getElementById(`${seatId}-visual`); 
    const nameSpan = document.getElementById(`${seatId}-name`); 
    const container = document.getElementById(`cont-${seatId}`); 
    if (!visualDiv || !nameSpan || !container) return; 
    
    container.classList.remove('seat-occupied', 'seat-locked', 'has-frame'); 
    const oldBadge = container.querySelector('.seat-mute-badge'); if(oldBadge) oldBadge.remove(); 
    const oldVBadge = container.querySelector('.v-badge-mic'); if(oldVBadge) oldVBadge.remove();
    
    container.style.border = "2px solid #333"; 
    
    if (data && data.locked) { 
        visualDiv.innerHTML = `<div class="visual-root"><i class="fa-solid fa-lock text-red-500 text-xl" style="filter:drop-shadow(0 0 5px black);"></i></div>`; 
        container.classList.add('seat-locked'); 
        nameSpan.innerText = "Locked"; 
        nameSpan.className = "seat-name text-red-500"; 
    } else if (data && data.uid) { 
        container.classList.add('seat-occupied'); 
        let html = `<div class="visual-root">`; 
        html += `<img src="${data.pic || 'https://placehold.co/100'}" class="visual-img" onerror="this.src='https://placehold.co/100?text=U'">`; 
        if (data.frame) { 
            html += `<img src="${data.frame}" class="visual-frame">`; 
            container.classList.add('has-frame'); 
        } else { 
            container.style.border = "2px solid #22c55e"; 
        } 
        html += `</div>`; 
        visualDiv.innerHTML = html; 
        
        nameSpan.innerText = data.name || defaultName; 
        
        // 🟢 VIP Colorful Name کے لیے
        if (data.nameColorClass && data.nameColorClass !== "") {
            nameSpan.className = `seat-name occupied ${data.nameColorClass}`;
        } else {
            nameSpan.className = "seat-name occupied text-white";
        }
        
        if (data.uid === currentUser?.uid && isMicMuted) { 
            const badge = document.createElement('div'); 
            badge.className = 'seat-mute-badge'; 
            badge.innerHTML = '<i class="fa-solid fa-microphone-slash"></i>'; 
            container.appendChild(badge); 
        }
        if (data.isOfficial) {
            const vbadge = document.createElement('img');
            vbadge.src = './v_badge.png'; 
            vbadge.className = 'v-badge-mic';
            vbadge.onerror = function() { this.style.display='none'; };
            container.appendChild(vbadge);
        }
    } else { 
        // 🟢 FIXED: سیٹ خالی ہے تو ڈیفالٹ نام (یہی وہ جگہ ہے جہاں مسئلہ تھا)
        visualDiv.innerHTML = ''; 
        nameSpan.innerText = defaultName; 
        nameSpan.className = "seat-name";  // صرف seat-name کلاس، کوئی اور نہیں
    } 
};

        window.hideAllMicMenus = (e) => { if (!e.target.closest('.mic-container') && !e.target.closest('.mic-container-sm')) { document.querySelectorAll('.action-menu-overlay').forEach(b => b.style.display = 'none'); } };
        window.toggleMicMenu = (seatId, defName, event) => { 
            event.stopPropagation(); 
            document.querySelectorAll('.action-menu-overlay').forEach(b => b.style.display = 'none'); 
            const menu = document.getElementById(`menu-${seatId}`); 
            const seatData = currentRoomSeats[seatId]; 
            const amIOwner = currentUser.uid === currentRoomOwner; 
            const amISitting = seatData && seatData.uid === currentUser.uid; 
            menu.innerHTML = ''; menu.style.display = 'flex'; 
            
            if (amISitting) { menu.innerHTML = `<div class="btn-action btn-red" onclick="leaveSeat('${seatId}')">LEAVE</div>`; return; } 
            if (seatData && seatData.locked) { 
                if (amIOwner) { menu.innerHTML = `<div class="btn-action btn-yellow" onclick="toggleLock('${seatId}', false)">UNLOCK</div>`; } 
                else { menu.innerHTML = `<div class="text-white text-xs p-2">LOCKED</div>`; } 
                return; 
            } 
            if (seatData && seatData.uid) { 
                let html = `<div class="btn-action btn-blue" onclick="viewFriendProfile('${seatData.uid}')">PROFILE</div>`;
                if (amIOwner) { 
                    html += `<div class="btn-action btn-yellow" onclick="unseatUser('${seatId}')">UNSEAT</div><div class="btn-action btn-red" onclick="kickUserFromRoom('${seatId}', '${seatData.uid}')">KICK</div>`; 
                } 
                menu.innerHTML = html;
                return; 
            } 
            if (!seatData || !seatData.uid) { 
                let html = `<div class="btn-action btn-green" onclick="sitDown('${seatId}', '${defName}')">SIT</div>`; 
                if (amIOwner) { html += `<div class="btn-action btn-blue" onclick="toggleLock('${seatId}', true)">LOCK</div>`; } 
                menu.innerHTML = html; 
            } 
        };
        window.leaveSeat = async (sid) => { const seatRef = ref(db, `rooms/${currentRoomId}/seats/${sid}`); onDisconnect(seatRef).cancel(); await remove(seatRef); document.getElementById(`menu-${sid}`).style.display = 'none'; };
        window.unseatUser = async (sid) => { await remove(ref(db, `rooms/${currentRoomId}/seats/${sid}`)); document.getElementById(`menu-${sid}`).style.display = 'none'; }; 
        window.kickUserFromRoom = async (sid, targetUid) => { await remove(ref(db, `rooms/${currentRoomId}/seats/${sid}`)); await set(ref(db, `rooms/${currentRoomId}/kicked/${targetUid}`), Date.now()); document.getElementById(`menu-${sid}`).style.display = 'none'; };
        window.toggleLock = async (sid, state) => { if(state) { await set(ref(db, `rooms/${currentRoomId}/seats/${sid}`), { locked: true }); } else { await remove(ref(db, `rooms/${currentRoomId}/seats/${sid}`)); } document.getElementById(`menu-${sid}`).style.display = 'none'; };
        window.sitDown = async (sid, def) => { 
    const sr=ref(db, `rooms/${currentRoomId}/seats`); const s=currentRoomSeats; 
    if(s[sid] && (s[sid].locked || s[sid].uid)) return; 
    let unseatUpdates={};['seat1','seat2','seat3','seat4','seat5','seat6'].forEach(k => { if(s[k] && s[k].uid === currentUser.uid) unseatUpdates[k]=null; }); 
    const userSnap = await get(ref(db, `users/${currentUser.uid}`)); 
    const userData = userSnap.val(); 
    const mySeatData = { 
    uid: currentUser.uid, 
    name: currentUser.displayName, 
    pic: currentUser.photoURL, 
    frame: userData.currentFrame || null,
    isOfficial: userData.isOfficial || false,
    nameColorClass: userData.nameColorClass || null // 🟢 یہ بالکل درست ہے
};
    const targetSeatRef = child(sr, sid); 
    await update(sr, unseatUpdates); 
    await set(targetSeatRef, mySeatData); 
    onDisconnect(targetSeatRef).remove(); 
    document.getElementById(`menu-${sid}`).style.display = 'none'; 
};
        window.openPropHouse = async () => { 
    const grid = document.getElementById('frame-grid'); 
    grid.innerHTML = ''; 
    const snap = await get(ref(db, `users/${currentUser.uid}`)); 
    const userData = snap.val() || {};
    const currentEquipped = userData.currentFrame; 
    const currentNameClass = userData.nameColorClass || '';
    
    // --- VIP NAME ITEMS LOGIC ---
    if (userData.unlockedVIPs) {
        const vipList =[
            { key: 'name-vip-green', title: 'VIP 3 (Green)', color: '#22c55e', img: './vip_green.png' },
            { key: 'name-vip-yellow', title: 'VIP 5 (Yellow)', color: '#facc15', img: './vip_yellow.png' },
            { key: 'name-vip-pink', title: 'VIP 7 (Pink)', color: '#ec4899', img: './vip_pink.png' },
            { key: 'name-vip-colorful', title: 'VIP 9 (Shiny)', color: '#a855f7', img: './vip_colorful.png' }
        ];

        vipList.forEach(vip => {
            if (userData.unlockedVIPs[vip.key]) {
                const isEquipped = (currentNameClass === vip.key); 
                const btnText = isEquipped ? "REMOVE" : "USE VIP"; 
                const btnClass = isEquipped ? "bg-gray-600 hover:bg-gray-700" : "bg-blue-600 hover:bg-blue-700"; 
                const btnAction = isEquipped ? "removeVIPName()" : `applyVIPName('${vip.key}')`; 
                
                grid.innerHTML += `
                <div class="frame-card" style="border: 2px solid ${vip.color}; box-shadow: 0 0 10px ${vip.color}50;">
                    <div class="frame-preview-box">
                        <img src="${vip.img}" class="w-14 h-14 object-contain" onerror="this.src='https://placehold.co/100x100?text=VIP'">
                    </div>
                    <span class="text-xs font-bold mb-2 ${vip.key}">${vip.title}</span>
                    <button onclick="${btnAction}" class="w-full ${btnClass} text-white font-bold text-xs py-1 rounded transition">${btnText}</button>
                </div>`;
            }
        });
    }

    // --- NORMAL FRAMES LOGIC ---
    for(let i=1; i<=50; i++) { 
        const fileName = `./frames/frame_${i}.png`; 
        const frameName = `Frame ${i}`; 
        const isEquipped = (currentEquipped === fileName); 
        const btnText = isEquipped ? "REMOVE" : "USE"; 
        const btnClass = isEquipped ? "bg-gray-600" : "bg-red-600"; 
        const btnAction = isEquipped ? "removeFrame()" : `applyFrame('${fileName}')`; 
        grid.innerHTML += `<div class="frame-card" style="display:flex"><div class="frame-preview-box"><div class="visual-root"><img src="${currentUser.photoURL}" class="visual-img"><img src="${fileName}" class="visual-frame" onerror="this.parentElement.parentElement.parentElement.style.display='none'"></div></div><span class="text-xs font-bold text-white mb-2">${frameName}</span><button onclick="${btnAction}" class="w-full ${btnClass} text-white text-xs py-1 rounded transition">${btnText}</button></div>`; 
    } 
    document.getElementById('prophouse-modal').classList.add('open'); 
};

window.applyVIPName = async (vipClass) => {
    await update(ref(db, `users/${currentUser.uid}`), { nameColorClass: vipClass }); 
    if(currentRoomId) {
        const seatsSnap = await get(ref(db, `rooms/${currentRoomId}/seats`));
        if(seatsSnap.exists()) {
            const seats = seatsSnap.val();
            Object.keys(seats).forEach(async (k) => {
                if(seats[k].uid === currentUser.uid) { await update(ref(db, `rooms/${currentRoomId}/seats/${k}`), { nameColorClass: vipClass }); }
            });
        }
    }
    Swal.fire({toast:true, icon:'success', title:'VIP Name Equipped!', position:'top-end', showConfirmButton:false, timer:1500});
    openPropHouse();
};

window.removeVIPName = async () => {
    await update(ref(db, `users/${currentUser.uid}`), { nameColorClass: null });
    if(currentRoomId) {
        const seatsSnap = await get(ref(db, `rooms/${currentRoomId}/seats`));
        if(seatsSnap.exists()) {
            const seats = seatsSnap.val();
            Object.keys(seats).forEach(async (k) => {
                if(seats[k].uid === currentUser.uid) { await update(ref(db, `rooms/${currentRoomId}/seats/${k}`), { nameColorClass: null }); }
            });
        }
    }
    Swal.fire({toast:true, icon:'info', title:'VIP Name Removed', position:'top-end', showConfirmButton:false, timer:1500});
    openPropHouse();
};


        window.closePropHouse = () => document.getElementById('prophouse-modal').classList.remove('open');
        window.applyFrame = async (furl) => { await update(ref(db, `users/${currentUser.uid}`), { currentFrame: furl }); if(currentRoomId) { const seatsSnap = await get(ref(db, `rooms/${currentRoomId}/seats`)); if(seatsSnap.exists()) { const seats = seatsSnap.val(); Object.keys(seats).forEach(async (k) => { if(seats[k].uid === currentUser.uid) { await update(ref(db, `rooms/${currentRoomId}/seats/${k}`), { frame: furl }); } }); } } window.openPropHouse(); loadData(); Swal.fire({toast:true, icon:'success', title:'Frame Applied!', position:'top-end', showConfirmButton:false, timer:1500}); };
        window.removeFrame = async () => { await update(ref(db, `users/${currentUser.uid}`), { currentFrame: null }); if(currentRoomId) { const seatsSnap = await get(ref(db, `rooms/${currentRoomId}/seats`)); if(seatsSnap.exists()) { const seats = seatsSnap.val(); Object.keys(seats).forEach(async (k) => { if(seats[k].uid === currentUser.uid) { await update(ref(db, `rooms/${currentRoomId}/seats/${k}`), { frame: null }); } }); } } window.openPropHouse(); loadData(); Swal.fire({toast:true, icon:'info', title:'Frame Removed', position:'top-end', showConfirmButton:false, timer:1500}); };

        window.openEditModal = async () => { const s=await get(ref(db, `users/${currentUser.uid}`)); const d=s.val()||{}; document.getElementById('edit-name').value=d.username; document.getElementById('edit-bio').value=d.bio; let currentImg = d.photoURL; document.getElementById('edit-img-url').value=currentImg; currentEditingImg=currentImg; const container = document.getElementById('edit-preview-visual'); let html = `<div class="visual-root"><img src="${currentImg}" class="visual-img">`; if(d.currentFrame) html += `<img src="${d.currentFrame}" class="visual-frame">`; html += `</div>`; container.innerHTML = html; document.getElementById('edit-email').value = currentUser.email || 'No Email'; selectedGender = d.gender || null; updateGenderUI(d.lastGenderChange); document.getElementById('edit-modal').classList.add('open'); };
        window.closeEditModal=()=>document.getElementById('edit-modal').classList.remove('open');
        window.triggerImageUpload=()=>document.getElementById('image-upload').click();
        document.getElementById('image-upload').addEventListener('change',(e)=>{ const f=e.target.files[0]; if(!f)return; const r=new FileReader(); r.onload=(ev)=>{const i=new Image(); i.onload=()=>{const c=document.createElement('canvas');const ctx=c.getContext('2d');const s=300/Math.max(i.width,i.height);c.width=i.width*s;c.height=i.height*s;ctx.drawImage(i,0,0,c.width,c.height);const b64=c.toDataURL('image/jpeg',0.6);currentEditingImg=b64; document.getElementById('edit-img-url').value=b64; const container = document.getElementById('edit-preview-visual'); container.querySelector('.visual-img').src=b64; };i.src=ev.target.result;};r.readAsDataURL(f); });
        
        window.selectGender = (g) => { const now = Date.now(); if (document.querySelector('.gender-option').classList.contains('locked-gender')) return; selectedGender = g; updateGenderUI(null, true); }
        function updateGenderUI(lastChange, isSelectionMode=false) { const mBtn = document.getElementById('opt-male'); const fBtn = document.getElementById('opt-female'); const msg = document.getElementById('gender-lock-msg'); mBtn.classList.remove('selected', 'locked-gender'); fBtn.classList.remove('selected', 'locked-gender'); msg.classList.add('hidden'); const SEVEN_DAYS = 7 * 24 * 60 * 60 * 1000; const isLocked = lastChange && (Date.now() - lastChange < SEVEN_DAYS); if (selectedGender === 'male') mBtn.classList.add('selected'); if (selectedGender === 'female') fBtn.classList.add('selected'); if (isLocked && !isSelectionMode) { mBtn.classList.add('locked-gender'); fBtn.classList.add('locked-gender'); msg.classList.remove('hidden'); } }

        window.saveProfile=async()=>{ const n=document.getElementById('edit-name').value; const b=document.getElementById('edit-bio').value; const u=document.getElementById('edit-img-url').value.trim(); let finalImg = currentEditingImg; if(u && u.length > 5) finalImg = u; let updateData = {username:n, bio:b, photoURL:finalImg}; if (selectedGender) { const s = await get(ref(db, `users/${currentUser.uid}`)); const d = s.val() || {}; const SEVEN_DAYS = 7 * 24 * 60 * 60 * 1000; if (d.gender !== selectedGender) { if (d.lastGenderChange && (Date.now() - d.lastGenderChange < SEVEN_DAYS)) { return Swal.fire('Locked', 'You can only change gender once every 7 days.', 'error'); } updateData.gender = selectedGender; updateData.lastGenderChange = Date.now(); } } await updateProfile(currentUser,{displayName:n,photoURL:finalImg}); await update(ref(db,`users/${currentUser.uid}`), updateData); document.getElementById('profile-name').innerText=n; document.getElementById('profile-bio').innerText=b; const container = document.getElementById('profile-visual-container'); const hasFrame = document.querySelector('.visual-frame') !== null; let html = `<div class="visual-root"><img src="${finalImg}" class="visual-img">`; if(hasFrame) html += `<img src="${document.querySelector('.visual-frame').src}" class="visual-frame">`; html += `</div>`; container.innerHTML = html; closeEditModal(); };
        
        window.toggleExitMenu = () => { const bar = document.getElementById('room-exit-bar'); const blocker = document.getElementById('room-exit-blocker'); if(bar.style.display === 'flex') { bar.style.display = 'none'; blocker.style.display = 'none'; } else { bar.style.display = 'flex'; blocker.style.display = 'block'; } };
        window.closeExitMenu = () => { document.getElementById('room-exit-bar').style.display = 'none'; document.getElementById('room-exit-blocker').style.display = 'none'; }
        
        window.minimizeRoom = () => { closeExitMenu(); document.getElementById('floating-room-btn').style.display = 'flex'; document.getElementById('view-room').style.display = 'none'; document.getElementById('view-room').classList.remove('view-active'); document.getElementById('view-home').style.display = 'flex'; document.getElementById('view-home').classList.add('view-active'); document.getElementById('app-header').style.display = 'flex'; document.getElementById('bottom-nav').classList.remove('hidden'); document.getElementById('bottom-nav').classList.add('flex'); if(currentRoomId) { if(currentRoomData && currentRoomData.roomCover) { document.getElementById('float-btn-img').src = currentRoomData.roomCover; } else { document.getElementById('float-btn-img').src = `https://ui-avatars.com/api/?name=${currentRoomData?.roomName || 'Room'}`; } } }
        window.restoreRoom = () => { document.getElementById('floating-room-btn').style.display='none'; switchTab('view-room'); };
        
        window.leaveRoomFull = () => { closeExitMenu(); document.getElementById('rocket-details-modal').style.display='none'; document.getElementById('rocket-fly-layer').style.display='none'; currentRoomExp = 0; lastRocketLevel = 0; document.getElementById('floating-room-btn').style.display = 'none'; document.getElementById('view-room').style.display = 'none'; document.getElementById('view-room').classList.remove('view-active'); switchTab('view-home', document.querySelector('#btn-home')); localStorage.removeItem('lastRoomId'); if(currentRoomId) { const userRef = ref(db, `rooms/${currentRoomId}/activeUsers/${currentUser.uid}`); onDisconnect(userRef).cancel(); remove(userRef); if(currentRoomSeats) { Object.entries(currentRoomSeats).forEach(([key, val]) => { if(val && val.uid === currentUser.uid) { const sRef = ref(db, `rooms/${currentRoomId}/seats/${key}`); onDisconnect(sRef).cancel(); remove(sRef); } }); } if(currentRoomId === currentUser.uid) { update(ref(db, `rooms/${currentRoomId}`), {isLive:false}); } } currentRoomId = null; currentRoomData = null; document.getElementById('video-iframe').src = ""; document.getElementById('local-video-player').classList.add('hidden'); }

        window.switchTab = (vid, el) => { const views = document.querySelectorAll('.view-section'); views.forEach(v => { v.style.display = 'none'; v.classList.remove('view-active'); }); if(vid !== 'view-room' && currentRoomId) { document.getElementById('floating-room-btn').style.display='flex'; } else { document.getElementById('floating-room-btn').style.display='none'; } const targetView = document.getElementById(vid); if (targetView) { targetView.style.display = 'flex'; targetView.classList.add('view-active'); } if (vid === 'view-room') { document.getElementById('app-header').style.display = 'none'; document.getElementById('bottom-nav').classList.add('hidden'); } else { document.getElementById('app-header').style.display = 'flex'; document.getElementById('bottom-nav').classList.remove('hidden'); document.getElementById('header-home-content').classList.add('hidden'); document.getElementById('header-inbox-content').classList.add('hidden'); document.getElementById('header-profile-content').classList.add('hidden'); if (vid === 'view-home') { document.getElementById('header-home-content').classList.remove('hidden'); } else if (vid === 'view-inbox') { document.getElementById('header-inbox-content').classList.remove('hidden'); } else if (vid === 'view-profile') { document.getElementById('header-profile-content').classList.remove('hidden'); } } if(el){ document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active')); el.classList.add('active'); } };

        window.toggleSearch = () => document.getElementById('search-overlay').classList.toggle('open');
        window.searchUser = async () => { const i = document.getElementById('search-input').value.trim(); if(!i)return; const s = await get(ref(db, `idToUid/${i}`)); const r = document.getElementById('search-result'); if(!s.exists()){r.innerHTML="<span class='text-red-500'>ID Not Found</span>";return;} const u = s.val(); if(u===currentUser.uid){r.innerHTML="<span class='text-yellow-500'>This is you!</span>";return;} const ud = (await get(ref(db, `users/${u}`))).val(); const friendCheck = await get(ref(db, `users/${currentUser.uid}/friends/${u}`)); let btnHtml = "FOLLOW"; let btnClass = "bg-blue-600"; let btnDisabled = ""; if (friendCheck.exists()) { btnHtml = "FOLLOWING"; btnClass = "bg-gray-600 cursor-not-allowed"; btnDisabled = "disabled"; } r.innerHTML=`<div class='flex bg-gray-900 p-3 rounded-xl items-center justify-between border border-gray-700 shadow-lg'><div class='flex gap-3 items-center'><img src="${ud.photoURL}" class="w-10 h-10 rounded-full border border-gray-600"><span class="text-white font-bold text-sm">${ud.username}</span></div><button onclick="sendReq('${u}', this)" class='${btnClass} text-xs px-2 py-1 rounded font-bold text-white' ${btnDisabled}>${btnHtml}</button></div>`; };
        window.sendReq = async(u, btn)=>{ await set(ref(db,`users/${u}/inbox/requests/${currentUser.uid}`),{fromName:currentUser.displayName,fromUid:currentUser.uid,type:'req'}); btn.innerText = "FOLLOWING"; btn.classList.remove('bg-blue-600'); btn.classList.add('bg-gray-600'); btn.disabled = true; };
        window.acceptFriend = async(fid,fn)=>{ await update(ref(db),{[`users/${currentUser.uid}/friends/${fid}`]:fn, [`users/${fid}/friends/${currentUser.uid}`]:currentUser.displayName, [`users/${currentUser.uid}/inbox/requests/${fid}`]:null}); };
        window.delNotif=(p)=>remove(ref(db,`users/${currentUser.uid}/inbox/${p}`));
        
        window.openRoomChatInput = () => { document.getElementById('room-icons-container').style.display = 'none'; document.getElementById('room-chat-input-layer').style.display = 'flex'; document.getElementById('room-chat-input-field').focus(); };
        window.closeRoomChatInput = () => { document.getElementById('room-chat-input-layer').style.display = 'none'; document.getElementById('room-icons-container').style.display = 'flex'; };
        window.sendRoomMessage = async (e) => { 
    e.preventDefault(); 
    const input = document.getElementById('room-chat-input-field'); 
    const text = input.value.trim(); 
    if(text && currentRoomId){ 
        const uSnap = await get(ref(db, `users/${currentUser.uid}`));
        const uData = uSnap.val() || {};
        push(ref(db, `rooms/${currentRoomId}/messages`), {
            name: currentUser.displayName, 
            text: text, 
            type: 'chat',
            userExp: currentUserExp || 0, // لیول بیج کے لیے
            nameColorClass: uData.nameColorClass || null, 
            timestamp: Date.now()
        }); 
        input.value=''; 
        closeRoomChatInput(); 
        setTimeout(forceScrollBottom, 100); 
    } 
};

        window.toggleMic = () => { const btn = document.getElementById('btn-mic'); isMicMuted = !isMicMuted; if(isMicMuted) { btn.className = 'fa-solid fa-microphone-slash room-icon-btn text-gray-500'; } else { btn.className = 'fa-solid fa-microphone room-icon-btn text-white'; } if(currentRoomId) updateSeatMuteStatus(); };
        function updateSeatMuteStatus() { for (let i = 1; i <= 6; i++) { const sid = `seat${i}`; if (currentRoomSeats[sid] && currentRoomSeats[sid].uid === currentUser.uid) { const cont = document.getElementById(`cont-${sid}`); const existingBadge = cont.querySelector('.seat-mute-badge'); if(existingBadge) existingBadge.remove(); if(isMicMuted) { const badge = document.createElement('div'); badge.className = 'seat-mute-badge'; badge.innerHTML = '<i class="fa-solid fa-microphone-slash"></i>'; cont.appendChild(badge); } } } }
        window.toggleSpeaker = () => { const btn = document.getElementById('btn-speaker'); const iframe = document.getElementById('video-iframe'); isSpeakerMuted = !isSpeakerMuted; if(isSpeakerMuted) { btn.className = 'fa-solid fa-volume-xmark room-icon-btn text-gray-500'; if(iframe) iframe.contentWindow.postMessage(JSON.stringify({event: 'command', func: 'mute', args: ''}), '*'); } else { btn.className = 'fa-solid fa-volume-high room-icon-btn text-white'; if(iframe) iframe.contentWindow.postMessage(JSON.stringify({event: 'command', func: 'unmute', args: ''}), '*'); } };

        window.showRoomUserList = async () => { if(!currentRoomId) return; const usersSnap = await get(ref(db, `rooms/${currentRoomId}/activeUsers`)); const listContainer = document.getElementById('room-users-list'); listContainer.innerHTML = ''; if(usersSnap.exists()) { const users = usersSnap.val(); for (const [uid, name] of Object.entries(users)) { const uSnap = await get(ref(db, `users/${uid}`)); const uData = uSnap.val() || {}; const pic = uData.photoURL || `https://ui-avatars.com/api/?name=${name}`; listContainer.innerHTML += `<div class="flex items-center justify-between bg-gray-800 p-2 rounded"><div class="flex items-center gap-3"><img src="${pic}" class="w-8 h-8 rounded-full border border-gray-600"><span class="text-white text-sm font-medium">${name}</span></div></div>`; } } else { listContainer.innerHTML = '<p class="text-gray-400 text-center text-sm">No users found.</p>'; } document.getElementById('room-users-modal').classList.add('open'); };
        window.closeRoomUsers = () => document.getElementById('room-users-modal').classList.remove('open');
        window.clearScreen = () => { set(ref(db, `rooms/${currentRoomId}/videoId`), null); document.getElementById('local-video-player').classList.add('hidden'); document.getElementById('local-video-player').src = ""; document.getElementById('screen-placeholder').classList.remove('hidden'); document.getElementById('video-iframe').classList.add('hidden'); document.getElementById('video-iframe').src = ""; };
        
        window.openDirectChat = async (friendUid, friendName) => { 
            currentChatFriendId = friendUid; 
            
            // Fetch User Details for Header DP & Badge
            const uSnap = await get(ref(db, `users/${friendUid}`));
            let pic = 'https://placehold.co/100';
            let vBadgeHtml = '';
            let statusHtml = '<span class="w-2 h-2 rounded-full bg-gray-400"></span> Offline';
            
            if(uSnap.exists()) {
                let uData = uSnap.val();
                pic = uData.photoURL || pic;
                if(uData.isOfficial || uData.customId === window.SUPER_ADMIN_ID) {
                    vBadgeHtml = `<img src="./v_badge.png" class="chat-header-v-badge" onerror="this.style.display='none'">`;
                }
                if(uData.status === 'online') {
                    statusHtml = '<span class="w-2 h-2 rounded-full bg-green-500"></span> Online';
                }
            }

            document.getElementById('dm-header-content').innerHTML = `
                <div class="chat-header-dp-wrapper">
                    <img src="${pic}" class="chat-header-dp">
                    ${vBadgeHtml}
                </div>
                <div class="flex flex-col">
                    <span class="font-extrabold text-gray-900 text-sm">${friendName}</span>
                    <span class="text-[10px] text-gray-500 font-normal flex items-center gap-1">${statusHtml}</span>
                </div>
            `;
            
            const chatId = [currentUser.uid, friendUid].sort().join('_'); 
            const chatRef = ref(db, `direct_messages/${chatId}`); 
            document.getElementById('dm-messages').innerHTML = '<p class="text-center text-gray-500 text-xs">Loading...</p>'; 
            
            onValue(chatRef, (snap) => { 
                const div = document.getElementById('dm-messages'); 
                div.innerHTML = ''; 
                if(snap.exists()) { 
                    Object.values(snap.val()).forEach(msg => { 
                        const isMe = msg.uid === currentUser.uid; 
                        div.innerHTML += `<div class="p-2 text-sm max-w-[70%] mb-1 ${isMe ? 'chat-bubble-me' : 'chat-bubble-friend'} shadow-sm">${msg.text}</div>`; 
                    }); 
                    div.scrollTop = div.scrollHeight; 
                } else div.innerHTML = '<p class="text-center text-gray-500 text-xs mt-4">Start messaging...</p>'; 
            }); 
            
            document.querySelectorAll('.view-section').forEach(e => { e.classList.remove('view-active'); e.style.display = 'none'; }); 
            const chatView = document.getElementById('view-chat'); 
            chatView.classList.remove('hidden'); chatView.classList.add('flex', 'view-active'); chatView.style.display = 'flex'; 
            document.getElementById('app-header').style.display = 'none'; document.getElementById('bottom-nav').classList.add('hidden'); 
        };
        window.closeDirectChat = () => { document.getElementById('view-chat').classList.add('hidden'); document.getElementById('view-chat').classList.remove('flex'); document.getElementById('view-chat').style.display = 'none'; switchTab('view-inbox', document.getElementById('btn-inbox')); };
        document.getElementById('dm-form').addEventListener('submit', (e) => { e.preventDefault(); const input = document.getElementById('dm-input'); const text = input.value.trim(); if(text && currentChatFriendId) { const chatId = [currentUser.uid, currentChatFriendId].sort().join('_'); push(ref(db, `direct_messages/${chatId}`), { uid: currentUser.uid, text: text, timestamp: Date.now() }); input.value = ''; } });
        
        window.viewFriendProfile = async (uid) => { 
            if(!uid) return; 
            Swal.fire({title: 'Loading Profile...', background: '#111', color: '#fff', showConfirmButton: false});
            const snap = await get(ref(db, `users/${uid}`)); 
            if(!snap.exists()) { Swal.close(); return; }
            
            const d = snap.val(); 
            document.getElementById('fp-image').src = d.photoURL || 'https://placehold.co/100'; 
            document.getElementById('fp-name').innerText = d.username; 
            document.getElementById('fp-id').innerText = d.customId; 
            document.getElementById('fp-bio').innerText = d.bio || "No bio available."; 
            document.getElementById('fp-gender').src = d.gender === 'female' ? './female.png' : './male.png'; 
            
            // Level Update
            let exp = d.userExp || 0;
            document.getElementById('fp-level-text').innerText = `Lv.${getUserLevel(exp)}`;
            document.getElementById('fp-medal-img').src = getMedalImage(getUserLevel(exp));

            // Official V-Badge
            let vBadge = document.getElementById('fp-v-badge');
            if(d.isOfficial || d.customId === window.SUPER_ADMIN_ID) {
                vBadge.classList.remove('hidden');
            } else {
                vBadge.classList.add('hidden');
            }

            // Follow / Unfollow Logic
            const btn = document.getElementById('fp-action-btn'); 
            if(uid === currentUser.uid) {
                btn.style.display = 'none'; // اپنی پروفائل پر فالو بٹن چھپائیں
            } else {
                btn.style.display = 'block';
                const fCheck = await get(ref(db, `users/${currentUser.uid}/friends/${uid}`)); 
                if(fCheck.exists()) { 
                    btn.innerText = "UNFOLLOW"; 
                    btn.className = "w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-black tracking-widest py-3 rounded-xl shadow transition transform active:scale-95"; 
                    btn.onclick = () => unfollowUser(uid); 
                } else { 
                    btn.innerText = "FOLLOW"; 
                    btn.className = "w-full bg-blue-600 hover:bg-blue-700 text-white font-black tracking-widest py-3 rounded-xl shadow-lg transition transform active:scale-95"; 
                    btn.onclick = () => followUser(uid, btn); 
                } 
            }
            Swal.close();
            document.getElementById('friend-profile-modal').classList.add('open'); 
        }
        window.closeFriendProfile = () => document.getElementById('friend-profile-modal').classList.remove('open');
        window.followUser = async (uid, btn) => { await set(ref(db, `users/${uid}/inbox/requests/${currentUser.uid}`), {fromName: currentUser.displayName, fromUid: currentUser.uid, type: 'req'}); btn.innerText = "REQUESTED"; btn.classList.replace('bg-blue-600', 'bg-gray-600'); }
        window.unfollowUser = async (uid) => { await remove(ref(db, `users/${currentUser.uid}/friends/${uid}`)); await remove(ref(db, `users/${uid}/friends/${currentUser.uid}`)); closeFriendProfile(); Swal.fire('Unfollowed', 'User removed from friends', 'success'); }
        window.showInviteModal = async () => { if(!currentRoomId) return; const friendsSnap = await get(ref(db, `users/${currentUser.uid}/friends`)); if(!friendsSnap.exists()) return Swal.fire({toast:true, icon:'info', title:'No friends to invite', position:'top'}); let html = `<div class="flex flex-col gap-2 max-h-60 overflow-y-auto">`; Object.entries(friendsSnap.val()).forEach(([fid, fname]) => { html += `<div class="flex justify-between items-center bg-zinc-800 p-3 rounded"><span class="text-white text-sm font-bold">${fname}</span><button onclick="window.inviteUser('${fid}', this)" class="bg-blue-600 text-white text-xs px-3 py-1 rounded hover:bg-blue-500 font-bold">INVITE</button></div>`; }); html += `</div>`; Swal.fire({ title: 'Invite Friends', html: html, background: '#111', color: '#fff', showConfirmButton: false, showCloseButton: true }); };
        window.inviteUser = async (fid, btn) => { btn.innerHTML = "INVITED"; btn.classList.add('opacity-50', 'cursor-not-allowed'); btn.classList.remove('bg-blue-600', 'hover:bg-blue-500'); btn.classList.add('bg-gray-600'); btn.disabled = true; const notifRef = ref(db, `users/${fid}/inbox/invites/${Date.now()}`); await set(notifRef, { fromName: currentUser.displayName, fromUid: currentUser.uid, roomId: currentRoomId, type: 'invite' }); setTimeout(() => { if(btn) { btn.innerHTML = "INVITE"; btn.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-gray-600'); btn.classList.add('bg-blue-600', 'hover:bg-blue-500'); btn.disabled = false; } }, 120000); };
        window.copyToClipboard = (text) => { navigator.clipboard.writeText(text).then(() => { Swal.fire({ toast: true, icon: 'success', title: 'ID Copied!', position: 'top', showConfirmButton: false, timer: 1500 }); }).catch(err => console.error('Failed to copy', err)); };
        window.showFriendList = async (type) => { const friendsSnap = await get(ref(db, `users/${currentUser.uid}/friends`)); let title = type === 'following' ? 'Following' : 'Fans'; let html = `<div class="flex flex-col gap-2 max-h-60 overflow-y-auto text-left">`; if(!friendsSnap.exists()) { html += `<div class="text-gray-400 text-center text-sm py-4">No users found.</div>`; } else { Object.entries(friendsSnap.val()).forEach(([fid, fname]) => { html += `<div class="flex items-center gap-3 bg-gray-800 p-2 rounded mb-1"><div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center font-bold text-white text-xs">${fname[0]}</div><span class="text-white text-sm font-medium">${fname}</span></div>`; }); } html += `</div>`; Swal.fire({ title: title, html: html, background: '#111', color: '#fff', showConfirmButton: false, showCloseButton: true }); };

        document.querySelectorAll('.chair-bg-img').forEach(img => { img.onerror = () => { img.style.display = 'none'; }; });
        
        /* =======================================
           LUCKY FRUIT GAME LOGIC
           ======================================= */
        let gameTimer = 30;
        let isSpinning = false;
        let currentBet = 10000; // <-- گیم سٹارٹ ہوتے ہی ڈیفالٹ بیٹ 10K ہوگا
        let activeBets = {}; 
        
        const ODDS = { 0: 5, 1: 5, 2: 5, 3: 5, 4: 0, 5: 0, 6: 10, 7: 15, 8: 25, 9: 45 };
        const spinPath = [0, 1, 2, 3, 5, 9, 8, 7, 6, 4]; 

        const ROUND_DURATION = 40; 
        const BET_TIME = 30;
        let currentRoundId = 0;
        let resultHistory = []; 
        let detailedBetHistory = []; // نئی لائن: یوزر کی ہسٹری محفوظ کرنے کے لیے
        function getDeterministicWinner(roundId) {
            let hash = Math.sin(roundId) * 10000;
            let rand = hash - Math.floor(hash); // 0.0 to 0.9999
            
            // WEIGHTS (یہاں ہم نے گیم کو مشکل کر دیا ہے)
            // ٹوٹل 10,000 ٹکٹس ہیں۔
            // 45x (id 9): 27 ٹکٹس (دن میں ~6 بار)
            // Lucky Small/Big (id 4, 5): 10, 10 ٹکٹس (دن میں ~2 بار)
            const items =[
                {id: 9, weight: 27},    // 45x Berry
                {id: 4, weight: 10},    // Lucky Small
                {id: 5, weight: 10},    // Lucky Big
                {id: 8, weight: 200},   // 25x Mango
                {id: 7, weight: 600},   // 15x Melon
                {id: 6, weight: 1500},  // 10x Apple
                {id: 0, weight: 1913},  // 5x Orange
                {id: 1, weight: 1913},  // 5x Lemon
                {id: 2, weight: 1913},  // 5x Grapes
                {id: 3, weight: 1914}   // 5x Cherry
            ];

            let cumulative = 0;
            let randWeight = rand * 10000;
            let selectedId = 0;

            for (let i = 0; i < items.length; i++) {
                cumulative += items[i].weight;
                if (randWeight <= cumulative) {
                    selectedId = items[i].id;
                    break;
                }
            }

            // spinPath کے اندر موجود اس کی اصل پوزیشن واپس کریں
            return spinPath.indexOf(selectedId);
        }

        setInterval(() => {
            if (!currentUser) return;
            let now = Math.floor(Date.now() / 1000);
            let roundStart = now - (now % ROUND_DURATION);
            let newRoundId = roundStart;
            let elapsed = now - roundStart;

            if (currentRoundId !== newRoundId) {
                currentRoundId = newRoundId;
                resetGameLocally();
            }

            if (elapsed < BET_TIME) {
                isSpinning = false;
                let timeLeft = BET_TIME - elapsed;
                if(document.getElementById('game-timer')) {
                    document.getElementById('game-timer').innerText = timeLeft;
                }
            } else if (elapsed === BET_TIME) {
                if(!isSpinning) {
                    isSpinning = true;
                    if(document.getElementById('game-timer')) document.getElementById('game-timer').innerText = "0";
                    let winningPathIndex = getDeterministicWinner(currentRoundId);
                    spinWheelSequential(winningPathIndex);
                }
            }
        }, 1000);

        window.openGame = () => {
            document.getElementById('game-modal').style.display = 'flex';
            if(document.getElementById('game-balance')) { document.getElementById('game-balance').innerText = (currentCoins || 0).toLocaleString(); }
            
            // Load Today's Winnings on startup
            let today = new Date().toLocaleDateString();
            let savedData = JSON.parse(localStorage.getItem('luckyFruitWinnings') || '{"date":"","amount":0}');
            if (savedData.date !== today) { savedData.amount = 0; }
            let displayEl = document.getElementById('game-today-win');
            if(displayEl) displayEl.innerText = savedData.amount.toLocaleString();
        };

        window.closeGame = () => { 
            document.getElementById('game-modal').style.display = 'none'; 
        };

        window.selectChip = (amt, btn) => { 
            currentBet = amt; 
            document.querySelectorAll('.chip-btn').forEach(b => b.classList.remove('selected')); 
            btn.classList.add('selected'); 
        };

        window.placeBet = (index) => {
            if(isSpinning) return Swal.fire({toast:true, icon:'warning', title:'Spinning... wait for next round!', position:'top', showConfirmButton:false, timer:1500});
            if(index === 4 || index === 5) return; 
            if((currentCoins || 0) < currentBet) { return Swal.fire({toast:true, icon:'error', title:'Not enough coins!', position:'top', showConfirmButton:false, timer:1500}); }
            
            currentCoins -= currentBet;
            update(ref(db, `users/${currentUser.uid}`), { coins: currentCoins });
            
            if(!activeBets[index]) activeBets[index] = 0;
            activeBets[index] += currentBet;
            
            const betBadge = document.getElementById(`bet-${index}`);
            if(betBadge) betBadge.innerText = activeBets[index];
            if(document.getElementById('game-balance')) { document.getElementById('game-balance').innerText = currentCoins.toLocaleString(); }
        };

        function resetGameLocally() {
            activeBets = {};
            document.querySelectorAll('.bet-overlay').forEach(el => el.innerText = '');
            if(document.getElementById('game-win')) document.getElementById('game-win').innerText = "0";
            document.querySelectorAll('.fruit-item').forEach(el => el.classList.remove('active'));
            const overlay = document.getElementById('game-result-overlay');
            overlay.classList.replace('scale-100', 'scale-0');
            setTimeout(() => { overlay.style.display = 'none'; }, 300);
        }

        function spinWheelSequential(finalResultPathIndex) {
            const resultFruitId = spinPath[finalResultPathIndex]; 
            const totalSteps = (3 * spinPath.length) + finalResultPathIndex;
            let currentStep = 0;
            let currentPathIndex = 0;

            function step() {
                document.querySelectorAll('.fruit-item').forEach(el => el.classList.remove('active'));
                const activeFruitId = spinPath[currentPathIndex];
                const el = document.getElementById(`f-${activeFruitId}`);
                if(el) el.classList.add('active');

                currentStep++;
                currentPathIndex = (currentPathIndex + 1) % spinPath.length;

                if (currentStep <= totalSteps) {
                    let nextDelay = 50; 
                    if (totalSteps - currentStep < 10) nextDelay = 100;
                    if (totalSteps - currentStep < 5) nextDelay = 250;
                    if (totalSteps - currentStep < 2) nextDelay = 400;
                    setTimeout(step, nextDelay);
                } else {
                    setTimeout(() => finalizeResult(resultFruitId), 500);
                }
            }
            step();
        }

        
                    
                    // روزانہ کی وننگز کو اپڈیٹ اور ری سیٹ کرنے کا فنکشن
        function updateTodayWinnings(winAmt) {
            let today = new Date().toLocaleDateString();
            let savedData = JSON.parse(localStorage.getItem('luckyFruitWinnings') || '{"date":"","amount":0}');

            if (savedData.date !== today) {
                savedData = { date: today, amount: 0 }; // اگر نیا دن ہے تو ری سیٹ کر دیں
            }

            savedData.amount += winAmt;
            localStorage.setItem('luckyFruitWinnings', JSON.stringify(savedData));

            let displayEl = document.getElementById('game-today-win');
            if(displayEl) displayEl.innerText = savedData.amount.toLocaleString();
        }

        function finalizeResult(winningFruitId) {
            let winAmount = 0;
            let totalBetThisRound = 0;
            
            const fruitNames = {0: 'Orange', 1: 'Lemon', 2: 'Grapes', 3: 'Cherry', 4: 'Lucky', 5: 'Lucky', 6: 'Apple', 7: 'Watermelon', 8: 'Mango', 9: 'Strawberry'};
            const wonFruitName = fruitNames[winningFruitId];

            for(let key in activeBets) { totalBetThisRound += activeBets[key]; }

            if (winningFruitId === 4 || winningFruitId === 5) {
                // Lucky hit
                let totalBonusBets = (activeBets[4]||0) + (activeBets[5]||0);
                winAmount = totalBonusBets * 5; 
            } else {
                const multiplier = ODDS[winningFruitId] || 0;
                if(activeBets[winningFruitId]) {
                    winAmount = activeBets[winningFruitId] * multiplier;
                }
            }

            const winningImgElement = document.querySelector(`#f-${winningFruitId} img`);
            const winningImgSrc = winningImgElement ? winningImgElement.src : 'https://placehold.co/100?text=Win';

            if(winningImgSrc) {
                resultHistory.unshift(winningImgSrc);
                if(resultHistory.length > 8) resultHistory.pop();
                updateHistoryStripUI();
            }

            // ہسٹری کے لیے ڈیٹا محفوظ کرنا (History Log)
            if(totalBetThisRound > 0) {
                const timeNow = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const roundId = Math.floor(1000 + Math.random() * 9000);
                
                let selectedFruitsArray =[];
                for(let key in activeBets) {
                    let betImgElement = document.querySelector(`#f-${key} img`);
                    let betImgSrc = betImgElement ? betImgElement.src : '';
                    selectedFruitsArray.push({ img: betImgSrc, amount: activeBets[key] });
                }

                detailedBetHistory.unshift({
                    round: roundId,
                    time: timeNow,
                    selected: selectedFruitsArray,
                    winImg: winningImgSrc,
                    totalWin: winAmount,
                    status: winAmount > 0 ? 'WIN' : 'LOSE'
                });
                
                if(detailedBetHistory.length > 20) detailedBetHistory.pop(); 
            }

            // --- نیا پاپ اپ شو کرنے کا طریقہ ---
            const popup = document.getElementById('new-result-popup');
            const popupImg = document.getElementById('popup-fruit-img');
            const popupText = document.getElementById('popup-text');
            const popupCircle = document.getElementById('popup-circle');
            const popupAmount = document.getElementById('popup-amount');

            if(popup) {
                if(popupImg) popupImg.src = winningImgSrc;
                if(popupCircle) popupCircle.classList.remove('hidden');
                if(popupAmount) popupAmount.classList.add('hidden');

                if(winAmount > 0) {
                    // USER WON
                    currentCoins += winAmount;
                    update(ref(db, `users/${currentUser.uid}`), { coins: currentCoins });
                    
                    let savedData = JSON.parse(localStorage.getItem('luckyFruitWinnings') || '{"date":"","amount":0}');
                    savedData.amount += winAmount;
                    localStorage.setItem('luckyFruitWinnings', JSON.stringify(savedData));

                    let gameBalanceEl = document.getElementById('game-balance');
                    if(gameBalanceEl) gameBalanceEl.innerText = currentCoins.toLocaleString();
                    
                    let todayWinEl = document.getElementById('game-today-win');
                    if(todayWinEl) todayWinEl.innerText = savedData.amount.toLocaleString();
                    
                    if(popupText) popupText.innerText = "Congratulations! You won";
                    if(popupCircle) popupCircle.classList.add('hidden');
                    if(popupAmount) {
                        popupAmount.classList.remove('hidden');
                        popupAmount.innerText = winAmount.toLocaleString();
                    }
                    
                    // وننگ پٹی (Broadcast) فکس
                    if(typeof broadcastWin === "function"){
                        broadcastWin(currentUser.displayName, winAmount, currentUser.photoURL);
                    }
                } else if (totalBetThisRound > 0) {
                    // USER LOST
                    if(popupText) popupText.innerText = "You didn't win this round";
                    if(popupCircle) popupCircle.innerText = "!";
                } else {
                    // NO BET
                    if(popupText) popupText.innerText = "You didn't participate this round";
                    if(popupCircle) popupCircle.innerText = "!";
                }

                // پاپ اپ شو کریں
                popup.style.display = 'flex';
                
                // 4 سیکنڈ بعد پاپ اپ غائب کر دیں
                setTimeout(() => {
                    popup.style.display = 'none';
                }, 4000);
            }
        }

        // --- NEW: HISTORY MODAL FUNCTIONS ---
        window.openGameHistory = () => {
            const listContainer = document.getElementById('game-history-list');
            if(!listContainer) return;
            listContainer.innerHTML = '';
            
            if(detailedBetHistory.length === 0) {
                listContainer.innerHTML = '<div class="text-center text-gray-500 mt-10 text-xs">No betting history yet.</div>';
            } else {
                detailedBetHistory.forEach(item => {
                    const isWin = item.status === 'WIN';
                    
                    // بیٹ والے سارے فروٹس کا ڈیزائن بنائیں
                    let betsHtml = '';
                    item.selected.forEach(bet => {
                        betsHtml += `<div class="flex items-center bg-[#5c2e0b] rounded px-2 py-1 shadow-inner border border-[#8b4513]">
                            <img src="${bet.img}" class="w-5 h-5 object-contain mr-1">
                            <span class="text-yellow-200 text-xs font-bold">${bet.amount.toLocaleString()}</span>
                        </div>`;
                    });

                    // تصویر کے مطابق کارڈ کا مکمل ڈیزائن
                    listContainer.innerHTML += `
                        <div class="relative bg-gradient-to-b from-[#b35e22] to-[#8b4513] p-4 rounded-xl mb-3 shadow-lg overflow-hidden border border-[#d2691e]">
                            
                            <!-- Header (Round & Time) -->
                            <div class="flex justify-between items-center text-white font-bold mb-3 border-b border-white/20 pb-2">
                                <span class="text-sm">Round: ${item.round}</span>
                                <span class="text-[10px] font-normal opacity-80">${item.time}</span>
                            </div>

                            <!-- Selected Fruits -->
                            <div class="flex mb-3">
                                <span class="text-white/70 text-xs w-24 flex-shrink-0 pt-1">Selected fruits:</span>
                                <div class="flex flex-wrap gap-2 flex-1">
                                    ${betsHtml}
                                </div>
                            </div>

                            <!-- Winning Fruit -->
                            <div class="flex items-center mb-3">
                                <span class="text-white/70 text-xs w-24 flex-shrink-0">Winning fruits:</span>
                                <img src="${item.winImg}" class="w-8 h-8 drop-shadow-md">
                            </div>

                            <!-- Win Coins -->
                            <div class="flex items-center relative z-10">
                                <span class="text-white/70 text-xs w-24 flex-shrink-0">Win coins:</span>
                                <span class="text-yellow-300 font-bold text-sm">🪙 ${item.totalWin.toLocaleString()}</span>
                            </div>

                            <!-- Watermark Stamp (WIN/LOSE) -->
                            <div class="absolute -bottom-6 -right-6 w-28 h-28 border-[4px] ${isWin ? 'border-green-400 text-green-400' : 'border-gray-300 text-gray-300'} opacity-30 rounded-full flex items-center justify-center -rotate-12 pointer-events-none">
                                <div class="border-[2px] ${isWin ? 'border-green-400' : 'border-gray-300'} w-[90%] h-[90%] rounded-full flex items-center justify-center">
                                    <span class="font-black text-2xl uppercase tracking-widest">${item.status}</span>
                                </div>
                            </div>

                        </div>
                    `;
                });
            }
            document.getElementById('game-history-modal').classList.remove('hidden');
            document.getElementById('game-history-modal').classList.add('flex');
        };

        window.closeGameHistory = () => {
            const histModal = document.getElementById('game-history-modal');
            if(histModal) {
                histModal.classList.add('hidden');
                histModal.classList.remove('flex');
            }
        };

        // --- "new" ٹیگ کے ساتھ ہسٹری اپڈیٹ ---
        function updateHistoryStripUI() {
            const strip = document.getElementById('game-history-strip');
            if(!strip) return;
            strip.innerHTML = '<span class="history-label">Results:</span>';
            resultHistory.forEach((src, index) => {
                if(index === 0) {
                    strip.innerHTML += `<div class="history-item newest"><img src="${src}"><div class="new-tag">new</div></div>`;
                } else {
                    strip.innerHTML += `<div class="history-item"><img src="${src}"></div>`;
                }
            });
        }
        
        // راؤنڈ نمبر شو کرنے کے لیے
        setInterval(() => {
            if(document.getElementById('round-number-display') && currentRoundId > 0) {
                let roundNum = Math.floor((Date.now() % 86400000) / 40000); // Daily Round calculation
                document.getElementById('round-number-display').innerText = "Round " + roundNum + " of today";
            }
        }, 1000);

        /* ==========================================
           SUPER ADMIN & CUSTOMER SUPPORT FUNCTIONS
           ========================================== */
        
        let adminTargetUid = null;

        window.openAdminPanel = async () => {
            document.getElementById('admin-panel-modal').style.display = 'flex';
            document.getElementById('admin-target-user').classList.add('hidden');
            document.getElementById('admin-search-id').value = '';
            
            // صرف 10005 ID والا ہی کسی دوسرے کو آفیشل بنا سکتا ہے
            const myData = (await get(ref(db, `users/${currentUser.uid}`))).val();
            if(myData.customId === SUPER_ADMIN_ID) {
                document.getElementById('btn-make-official').style.display = 'block';
            } else {
                document.getElementById('btn-make-official').style.display = 'none';
            }
        };

        window.closeAdminPanel = () => {
            document.getElementById('admin-panel-modal').style.display = 'none';
        };

        window.searchUserForAdmin = async () => {
            const searchId = document.getElementById('admin-search-id').value.trim();
            if(!searchId) return;

            const uidSnap = await get(ref(db, `idToUid/${searchId}`));
            if(!uidSnap.exists()) {
                Swal.fire({toast:true, icon:'error', title:'User not found', position:'top', showConfirmButton:false, timer:1500});
                return;
            }

            adminTargetUid = uidSnap.val();
            const userSnap = await get(ref(db, `users/${adminTargetUid}`));
            const userData = userSnap.val();

            document.getElementById('admin-target-dp').src = userData.photoURL || 'https://placehold.co/100';
            document.getElementById('admin-target-name').innerText = userData.username;
            document.getElementById('admin-target-uid-display').querySelector('span').innerText = searchId;
            
            document.getElementById('admin-target-user').classList.remove('hidden');
        };

        window.adminAction = async (action) => {
            if(!adminTargetUid) return;
            
            if(action === 'warn') {
                Swal.fire({
                    title: 'Send Warning',
                    input: 'text',
                    inputPlaceholder: 'Type warning message...',
                    showCancelButton: true,
                    confirmButtonText: 'Send',
                    background: '#111', color: '#fff'
                }).then(async (result) => {
                    if (result.isConfirmed && result.value) {
                        const msg = `WARNING: ${result.value} \nIf you violate rules, your account will be banned.`;
                        await set(ref(db, `users/${adminTargetUid}/inbox/system/${Date.now()}`), {
                            fromName: 'YARAAN Official',
                            icon: './yaraan_dp.png',
                            message: msg,
                            type: 'sys'
                        });
                        Swal.fire('Sent', 'Warning sent successfully.', 'success');
                    }
                });
            } 
            else if(action === 'coins') {
                Swal.fire({
                    title: 'Send Official Coins',
                    input: 'number',
                    inputPlaceholder: 'Enter Amount',
                    showCancelButton: true,
                    confirmButtonText: 'Send',
                    background: '#111', color: '#fff'
                }).then(async (result) => {
                    if (result.isConfirmed && result.value) {
                        const amount = parseInt(result.value);
                        const uSnap = await get(ref(db, `users/${adminTargetUid}`));
                        const uData = uSnap.val();
                        await update(ref(db, `users/${adminTargetUid}`), {
                            coins: (Number(uData.coins) || 0) + amount
                        });
                        
                        // Send Notification
                        await set(ref(db, `users/${adminTargetUid}/inbox/system/${Date.now()}`), {
                            fromName: 'YARAAN System',
                            icon: './yaraan_dp.png',
                            message: `You received ${amount.toLocaleString()} Official Coins as a gift!`,
                            type: 'sys'
                        });
                        
                        Swal.fire('Sent', `Sent ${amount} coins.`, 'success');
                    }
                });
            }
            else if(action === 'ban') {
                await update(ref(db, `users/${adminTargetUid}`), { isBanned: true });
                Swal.fire('Banned', 'User has been banned.', 'success');
            }
            else if(action === 'unban') {
                await update(ref(db, `users/${adminTargetUid}`), { isBanned: null });
                Swal.fire('Unbanned', 'User has been restored.', 'success');
            }
            else if(action === 'official') {
                await update(ref(db, `users/${adminTargetUid}`), { 
                    isOfficial: true,
                    currentFrame: './frame_official.png'
                });
                
                await set(ref(db, `users/${adminTargetUid}/inbox/system/${Date.now()}`), {
                    fromName: 'YARAAN Management',
                    icon: './yaraan_dp.png',
                    message: `Congratulations! You have been verified as a YARAAN Official.`,
                    type: 'sys'
                });
                
                Swal.fire('Success', 'User is now an Official.', 'success');
            }
            else if(action === 'delete') {
                Swal.fire({
                    title: 'Delete User?',
                    text: 'This will permanently block their ID and wipe their data.',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    confirmButtonText: 'Yes, delete it!',
                    background: '#111', color: '#fff'
                }).then(async (result) => {
                    if (result.isConfirmed) {
                        // Soft delete & Permanent ban
                        await update(ref(db, `users/${adminTargetUid}`), { 
                            isBanned: true, 
                            deleted: true,
                            username: "Deleted User",
                            photoURL: "https://placehold.co/100?text=Deleted",
                            bio: ""
                        });
                        Swal.fire('Deleted!', 'User has been wiped and banned.', 'success');
                        closeAdminPanel();
                    }
                });
            }
        };

        // --- CUSTOMER SUPPORT LOGIC (ONLINE/OFFLINE ROUTING) ---
        window.openCustomerSupport = async () => {
            Swal.fire({title: 'Connecting to Support...', background: '#111', color: '#fff', showConfirmButton: false});
            
            // 1. تمام یوزرز کو چیک کریں تاکہ آن لائن آفیشل مل سکے
            const usersSnap = await get(ref(db, 'users'));
            let selectedOfficial = null;
            let fallbackAdmin = null;
            
            if(usersSnap.exists()) {
                const users = usersSnap.val();
                for (let uid in users) {
                    let u = users[uid];
                    // مین ایڈمن کا بیک اپ رکھیں اگر کوئی آن لائن نہ ہو
                    if(u.customId === window.SUPER_ADMIN_ID) fallbackAdmin = {uid: uid, name: u.username, status: u.status};
                    
                    // اگر کوئی آفیشل (یا ایڈمن) آن لائن ہے (اپنے آپ کو چھوڑ کر)
                    if((u.isOfficial || u.customId === window.SUPER_ADMIN_ID) && uid !== currentUser.uid) {
                        if(u.status === 'online') {
                            selectedOfficial = {uid: uid, name: u.username, status: 'online'};
                            break; // پہلا آن لائن آفیشل مل گیا، تلاش بند کریں
                        }
                    }
                }
            }
            
            // اگر آن لائن آفیشل ملا تو اس سے کنیکٹ کرو، ورنہ آف لائن مین ایڈمن سے
            let targetSupport = selectedOfficial || fallbackAdmin;
            
            if(targetSupport) {
                currentChatFriendId = targetSupport.uid; 
                
                // آن لائن / آف لائن کا ڈاٹ اور ٹیکسٹ
                let dotClass = targetSupport.status === 'online' ? 'bg-green-500' : 'bg-gray-500';
                let statusText = targetSupport.status === 'online' ? 'Online' : 'Offline';
                let displayName = targetSupport.status === 'online' ? targetSupport.name : 'YARAAN Support';
                
                document.getElementById('dm-header-content').innerHTML = `
                    <div class="chat-header-dp-wrapper">
                        <img src="./yaraan_dp.png" class="chat-header-dp" onerror="this.src='https://placehold.co/100'">
                        <img src="./v_badge.png" class="chat-header-v-badge" onerror="this.style.display='none'">
                    </div>
                    <div class="flex flex-col">
                        <span class="font-extrabold text-gray-900 text-sm">${displayName}</span>
                        <span class="text-[10px] text-gray-500 font-normal flex items-center gap-1"><span class="w-2 h-2 rounded-full ${dotClass}"></span> ${statusText}</span>
                    </div>
                `; 
                
                const chatId = [currentUser.uid, targetSupport.uid].sort().join('_'); 
                const chatRef = ref(db, `direct_messages/${chatId}`); 
                
                document.getElementById('dm-messages').innerHTML = '<p class="text-center text-gray-500 text-xs mt-10">Connecting to Secure Chat...</p>'; 
                
                onValue(chatRef, (snap) => { 
                    const div = document.getElementById('dm-messages'); 
                    div.innerHTML = ''; 
                    
                    // ویلکم میسج
                    div.innerHTML += `<div class="p-2 text-xs text-center text-gray-400 mb-2 mt-4 bg-gray-100 rounded mx-10">Welcome to YARAAN Customer Service. How can we help you today?</div>`;
                    
                    if(snap.exists()) { 
                        Object.values(snap.val()).forEach(msg => { 
                            const isMe = msg.uid === currentUser.uid; 
                            div.innerHTML += `<div class="p-2 text-sm max-w-[70%] mb-1 ${isMe ? 'chat-bubble-me' : 'chat-bubble-friend'} shadow-sm">${msg.text}</div>`; 
                        }); 
                        setTimeout(() => div.scrollTop = div.scrollHeight, 100); 
                    } 
                }); 
                
                document.querySelectorAll('.view-section').forEach(e => { e.classList.remove('view-active'); e.style.display = 'none'; }); 
                const chatView = document.getElementById('view-chat'); 
                chatView.classList.remove('hidden'); chatView.classList.add('flex', 'view-active'); chatView.style.display = 'flex'; 
                document.getElementById('app-header').style.display = 'none'; document.getElementById('bottom-nav').classList.add('hidden');
                
                Swal.close();
            } else {
                Swal.fire('Error', 'Support center is currently unavailable.', 'error');
            }
        };
    </script>
</body>
</html>
